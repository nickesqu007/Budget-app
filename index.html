<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>My Budget v1.4.7</title>
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#f7f8fb" />
<link rel="icon" href="./icon-192.png" sizes="192x192">
<link rel="apple-touch-icon" href="./icon-192.png">
<!--
v1.4.7 changes:
- Dashboard de-duplication, unified data store, calendar + goals fixes, and Home rollups corrected.

v1.4.6 changes:
- Fix confirm modal cleanup when dismissed via Escape to prevent stale actions firing.

v1.4.5 changes:
- Premium UI polish, consistent formatting, reliable form validation (no $0/blank), action feedback, and trust signals.
- Validation hardening for transaction amounts.
- Navigation stability fixes.
- Fixed parseAmount handling for invalid input (test + logic alignment).
- CSV: Debit/Credit mode now treats Debit as ABS(outflow). Works even if your bank exports negative debits. One-pass import + Undo.
- Home: pay-period navigation moved to the sticky top app bar.
- Transactions: Filters card is collapsible to free vertical space.
- Calendar: today is highlighted.
- Export JSON remains in Tools (not on Home).

Notes:
- Storage key remains the same (simple_budget_v11) to preserve data.
- Safe-to-Spend (conservative): Net actuals up to today minus scheduled bills until next payday.
-->
<style>
  :root{
    --bg:#f7f8fb; --card:#ffffff; --muted:#6b7280; --text:#111827;
    --accent:#22c55e; --accent-2:#0ea5e9; --danger:#ef4444; --ok:#16a34a;
    --border:#e5e7eb;
    --radius-card:16px; --radius-input:12px; --radius-pill:999px;
    --shadow-soft:0 8px 18px rgba(15,23,42,.08);
    --shadow-med:0 12px 30px rgba(15,23,42,.12);
    --space-8:8px; --space-12:12px; --space-16:16px; --space-24:24px; --space-32:32px;
    --transition-fast:150ms ease; --transition:200ms ease;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    background:var(--bg); color:var(--text);}
  .wrap{max-width:1200px; margin:0 auto; padding:18px 18px 40px}
  header.appbar{position:sticky; top:0; z-index:5; background:rgba(247,248,251,.95);
    backdrop-filter: blur(6px); padding:12px 16px; border-bottom:1px solid var(--border); display:flex; gap:12px; align-items:center; justify-content:space-between}
  .menu-wrap{position:relative}
  .menu-btn{width:auto; padding:8px 14px}
  .menu-dropdown{position:absolute; top:calc(100% + 8px); left:0; background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow-soft); min-width:180px; padding:8px; display:flex; flex-direction:column; gap:6px; z-index:10; transition:opacity var(--transition), transform var(--transition); transform:translateY(-4px)}
  .menu-dropdown:not(.hide){transform:translateY(0)}
  .menu-dropdown button{width:100%; text-align:left; padding:8px 10px; border-radius:10px; border:1px solid transparent; background:#fff; cursor:pointer}
  .menu-dropdown button.active{background:#111827; color:#fff}
  .header-right{display:flex; gap:8px; align-items:center}
  .appbar-inline{display:flex; gap:8px; align-items:center; margin:10px 0 4px}
  .nav-btn{background:#fff;border:1px solid var(--border);border-radius:999px;padding:6px 10px;cursor:pointer}
  .pill{padding:8px 12px; border:1px solid var(--border); border-radius:var(--radius-pill); background:#fff; box-shadow:var(--shadow-soft); display:inline-flex; gap:8px; align-items:center}
  .pill strong{font-variant-numeric: tabular-nums}
  .net{background: rgba(14,165,233,.08); border-color:#dbeafe}
  .safe{background: rgba(34,197,94,.08); border-color:#dcfce7}
  .safe.negative{background: rgba(239,68,68,.08); border-color:#fee2e2}
  .grid{display:grid; gap:16px; grid-template-columns:repeat(auto-fit, minmax(320px, 1fr))}
  .home-hero{display:flex; align-items:center; justify-content:space-between; gap:16px; padding:14px 0 6px; flex-wrap:wrap}
  .home-hero h1{margin:0; font-size:2rem}
  .home-hero p{margin:6px 0 0; color:var(--muted)}
  .hero-actions{display:flex; gap:10px; flex-wrap:wrap}
  .kpi-grid{display:grid; gap:16px; grid-template-columns:repeat(5, minmax(180px, 1fr)); margin:16px 0}
  .kpi-card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius-card); box-shadow:var(--shadow-soft); padding:16px; display:flex; gap:12px; align-items:center; transition:transform var(--transition)}
  .kpi-card:hover{transform:translateY(-2px)}
  .kpi-icon{width:38px; height:38px; border-radius:12px; background:#f1f5f9; display:flex; align-items:center; justify-content:center; font-size:1.1rem}
  .kpi-label{font-size:.85rem; color:var(--muted); text-transform:uppercase; letter-spacing:.04em}
  .kpi-value{font-size:1.4rem; font-weight:700; margin:6px 0}
  .kpi-sub{font-size:.8rem; color:var(--muted)}
  .home-grid{display:grid; gap:16px; grid-template-columns:2fr 1fr}
  .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius-card); box-shadow:var(--shadow-soft); margin-top:12px; transition:transform var(--transition), box-shadow var(--transition)}
  .card:hover{transform:translateY(-2px); box-shadow:var(--shadow-med)}
  .card h2{margin:0; font-size:1.05rem}
  .card-header{padding:14px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between}
  .card-body{padding:16px}
  .section-body{padding:14px}
  .card.collapsed .section-body{display:none}
  .chev{background:#fff;border:1px solid var(--border);border-radius:10px;padding:6px 8px;cursor:pointer}
  fieldset{border:1px dashed var(--border); padding:12px; border-radius:12px; margin:0 0 12px}
  legend{color:var(--muted); padding:0 8px; font-size:.9rem}
  label{display:block; font-size:.9rem; color:#475569; margin-bottom:6px}
  input, select, button, textarea{width:100%; padding:9px 10px; border-radius:var(--radius-input); border:1px solid var(--border); background:#fff; color:var(--text); font-size:.95rem; transition:border var(--transition-fast), box-shadow var(--transition-fast)}
  input:focus, select:focus, textarea:focus{outline:none; border-color:rgba(34,197,94,.6); box-shadow:0 0 0 3px rgba(34,197,94,.15)}
  input[type="number"]{font-variant-numeric: tabular-nums}
  textarea{min-height:64px; resize:vertical}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .row-3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}
  .actions{display:flex; gap:10px; margin-top:8px}
  .btn{cursor:pointer; border-radius:var(--radius-pill); border:1px solid var(--border); background:#fff; padding:8px 14px; transition:transform var(--transition-fast), box-shadow var(--transition-fast), opacity var(--transition-fast)}
  .btn:hover{transform:translateY(-1px); box-shadow:var(--shadow-soft)}
  .btn:disabled{opacity:.6; cursor:not-allowed; transform:none; box-shadow:none}
  .btn.active{background:#111827; color:#fff; border-color:#111827}
  .btn-primary{background:var(--accent); border-color:var(--accent); color:#fff}
  .btn-ghost{background:#fff; border:1px solid var(--border); color:#111827}
  .btn-danger{background:#fee2e2; border:1px solid #fecaca; color:#991b1b}
  .btn-sm{padding:6px 10px; font-size:.85rem}
  .error{color:#b91c1c; font-size:.85rem; margin-top:6px; display:none}
  .badges{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .badge{background:#f8fafc; border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-variant-numeric: tabular-nums; color:#334155}
  table{width:100%; border-collapse:collapse; border:1px solid var(--border); border-radius:10px; overflow:hidden}
  thead th{background:#f8fafc; color:#334155; text-align:left; font-weight:600; padding:8px; border-bottom:1px solid var(--border)}
  tbody td{padding:8px; border-bottom:1px solid var(--border); vertical-align:top}
  tbody tr:hover{background:#f9fafb}
  .right{text-align:right} .muted{color:var(--muted); font-size:.9rem}
  .mono{font-variant-numeric:tabular-nums}
  .toast{position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#111827; color:#fff; border:1px solid #0f172a; border-radius:12px; padding:10px 14px; box-shadow:var(--shadow); z-index:50; opacity:0; pointer-events:none; transition:opacity .2s ease, transform .2s ease}
  .toast.show{opacity:1; pointer-events:auto; transform:translateX(-50%) translateY(-6px)}
  .toast-area{position:fixed; bottom:20px; left:50%; transform:translateX(-50%); display:flex; flex-direction:column; gap:8px; z-index:60}
  .toast-item{min-width:240px; background:#111827; color:#fff; border:1px solid #0f172a; border-radius:12px; padding:10px 14px; box-shadow:var(--shadow-soft); opacity:0; transform:translateY(6px); transition:opacity var(--transition), transform var(--transition)}
  .toast-item.show{opacity:1; transform:translateY(0)}
  .toast-item.success{background:#0f3d1f; border-color:#14532d}
  .toast-item.error{background:#4c1d1d; border-color:#7f1d1d}
  .mini-help{font-size:.85rem; color:var(--muted); margin-top:8px}
  .filters{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .filters select, .filters input[type="date"]{width:auto}
  .upcoming-list{max-height:200px; overflow:auto; border:1px dashed var(--border); border-radius:10px; padding:8px; background:#f8fafc}
  .chart-area{height:180px; display:flex; align-items:center; justify-content:center; background:#f8fafc; border:1px solid var(--border); border-radius:12px}
  .chart-area svg{width:100%; height:100%}
  .bar-row{display:grid; grid-template-columns:120px 1fr 80px; gap:10px; align-items:center; margin-bottom:10px}
  .bar-track{height:8px; background:#e2e8f0; border-radius:999px; overflow:hidden}
  .bar-fill{height:100%; background:linear-gradient(90deg, var(--accent-2), var(--accent)); border-radius:999px}
  .transactions-list{display:flex; flex-direction:column; gap:12px}
  .txn-row{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:#fff}
  .txn-title{font-weight:600}
  .txn-meta{font-size:.85rem; color:var(--muted)}
  .txn-amount{font-weight:700}
  .txn-amount.negative{color:#dc2626}
  .insight-box{border:1px solid var(--border); border-radius:12px; padding:12px; background:#f8fafc; margin-top:12px}
  .insight-label{font-size:.8rem; text-transform:uppercase; letter-spacing:.06em; color:var(--muted); margin-bottom:6px}
  .glance-row{display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed var(--border)}
  .glance-row:last-child{border-bottom:none}
  .glance-metrics{display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; margin:10px 0}
  .glance-metrics div{background:#f8fafc; border:1px solid var(--border); border-radius:10px; padding:8px; text-align:center; font-size:.85rem}
  .page-header{display:flex; align-items:flex-start; justify-content:space-between; gap:16px; flex-wrap:wrap; padding:10px 0 4px}
  .page-header h1{margin:0; font-size:2rem}
  .page-header p{margin:6px 0 0; color:var(--muted)}
  .goals-summary{display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap}
  .progress-bar{height:10px; background:#e5e7eb; border-radius:999px; overflow:hidden}
  .progress-fill{height:100%; background:var(--accent); border-radius:999px}
  .goals-grid{display:grid; gap:16px; grid-template-columns:repeat(3, minmax(220px, 1fr))}
  .goal-card{position:relative; padding:16px; border-radius:16px; background:#fff; border:1px solid var(--border); box-shadow:var(--shadow)}
  .goal-card .goal-actions{position:absolute; top:12px; right:12px; display:flex; gap:8px}
  .icon-pill{width:40px; height:40px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:1.1rem}
  .goal-meta{display:flex; align-items:center; gap:12px}
  .goal-type{font-size:.75rem; text-transform:uppercase; letter-spacing:.08em; color:var(--muted)}
  .goal-amount{font-size:1.4rem; font-weight:700; margin:8px 0}
  .goal-remaining{display:flex; justify-content:space-between; font-size:.85rem; color:var(--muted)}
  .goal-helper{background:#f8fafc; border:1px dashed var(--border); border-radius:12px; padding:10px; font-size:.85rem; color:#475569; margin:10px 0}
  .pill-btn{padding:6px 12px; border-radius:999px; border:1px solid var(--border); background:#fff; cursor:pointer}
  .pill-btn.active{background:#111827; color:#fff; border-color:#111827}
  .insights-tabs{display:flex; gap:10px; flex-wrap:wrap; margin:12px 0 20px}
  .insights-tab{display:flex; gap:6px; align-items:center; padding:6px 12px; border-radius:999px; border:1px solid var(--border); background:#fff; cursor:pointer; font-size:.9rem}
  .insights-tab.active{background:#111827; color:#fff; border-color:#111827}
  .insights-grid{display:grid; gap:16px; grid-template-columns:1fr 1fr}
  .kpi-row{display:grid; gap:16px; grid-template-columns:repeat(4, minmax(200px, 1fr)); margin-top:16px}
  .kpi-mini{background:#fff; border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow:var(--shadow)}
  .kpi-mini .label{font-size:.8rem; color:var(--muted)}
  .kpi-mini .value{font-size:1.3rem; font-weight:700; margin-top:6px}
  .whatif-row{display:grid; gap:16px; grid-template-columns:1fr 1fr}
  .whatif-output{display:grid; gap:12px; margin-top:16px}
  .whatif-output .output-box{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:#f8fafc}
  .slider-label{display:flex; align-items:center; justify-content:space-between; font-size:.9rem; color:#475569}
  .modal-overlay{position:fixed; inset:0; background:rgba(15,23,42,.55); backdrop-filter:blur(2px); display:none; align-items:center; justify-content:center; padding:20px; z-index:50; opacity:0; transition:opacity var(--transition)}
  .modal-overlay.is-open{opacity:1}
  .modal{background:#fff; border-radius:var(--radius-card); padding:20px; width:min(520px, 100%); box-shadow:var(--shadow-med); position:relative; transform:translateY(6px); transition:transform var(--transition)}
  .modal-overlay.is-open .modal{transform:translateY(0)}
  .modal h3{margin:0 0 6px}
  .modal .close-btn{position:absolute; top:12px; right:12px; border:none; background:transparent; font-size:1.2rem; cursor:pointer}
  .modal .modal-actions{display:flex; gap:12px; justify-content:flex-end; margin-top:16px}
  .segmented{display:flex; background:#f3f4f6; padding:4px; border-radius:999px; gap:4px}
  .segmented button{border:none; background:transparent; padding:8px 16px; border-radius:999px; cursor:pointer}
  .segmented button.active{background:#fff; box-shadow:var(--shadow)}
  .toggle-row{display:flex; align-items:center; justify-content:space-between; gap:12px}
  .toggle-switch{position:relative; width:42px; height:24px}
  .toggle-switch input{opacity:0; width:0; height:0}
  .toggle-slider{position:absolute; inset:0; background:#e5e7eb; border-radius:999px; transition:.2s}
  .toggle-slider:before{content:""; position:absolute; width:18px; height:18px; left:3px; top:3px; background:#fff; border-radius:50%; transition:.2s; box-shadow:0 2px 6px rgba(15,23,42,.2)}
  .toggle-switch input:checked + .toggle-slider{background:var(--accent)}
  .toggle-switch input:checked + .toggle-slider:before{transform:translateX(18px)}
  .priority-group{display:flex; gap:8px}
  .priority-group button{flex:1}
  @media (max-width: 1100px){ .kpi-grid{grid-template-columns:repeat(2, minmax(180px, 1fr));} }
  @media (max-width: 900px){ .home-grid{grid-template-columns:1fr;} .insights-grid{grid-template-columns:1fr;} }
  @media (max-width: 700px){
    .row, .row-3{grid-template-columns:1fr}
    .home-hero{align-items:flex-start}
    .kpi-grid{grid-template-columns:1fr}
    .bar-row{grid-template-columns:1fr}
    .glance-metrics{grid-template-columns:1fr}
    .goals-grid{grid-template-columns:1fr}
    .kpi-row{grid-template-columns:1fr}
    .whatif-row{grid-template-columns:1fr}
  }
  .summary-row{display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:8px}
  /* Calendar */
  .cal-wrap{display:grid; grid-template-rows:auto 1fr; gap:12px}
  .cal-head{display:flex; gap:8px; align-items:center; justify-content:space-between}
  .cal-grid{display:grid; grid-template-columns:repeat(7, 1fr); gap:6px}
  .cal-cell{border:1px solid var(--border); border-radius:10px; padding:6px; min-height:80px; background:#fff}
  .cal-cell.out{opacity:.45}
  .cal-cell.today{border-color: var(--accent); box-shadow: inset 0 0 0 2px rgba(34,197,94,.35)}
  .cal-date{font-size:.9rem; color:#64748b}
  .cal-amt{margin-top:6px; font-variant-numeric: tabular-nums; color:#dc2626}
  .cal-weekdays{display:grid; grid-template-columns:repeat(7,1fr); gap:6px; color:#64748b; font-size:.9rem}
  .cal-total{margin-top:6px}
  .hide{display:none}
</style>
</head>
<body>
<div class="wrap">
  <header class="appbar">
    <div class="menu-wrap">
      <button class="btn btn-ghost menu-btn" id="menuBtn" type="button" aria-haspopup="true" aria-expanded="false">Menu â–¾</button>
      <div class="menu-dropdown hide" id="menuDropdown" role="menu">
        <button type="button" role="menuitem" data-tab="home" class="active">Home</button>
        <button type="button" role="menuitem" data-tab="transactions">Transactions</button>
        <button type="button" role="menuitem" data-tab="calendar">Calendar</button>
        <button type="button" role="menuitem" data-tab="insights">Insights</button>
        <button type="button" role="menuitem" data-tab="goals">Goals</button>
      </div>
    </div>
    <div class="header-right">
      <div class="muted" id="lastSavedLabel" style="font-size:.8rem">Last saved: â€”</div>
      <div class="muted" id="buildStamp" style="font-size:.75rem">Build â€”</div>
    </div>
    <div class="muted" id="lastSavedLabel" style="font-size:.8rem">Last saved: â€”</div>
  </header>

  <!-- HOME -->
  <section id="tab-home">
    <div class="home-hero">
      <div>
        <h1>Good morning</h1>
        <p>Hereâ€™s your financial snapshot</p>
      </div>
      <div class="hero-actions">
        <button class="btn btn-primary" id="addTransactionBtn" type="button">+ Add transaction</button>
        <button class="btn btn-ghost" id="setGoalBtn" type="button">Set a goal</button>
        <button class="btn btn-ghost" id="runScenarioBtn" type="button">Run scenario</button>
      </div>
    </div>
    <div class="appbar-inline" id="appbarNav" style="display:none">
      <button class="nav-btn" id="appPrev" title="Previous pay period">â—€</button>
      <div class="badge" id="appPeriodLabel">â€”</div>
      <button class="nav-btn" id="appNext" title="Next pay period">â–¶</button>
    </div>

    <div class="kpi-grid" id="kpiGrid"></div>

    <div class="home-grid">
      <div>
        <section class="card">
          <div class="card-header">
            <h2>Cash Flow Trend</h2>
            <span class="muted">Last 6 weeks</span>
          </div>
          <div class="card-body">
            <div class="chart-area" id="cashflowChart" aria-label="Cash flow trend chart"></div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <h2>Spending by Category</h2>
            <span class="muted">This month</span>
          </div>
          <div class="card-body">
            <div id="categoryChart"></div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <h2>Recent Transactions</h2>
            <button class="btn btn-ghost btn-sm" id="recentAddBtn" type="button">Add transaction</button>
          </div>
          <div class="card-body">
            <div class="transactions-list" id="recentTransactions"></div>
          </div>
        </section>
      </div>

      <div>
        <section class="card">
          <div class="card-header">
            <h2>This weekâ€™s insight</h2>
          </div>
          <div class="card-body">
            <p class="muted" id="insightSummary">Add transactions to unlock weekly insights.</p>
            <div class="insight-box">
              <div class="insight-label">What matters</div>
              <div id="insightWhatMatters">â€”</div>
            </div>
            <div class="insight-box">
              <div class="insight-label">Suggested action</div>
              <div id="insightAction">â€”</div>
            </div>
            <div class="mini-help" id="wkTrend">vs 4-wk avg: â€”</div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <h2>Month at a Glance</h2>
          </div>
          <div class="card-body">
            <div class="glance-row"><span>Income</span><strong id="monthIncome">$0.00</strong></div>
            <div class="glance-row"><span>Spending</span><strong id="monthSpending">$0.00</strong></div>
            <div class="glance-row"><span>Projected end</span><strong id="monthProjected">$0.00</strong></div>
            <div class="glance-row"><span>Projected to payday</span><strong id="projectedToPayday">$0.00</strong></div>
            <div class="muted" style="margin-top:10px">Next 7 days</div>
            <div class="glance-metrics">
              <div>Income<br><strong id="upIncome">$0.00</strong></div>
              <div>Bills<br><strong id="upBills">$0.00</strong></div>
              <div>Net<br><strong id="upNet">$0.00</strong></div>
            </div>
            <div class="upcoming-list" id="upcomingList" aria-live="polite"></div>
          </div>
        </section>
      </div>
    </div>

  </section>

  <!-- GOALS -->
  <section id="tab-goals" class="hide">
    <div class="page-header">
      <div>
        <h1>Your Goals</h1>
        <p>Track progress toward what matters most</p>
      </div>
      <button class="btn btn-primary" id="newGoalBtn" type="button">+ New Goal</button>
    </div>

    <div class="home-grid">
      <div>
        <section class="card">
          <div class="card-header">
            <h2>Cash Flow Trend</h2>
            <span class="muted">Last 6 weeks</span>
          </div>
          <div class="card-body">
            <div class="chart-area" id="cashflowChart" aria-label="Cash flow trend chart"></div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <h2>Spending by Category</h2>
            <span class="muted">This month</span>
          </div>
          <div class="card-body">
            <div id="categoryChart"></div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <h2>Recent Transactions</h2>
            <button class="btn btn-ghost btn-sm" id="recentAddBtn" type="button">Add transaction</button>
          </div>
          <div class="card-body">
            <div class="transactions-list" id="recentTransactions"></div>
          </div>
        </section>
      </div>

      <div>
        <section class="card">
          <div class="card-header">
            <h2>This weekâ€™s insight</h2>
          </div>
          <div class="card-body">
            <p class="muted" id="insightSummary">Add transactions to unlock weekly insights.</p>
            <div class="insight-box">
              <div class="insight-label">What matters</div>
              <div id="insightWhatMatters">â€”</div>
            </div>
            <div class="insight-box">
              <div class="insight-label">Suggested action</div>
              <div id="insightAction">â€”</div>
            </div>
            <div class="mini-help" id="wkTrend">vs 4-wk avg: â€”</div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <h2>Month at a Glance</h2>
          </div>
          <div class="card-body">
            <div class="glance-row"><span>Income</span><strong id="monthIncome">$0.00</strong></div>
            <div class="glance-row"><span>Spending</span><strong id="monthSpending">$0.00</strong></div>
            <div class="glance-row"><span>Projected end</span><strong id="monthProjected">$0.00</strong></div>
            <div class="glance-row"><span>Projected to payday</span><strong id="projectedToPayday">$0.00</strong></div>
            <div class="muted" style="margin-top:10px">Next 7 days</div>
            <div class="glance-metrics">
              <div>Income<br><strong id="upIncome">$0.00</strong></div>
              <div>Bills<br><strong id="upBills">$0.00</strong></div>
              <div>Net<br><strong id="upNet">$0.00</strong></div>
            </div>
            <div class="upcoming-list" id="upcomingList" aria-live="polite"></div>
          </div>
        </section>
      </div>
    </div>

    <div class="summary-row" id="payPeriodHeader" style="display:none">
      <button class="nav-btn" id="prevPeriod" aria-label="Previous pay period">â—€</button>
      <div class="badge" id="periodLabel">â€”</div>
      <button class="nav-btn" id="nextPeriod" aria-label="Next pay period">â–¶</button>
    </div>
  </section>

  <!-- GOALS -->
  <section id="tab-goals" class="hide">
    <div class="page-header">
      <div>
        <h1>Your Goals</h1>
        <p>Track progress toward what matters most</p>
      </div>
      <button class="btn btn-primary" id="newGoalBtn" type="button">+ New Goal</button>
    </div>

    <div class="home-grid">
      <div>
        <section class="card">
          <div class="card-header">
            <h2>Cash Flow Trend</h2>
            <span class="muted">Last 6 weeks</span>
          </div>
          <div class="card-body">
            <div class="chart-area" id="cashflowChart" aria-label="Cash flow trend chart"></div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <h2>Spending by Category</h2>
            <span class="muted">This month</span>
          </div>
          <div class="card-body">
            <div id="categoryChart"></div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <h2>Recent Transactions</h2>
            <button class="btn btn-ghost btn-sm" id="recentAddBtn" type="button">Add transaction</button>
          </div>
          <div class="card-body">
            <div class="transactions-list" id="recentTransactions"></div>
          </div>
        </section>
      </div>

      <div>
        <section class="card">
          <div class="card-header">
            <h2>This weekâ€™s insight</h2>
          </div>
          <div class="card-body">
            <p class="muted" id="insightSummary">Add transactions to unlock weekly insights.</p>
            <div class="insight-box">
              <div class="insight-label">What matters</div>
              <div id="insightWhatMatters">â€”</div>
            </div>
            <div class="insight-box">
              <div class="insight-label">Suggested action</div>
              <div id="insightAction">â€”</div>
            </div>
            <div class="mini-help" id="wkTrend">vs 4-wk avg: â€”</div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <h2>Month at a Glance</h2>
          </div>
          <div class="card-body">
            <div class="glance-row"><span>Income</span><strong id="monthIncome">$0.00</strong></div>
            <div class="glance-row"><span>Spending</span><strong id="monthSpending">$0.00</strong></div>
            <div class="glance-row"><span>Projected end</span><strong id="monthProjected">$0.00</strong></div>
            <div class="glance-row"><span>Projected to payday</span><strong id="projectedToPayday">$0.00</strong></div>
            <div class="muted" style="margin-top:10px">Next 7 days</div>
            <div class="glance-metrics">
              <div>Income<br><strong id="upIncome">$0.00</strong></div>
              <div>Bills<br><strong id="upBills">$0.00</strong></div>
              <div>Net<br><strong id="upNet">$0.00</strong></div>
            </div>
            <div class="upcoming-list" id="upcomingList" aria-live="polite"></div>
          </div>
        </section>
      </div>
    </div>

    <div class="summary-row" id="payPeriodHeader" style="display:none">
      <button class="nav-btn" id="prevPeriod" aria-label="Previous pay period">â—€</button>
      <div class="badge" id="periodLabel">â€”</div>
      <button class="nav-btn" id="nextPeriod" aria-label="Next pay period">â–¶</button>
    </div>
  </section>

  <!-- GOALS -->
  <section id="tab-goals" class="hide">
    <div class="page-header">
      <div>
        <h1>Your Goals</h1>
        <p>Track progress toward what matters most</p>
      </div>
      <button class="btn btn-primary" id="newGoalBtn" type="button">+ New Goal</button>
    </div>

    <section class="card">
      <div class="card-body">
        <div class="goals-summary">
          <div>
            <div class="muted">Total Progress</div>
            <div class="goal-amount"><span id="totalGoalsSaved">$0</span> <span class="muted">/ <span id="totalGoalsTarget">$0</span></span></div>
          </div>
          <div class="right">
            <div class="goal-amount" id="totalGoalsPercent">0%</div>
            <div class="muted">complete</div>
          </div>
        </div>
        <div class="progress-bar" style="margin-top:12px">
          <div class="progress-fill" id="totalGoalsBar" style="width:0%"></div>
        </div>
      </div>

    <div class="goals-grid" id="goalsGrid"></div>
  </section>

  <!-- INSIGHTS -->
  <section id="tab-insights" class="hide">
    <div class="page-header">
      <div>
        <h1>Insights &amp; Reports</h1>
        <p>Understand your money patterns and plan ahead</p>
      </div>
    </div>

    <div class="insights-tabs">
      <button class="insights-tab active" data-insights-tab="weekly">Weekly Insights</button>
      <button class="insights-tab" data-insights-tab="trends">Trends</button>
      <button class="insights-tab" data-insights-tab="whatif">What If</button>
    </div>

    <div id="insights-weekly">
      <section class="card">
        <div class="card-body">
          <div class="goal-meta">
            <div class="icon-pill" style="background:#e0f2fe">ðŸ’¡</div>
            <div>
              <div style="font-weight:600">Weekly insight</div>
              <div class="muted">Personalized based on your latest activity</div>
            </div>
          </div>
          <p id="weeklyInsightText" style="margin-top:12px">Add more transactions to unlock detailed insights.</p>
        </div>
      </section>
    </div>

    <div id="insights-trends" class="hide">
      <div class="insights-grid">
        <section class="card">
          <div class="card-header">
            <h2>Monthly Spending</h2>
          </div>
          <div class="card-body">
            <div class="chart-area" id="monthlySpendingChart" aria-label="Monthly spending chart"></div>
            <div class="mini-help" id="monthlyTrendNote">Same as last month</div>
          </div>
        </section>
        <section class="card">
          <div class="card-header">
            <h2>Where Your Money Goes</h2>
          </div>
          <div class="card-body">
            <div class="home-grid" style="grid-template-columns:140px 1fr; align-items:center">
              <div class="chart-area" style="height:140px" id="insightsCategoryChart" aria-label="Category breakdown"></div>
              <div id="insightsCategoryList"></div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <div id="insights-whatif" class="hide">
      <section class="card">
        <div class="card-body">
          <div class="goal-meta">
            <div class="icon-pill" style="background:#e0f2fe">ðŸ§®</div>
            <div>
              <div style="font-weight:600">What If Scenario</div>
              <div class="muted">See the impact of saving more each month</div>
            </div>
          </div>
          <div style="margin-top:16px">
            <div class="slider-label"><span>Save extra per month</span><strong id="whatIfExtraLabel">$0</strong></div>
            <input type="range" id="whatIfExtra" min="0" max="1000" step="50" value="0">
            <div class="row" style="margin-top:4px">
              <span class="muted">$0</span>
              <span class="right muted">$1,000</span>
            </div>
          </div>
          <div style="margin-top:16px">
            <div class="slider-label"><span>Time horizon</span><strong id="whatIfHorizonLabel">12 months</strong></div>
            <input type="range" id="whatIfHorizon" min="3" max="36" step="3" value="12">
            <div class="row" style="margin-top:4px">
              <span class="muted">3 months</span>
              <span class="right muted">3 years</span>
            </div>
          </div>
          <div class="whatif-output">
            <div class="output-box">
              <span>New monthly savings</span>
              <strong id="whatIfMonthly">$0</strong>
            </div>
            <div class="output-box">
              <span>Total in <span id="whatIfMonthsLabel">12</span> months</span>
              <strong id="whatIfTotal">$0</strong>
            </div>
          </div>
        </div>
      </section>
    </div>

    <div class="kpi-row">
      <div class="kpi-mini">
        <div class="label">Total Transactions</div>
        <div class="value" id="insightsTotalTx">0</div>
      </div>
      <div class="kpi-mini">
        <div class="label">Active Goals</div>
        <div class="value" id="insightsActiveGoals">0</div>
      </div>
      <div class="kpi-mini">
        <div class="label">This Month Income</div>
        <div class="value" id="insightsIncome">$0</div>
      </div>
      <div class="kpi-mini">
        <div class="label">This Month Spending</div>
        <div class="value" id="insightsSpending">$0</div>
      </div>
    </div>

  </section>

  <!-- TRANSACTIONS -->
  <section id="tab-transactions" class="hide">
    <div class="card collapsed" id="filtersCard">
      <h2>
        Filters
        <button type="button" class="chev" id="toggleFilters" aria-expanded="false">Expand</button>
      </h2>
      <div class="section-body">
        <div class="filters">
          <label class="muted" for="filterRange">View:</label>
          <select id="filterRange">
            <option value="all">All</option>
            <option value="thisWeek">This Week</option>
            <option value="lastWeek">Last Week</option>
            <option value="payPeriod">Current Pay Period</option>
            <option value="custom">Custom Range</option>
          </select>
          <input id="customStart" type="date" style="display:none">
          <span id="toSpan" class="muted" style="display:none">to</span>
          <input id="customEnd" type="date" style="display:none">
          <span class="muted">Â· Pay schedule:</span>
          <select id="payFreq">
            <option value="biweekly">Biweekly</option>
            <option value="weekly">Weekly</option>
            <option value="semimonthly">Semi-monthly (1st & 15th)</option>
            <option value="monthly">Monthly</option>
          </select>
          <label class="muted">Seed payday:</label>
          <input id="seedPayday" type="date">
        </div>
      </div>
    </div>

    <div class="grid">
      <section class="card" aria-labelledby="incomeHeading">
        <h2 id="incomeHeading">Income</h2>
        <div class="section-body">
          <form id="incomeForm" novalidate>
            <fieldset>
              <legend>Add / Edit Income</legend>
              <div class="row">
                <div>
                  <label for="incomeDate">Date</label>
                  <input id="incomeDate" name="date" type="date" required />
                  <div style="display:flex; gap:6px; align-items:center; margin-top:6px">
                    <input id="incomeScheduled" type="checkbox" />
                    <label for="incomeScheduled" class="muted">Scheduled (future)</label>
                  </div>
                </div>
                <div>
                  <label for="incomeSource">Source</label>
                  <input id="incomeSource" name="source" type="text" placeholder="Paycheck, Refundâ€¦" required />
                </div>
              </div>
              <div class="row">
                <div>
                  <label for="incomeAmount">Amount</label>
                  <input id="incomeAmount" name="amount" type="number" step="0.01" min="0" inputmode="decimal" placeholder="0.00" required />
                  <div id="incomeAmountErr" class="error">Enter a valid non-negative amount.</div>
                </div>
                <div>
                  <label>&nbsp;</label>
                  <div class="actions">
                    <button class="btn btn-primary" id="incomeSubmitBtn" type="submit">Add Income</button>
                    <button class="btn btn-ghost" id="incomeCancelEdit" type="button" style="display:none">Cancel Edit</button>
                  </div>
                </div>
              </div>
            </fieldset>
          </form>

          <div style="overflow:auto">
            <table aria-describedby="incomeHeading">
              <thead><tr><th>Date</th><th>Source</th><th>Scheduled</th><th class="right">Amount</th><th class="right">Actions</th></tr></thead>
              <tbody id="incomeTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="card" aria-labelledby="expenseHeading">
        <h2 id="expenseHeading">Expenses</h2>
        <div class="section-body">
          <form id="expenseForm" novalidate>
            <fieldset>
              <legend>Add / Edit Expense</legend>
              <div class="row-3">
                <div>
                  <label for="expenseDate">Date</label>
                  <input id="expenseDate" name="date" type="date" required />
                  <div style="display:flex; gap:6px; align-items:center; margin-top:6px">
                    <input id="expenseScheduled" type="checkbox" />
                    <label for="expenseScheduled" class="muted">Scheduled (future)</label>
                  </div>
                </div>
                <div>
                  <label for="expenseCategory">Category</label>
                  <select id="expenseCategory" name="category">
                    <option value="Housing">Housing</option>
                    <option value="Utilities">Utilities</option>
                    <option value="Food">Food</option>
                    <option value="Transport">Transport</option>
                    <option value="Debt">Debt</option>
                    <option value="Health">Health</option>
                    <option value="Entertainment">Entertainment</option>
                    <option value="Savings">Savings</option>
                    <option value="Other">Other</option>
                  </select>
                  <div class="mini-help">Or type a custom category:</div>
                  <input id="expenseCategoryCustom" type="text" placeholder="Custom category (optional)" />
                </div>
                <div>
                  <label for="expenseAmount">Amount</label>
                  <input id="expenseAmount" name="amount" type="number" step="0.01" min="0" inputmode="decimal" placeholder="0.00" required />
                  <div id="expenseAmountErr" class="error">Enter a valid non-negative amount.</div>
                </div>
              </div>
              <div class="row">
                <div>
                  <label for="expenseNotes">Notes (optional)</label>
                  <textarea id="expenseNotes" name="notes" placeholder="Short noteâ€¦"></textarea>
                </div>
                <div>
                  <label>&nbsp;</label>
                  <div class="actions">
                    <button class="btn btn-primary" id="expenseSubmitBtn" type="submit">Add Expense</button>
                    <button class="btn btn-ghost" id="expenseCancelEdit" type="button" style="display:none">Cancel Edit</button>
                  </div>
                </div>
              </div>
            </fieldset>
          </form>

          <div style="overflow:auto">
            <table aria-describedby="expenseHeading">
              <thead><tr><th>Date</th><th>Category</th><th>Scheduled</th><th class="right">Amount</th><th>Notes</th><th class="right">Actions</th></tr></thead>
              <tbody id="expenseTbody"></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </section>

  <!-- CALENDAR -->
  <section id="tab-calendar" class="hide">
    <div class="card">
      <h2>Calendar</h2>
      <div class="section-body cal-wrap">
        <div class="cal-head">
          <div style="display:flex; gap:8px; align-items:center">
            <button class="nav-btn" id="calPrev">â—€</button>
            <div class="badge" id="calLabel">â€”</div>
            <button class="nav-btn" id="calNext">â–¶</button>
          </div>
          <div class="badge cal-total">Month total: <strong id="calMonthTotal">$0.00</strong></div>
        </div>
        <div class="cal-weekdays"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div>
        <div class="cal-grid" id="calGrid"></div>
        <div class="card" style="margin:0">
          <h2 id="dayDetailTitle">Selected day</h2>
          <div class="section-body" id="dayDetailBody" class="muted">Click a day to see entries.</div>
        </div>
      </div>
    </div>
  </section>

</div>

<!-- Goals Modal -->
<div class="modal-overlay" id="goalModalOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="goalModalTitle">
    <button class="close-btn" type="button" id="goalModalClose">Ã—</button>
    <h3 id="goalModalTitle">Create New Goal</h3>
    <div class="row" style="margin-top:12px">
      <div style="grid-column:1 / -1">
        <label for="goalName">Goal Name</label>
        <input id="goalName" type="text" placeholder="e.g., Emergency Fund" required>
      </div>
    </div>
    <div style="margin-top:12px">
      <label for="goalType">Goal Type</label>
      <select id="goalType">
        <option value="General Savings">General Savings</option>
        <option value="Debt Payoff">Debt Payoff</option>
        <option value="Big Purchase">Big Purchase</option>
      </select>
    </div>
    <div class="row" style="margin-top:12px">
      <div>
        <label for="goalTarget">Target Amount</label>
        <input id="goalTarget" type="number" min="0" step="0.01" placeholder="10000">
        <div id="goalTargetErr" class="error"></div>
      </div>
      <div>
        <label for="goalCurrent">Current Progress</label>
        <input id="goalCurrent" type="number" min="0" step="0.01" placeholder="0">
        <div id="goalCurrentErr" class="error"></div>
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <div>
        <label for="goalDate">Target Date</label>
        <input id="goalDate" type="date">
      </div>
      <div>
        <label for="goalMonthly">Monthly Contribution</label>
        <input id="goalMonthly" type="number" min="0" step="0.01" placeholder="500">
        <div id="goalMonthlyErr" class="error"></div>
      </div>
    </div>
    <div style="margin-top:12px">
      <label>Priority</label>
      <div class="priority-group" id="goalPriorityGroup">
        <button class="pill-btn" type="button" data-priority="low">Low</button>
        <button class="pill-btn active" type="button" data-priority="medium">Medium</button>
        <button class="pill-btn" type="button" data-priority="high">High</button>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" id="goalModalCancel" type="button">Cancel</button>
      <button class="btn btn-primary" id="goalModalCreate" type="button">Create Goal</button>
    </div>
  </div>
</div>

<!-- Add Transaction Modal -->
<div class="modal-overlay" id="txnModalOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="txnModalTitle">
    <button class="close-btn" type="button" id="txnModalClose">Ã—</button>
    <h3 id="txnModalTitle">Add Transaction</h3>
    <div class="segmented" id="txnTypeSwitch" style="margin-top:12px">
      <button type="button" class="active" data-txn-type="expense">Expense</button>
      <button type="button" data-txn-type="income">Income</button>
    </div>
    <div style="margin-top:12px">
      <label for="txnAmount">Amount</label>
      <input id="txnAmount" type="number" min="0" step="0.01" placeholder="0.00">
      <div id="txnAmountErr" class="error">Enter a valid amount greater than 0.</div>
    </div>
    <div style="margin-top:12px">
      <label for="txnDesc">Description</label>
      <input id="txnDesc" type="text" placeholder="e.g., Coffee at Starbucks">
    </div>
    <div class="row" style="margin-top:12px">
      <div>
        <label for="txnDate">Date</label>
        <input id="txnDate" type="date">
      </div>
      <div id="txnCategoryWrap">
        <label for="txnCategory">Category</label>
        <select id="txnCategory">
          <option value="">Select category</option>
          <option value="Housing">Housing</option>
          <option value="Utilities">Utilities</option>
          <option value="Food">Food</option>
          <option value="Transport">Transport</option>
          <option value="Debt">Debt</option>
          <option value="Health">Health</option>
          <option value="Entertainment">Entertainment</option>
          <option value="Savings">Savings</option>
          <option value="Other">Other</option>
        </select>
      </div>
    </div>
    <div class="toggle-row" style="margin-top:12px">
      <span class="muted">This is a recurring transaction</span>
      <label class="toggle-switch">
        <input type="checkbox" id="txnRecurring">
        <span class="toggle-slider"></span>
      </label>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" id="txnModalCancel" type="button">Cancel</button>
      <button class="btn btn-primary" id="txnModalAdd" type="button">Add Transaction</button>
    </div>
  </div>
</div>

<div id="toastArea" class="toast-area" role="status" aria-live="polite"></div>

<!-- Confirm Modal -->
<div class="modal-overlay" id="confirmModalOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmModalTitle">
    <button class="close-btn" type="button" id="confirmModalClose">Ã—</button>
    <h3 id="confirmModalTitle">Confirm action</h3>
    <p id="confirmModalMessage" class="muted" style="margin-top:8px"></p>
    <div class="modal-actions">
      <button class="btn btn-ghost" id="confirmModalCancel" type="button">Cancel</button>
      <button class="btn btn-danger" id="confirmModalConfirm" type="button">Confirm</button>
    </div>
  </div>
</div>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(console.error); });
}

/* ====== Storage & Utilities ====== */
const LS_KEY='simple_budget_v11';
const GOALS_KEY='budget_goals_v1';
const BUILD_STAMP='v1.4.7-2025-02-14';
const fmt=new Intl.NumberFormat(undefined,{style:'currency',currency:getLikelyCurrency(),minimumFractionDigits:2,maximumFractionDigits:2});
const dateFmt=new Intl.DateTimeFormat(undefined,{year:'numeric', month:'short', day:'numeric'});
function getLikelyCurrency(){try{new Intl.NumberFormat(undefined,{style:'currency',currency:'USD'}).formatToParts(1);return(Intl.NumberFormat().resolvedOptions().currency||'USD')}catch{return'USD'}}
function formatCurrency(n){return fmt.format(Number(n||0))}
function formatDateDisplay(iso){if(!iso) return 'â€”'; const d=new Date(iso); return Number.isNaN(d.getTime()) ? iso : dateFmt.format(d)}
function parseAmount(v){if(typeof v==='number')return v;if(!v&&v!==0)return 0;v=String(v).replace(/[^0-9,.\-]/g,'').replace(',', '.');const num=Number(v);return Number.isFinite(num)?num:0}
function validateAmountInput(raw){
  const trimmed = String(raw ?? '').trim();
  if (!trimmed) return { ok:false, value:0, error:'Please enter a valid amount.' };
  let normalized = trimmed;
  if (normalized.includes(',') && normalized.includes('.')){
    normalized = normalized.replace(/,/g,'');
  } else if (normalized.includes(',') && !normalized.includes('.')){
    normalized = normalized.replace(',', '.');
  }
  if (!/[0-9]/.test(normalized)){
    return { ok:false, value:0, error:'Please enter a valid amount.' };
  }
  const value = parseAmount(normalized);
  if (!Number.isFinite(value)) return { ok:false, value:0, error:'Please enter a valid amount.' };
  if (value <= 0) return { ok:false, value:0, error:'Amount must be greater than 0.' };
  return { ok:true, value, error:'' };
}
function validateOptionalAmountInput(raw){
  const trimmed = String(raw ?? '').trim();
  if (!trimmed) return { ok:true, value:0, error:'' };
  let normalized = trimmed;
  if (normalized.includes(',') && normalized.includes('.')){
    normalized = normalized.replace(/,/g,'');
  } else if (normalized.includes(',') && !normalized.includes('.')){
    normalized = normalized.replace(',', '.');
  }
  if (!/[0-9]/.test(normalized)){
    return { ok:false, value:0, error:'Please enter a valid amount.' };
  }
  const value = parseAmount(normalized);
  if (!Number.isFinite(value)) return { ok:false, value:0, error:'Please enter a valid amount.' };
  if (value < 0) return { ok:false, value:0, error:'Amount must be 0 or greater.' };
  return { ok:true, value, error:'' };
}
function uid(){return Math.random().toString(36).slice(2)+Date.now().toString(36)}
function nowIso(){return new Date().toISOString()}
function todayStr(){return new Date().toISOString().slice(0,10)}
function toISO(d){return new Date(d).toISOString().slice(0,10)}
function startOfWeekSunday(d){const dt=new Date(d);const dow=dt.getDay();dt.setDate(dt.getDate()-dow);dt.setHours(0,0,0,0);return dt}
function endOfWeekSunday(d){const s=startOfWeekSunday(d);const e=new Date(s);e.setDate(s.getDate()+6);e.setHours(23,59,59,999);return e}
function addDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return x}
function clipDOM(year, month, day){const last=new Date(year, month+1, 0).getDate(); return new Date(year, month, Math.min(day,last));}
function isFuture(iso){const d=new Date(iso);const t=new Date();t.setHours(0,0,0,0);return d>t}
function inRange(iso,start,end){try{const d=new Date(iso);return d>=start && d<=end}catch{return false}}
function escapeHtml(s){return String(s).replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;'}[c]))}
function getThisMonthRange(now=new Date()){
  const start = new Date(now.getFullYear(), now.getMonth(), 1);
  const end = new Date(now.getFullYear(), now.getMonth()+1, 0);
  start.setHours(0,0,0,0);
  end.setHours(23,59,59,999);
  return {start, end};
}
function getTransactionsInRange(transactions, start, end, options={}){
  const includeFutureScheduled = options.includeFutureScheduled || false;
  return (transactions||[]).filter(x=>{
    if (!inRange(x.date, start, end)) return false;
    if (x.scheduled && isFuture(x.date) && !includeFutureScheduled) return false;
    return true;
  });
}
function normalizeCategory(category){
  const raw = (category || 'Other').trim();
  const key = raw.toLowerCase();
  const map = {
    grocery: 'Groceries', groceries: 'Groceries', food: 'Food', dining: 'Food', restaurant: 'Food', restaurants: 'Food',
    transport: 'Transport', transportation: 'Transport', utilities: 'Utilities', housing: 'Housing', debt: 'Debt',
    health: 'Health', entertainment: 'Entertainment', savings: 'Savings', other: 'Other'
  };
  return map[key] || raw;
}
function rollupSpendingByCategory(expenses, range){
  const totals = {};
  getTransactionsInRange(expenses, range.start, range.end).forEach(x=>{
    const key = normalizeCategory(x.category || 'Other');
    totals[key] = (totals[key] || 0) + Math.abs(Number(x.amount||0));
  });
  return totals;
}
const toastQueue = new Set();
function showToast(message, type='success'){
  if (toastQueue.has(message)) return;
  toastQueue.add(message);
  const area = byId('toastArea');
  const el = document.createElement('div');
  el.className = `toast-item ${type}`;
  el.textContent = message;
  area.appendChild(el);
  requestAnimationFrame(()=>el.classList.add('show'));
  setTimeout(()=>{
    el.classList.remove('show');
    setTimeout(()=>{ el.remove(); toastQueue.delete(message); }, 200);
  }, 3000);
}
function updateLastSaved(){
  if (!dom.lastSavedLabel) return;
  const now = new Date();
  const time = now.toLocaleTimeString(undefined, {hour:'2-digit', minute:'2-digit'});
  dom.lastSavedLabel.textContent = `Last saved: ${dateFmt.format(now)} ${time}`;
}
function getKpiMetrics(){
  return [
    {id:'safe', cardId:'safePill', cardClass:'safe', icon:'ðŸ’³', label:'Safe to spend', valueId:'safeToSpend', value:'$0.00', subHtml:'Next payday <span id="nextPaydayLabel">â€”</span>'},
    {id:'month', cardId:'kpiMonth', cardClass:'', icon:'ðŸ“†', label:'This month', valueId:'sumNet', value:'$0.00', subHtml:'Income <strong id="sumIncome">$0.00</strong> Â· Out <strong id="sumExpenses">$0.00</strong>'},
    {id:'burn', cardId:'kpiBurn', cardClass:'', icon:'ðŸ”¥', label:'Daily burn', valueId:'dailyBurn', value:'$0.00', subHtml:'Average spend per day'},
    {id:'savings', cardId:'kpiSavings', cardClass:'', icon:'ðŸ’¹', label:'Savings rate', valueId:'savingsRate', value:'0%', subHtml:'Net vs income'},
    {id:'debt', cardId:'kpiDebt', cardClass:'', icon:'ðŸ“‰', label:'Debt pressure', valueId:'debtPressure', value:'0%', subHtml:'Spending vs income'}
  ];
}
function renderKpiCards(){
  if (!dom.kpiGrid) return;
  const metrics = getKpiMetrics();
  dom.kpiGrid.innerHTML = metrics.map(metric=>`
    <div class="kpi-card ${metric.cardClass}" id="${metric.cardId}">
      <div class="kpi-icon">${metric.icon}</div>
      <div>
        <div class="kpi-label">${metric.label}</div>
        <div class="kpi-value" id="${metric.valueId}">${metric.value}</div>
        <div class="kpi-sub">${metric.subHtml}</div>
      </div>
    </div>
  `).join('');
  dom.safePill = byId('safePill');
  dom.safeToSpend = byId('safeToSpend');
  dom.sumIncome = byId('sumIncome');
  dom.sumExpenses = byId('sumExpenses');
  dom.sumNet = byId('sumNet');
  dom.dailyBurn = byId('dailyBurn');
  dom.savingsRate = byId('savingsRate');
  dom.debtPressure = byId('debtPressure');
  dom.nextPaydayLabel = byId('nextPaydayLabel');
}
const confirmState = { onConfirm: null };
function closeConfirmModal(reason){
  dom.confirmModalOverlay.style.display='none';
  dom.confirmModalOverlay.classList.remove('is-open');
  dom.confirmModalOverlay.setAttribute('aria-hidden','true');
  confirmState.onConfirm = null;
  dom.confirmModalConfirm.onclick = null;
  dom.confirmModalCancel.onclick = null;
  dom.confirmModalClose.onclick = null;
  dom.confirmModalOverlay.onclick = null;
}
function confirmAction(message, onConfirm){
  confirmState.onConfirm = onConfirm;
  dom.confirmModalMessage.textContent = message;
  dom.confirmModalOverlay.style.display='flex';
  dom.confirmModalOverlay.classList.add('is-open');
  dom.confirmModalOverlay.setAttribute('aria-hidden','false');
  dom.confirmModalConfirm.onclick = ()=>{
    const fn = confirmState.onConfirm;
    if (typeof fn === 'function') fn();
    closeConfirmModal('confirm');
  };
  dom.confirmModalCancel.onclick = ()=>closeConfirmModal('cancel');
  dom.confirmModalClose.onclick = ()=>closeConfirmModal('close');
  dom.confirmModalOverlay.onclick = (e)=>{ if (e.target === dom.confirmModalOverlay) closeConfirmModal('overlay'); };
}
function byId(id){return document.getElementById(id)}

/* ====== State ====== */
const store = {
  state: null,
  goals: [],
  get transactions(){ return [...(this.state?.incomes||[]), ...(this.state?.expenses||[])]; },
  get scheduledItems(){ return this.transactions.filter(x=>x.scheduled); },
  get settings(){ return this.state?.settings || {}; }
};
let state;
let goals;
function loadState(){try{const raw=localStorage.getItem(LS_KEY); if(!raw) return seed(); const obj=JSON.parse(raw); return obj;}catch{return seed()}}
function loadGoals(){try{const raw=localStorage.getItem(GOALS_KEY); if(!raw) return []; const obj=JSON.parse(raw); return Array.isArray(obj)?obj:[];}catch{return []}}
function initStore(){
  store.state = loadState();
  store.goals = loadGoals();
  state = store.state;
  goals = store.goals;
}
function saveState(){
  store.state = state;
  localStorage.setItem(LS_KEY, JSON.stringify(state));
  updateLastSaved();
}
function saveGoals(){
  store.goals = goals;
  localStorage.setItem(GOALS_KEY, JSON.stringify(goals));
  updateLastSaved();
}
function setState(next){ state = next; store.state = state; }
function setGoals(next){ goals = next; store.goals = goals; }

initStore();
if (!state.settings) state.settings = { payFreq:'biweekly', seedPayday: toISO(addDays(new Date(), 14)) };
if (!('payPeriodOffset' in state)) state.payPeriodOffset = 0;
if (!state.templates) state.templates = [];
if (!state.lastImportBatch) state.lastImportBatch = null;
if (!state.sync) state.sync = { provider:null, gistId:null, token:null, keySalt:null, passHint:null, lastRev:0 };
saveState();
function seed(){
  const s = { version:'1.4.7', settings:{payFreq:'biweekly', seedPayday: toISO(addDays(new Date(), 14))}, payPeriodOffset:0, incomes:[], expenses:[], templates:[], lastImportBatch:null, sync:{provider:null,gistId:null,token:null,keySalt:null,passHint:null,lastRev:0} };
  s.incomes.push({id:uid(), date:toISO(addDays(new Date(), -10)), source:'Paycheck', amount:3200, scheduled:false, updatedAt:nowIso()});
  s.incomes.push({id:uid(), date:toISO(addDays(new Date(), -3)), source:'Freelance', amount:450, scheduled:false, updatedAt:nowIso()});
  s.expenses.push({id:uid(), date:toISO(addDays(new Date(), -9)), category:'Housing', amount:1200, notes:'Rent', scheduled:false, updatedAt:nowIso()});
  s.expenses.push({id:uid(), date:toISO(addDays(new Date(), -2)), category:'Food', amount:245.37, notes:'Groceries', scheduled:false, updatedAt:nowIso()});
  return s;
}

/* ====== Pay period helpers (semimonthly fixed windows honored) ====== */
function nextPaydayFromSettings(offset=0){
  const freq = state.settings.payFreq||'biweekly';
  const seed = new Date(state.settings.seedPayday||todayStr());
  const today = new Date(); today.setHours(0,0,0,0); let next = new Date(seed);
  function advance(n){ next.setDate(next.getDate()+n); }
  if (freq==='weekly'){ while (next <= today) advance(7); advance(7*offset); }
  else if (freq==='biweekly'){ while (next <= today) advance(14); advance(14*offset); }
  else if (freq==='semimonthly'){
    const y=today.getFullYear(), m=today.getMonth();
    let c=[new Date(y,m,1), new Date(y,m,15), new Date(y,m+1,1), new Date(y,m+1,15)];
    c=c.map(x=>{x.setHours(0,0,0,0);return x;}).filter(x=>x>today);
    next = c[0] || new Date(y,m+1,1);
    for (let i=0;i<Math.abs(offset);i++){
      const cur=next;
      if (offset>0){ next=(cur.getDate()===1)? new Date(cur.getFullYear(), cur.getMonth(), 15)
                                             : new Date(cur.getFullYear(), cur.getMonth()+1, 1); }
      else { next=(cur.getDate()===15)? new Date(cur.getFullYear(), cur.getMonth(), 1)
                                      : new Date(cur.getFullYear(), cur.getMonth()-1, 15); }
    }
  } else if (freq==='monthly'){
    const day = new Date(state.settings.seedPayday||todayStr()).getDate();
    next = new Date(today.getFullYear(), today.getMonth(), day);
    if (next <= today) next = new Date(today.getFullYear(), today.getMonth()+1, day);
    next.setMonth(next.getMonth()+offset);
  }
  next.setHours(0,0,0,0);
  return next;
}
function currentPayPeriodRange(){
  const freq = state.settings.payFreq||'biweekly';
  const next = nextPaydayFromSettings(state.payPeriodOffset||0);
  let start, end;
  if (freq==='semimonthly'){
    if (next.getDate()===1){
      const pm=new Date(next.getFullYear(), next.getMonth()-1, 1);
      start=new Date(pm.getFullYear(), pm.getMonth(), 16);
      end=new Date(pm.getFullYear(), pm.getMonth()+1, 0);
    } else if (next.getDate()===15){
      start=new Date(next.getFullYear(), next.getMonth(), 1);
      end=new Date(next.getFullYear(), next.getMonth(), 15);
    } else { start=new Date(next.getFullYear(), next.getMonth(), 1); end=new Date(next.getFullYear(), next.getMonth(), 15); }
  } else {
    end = new Date(next); end.setHours(23,59,59,999);
    start = new Date(next);
    if (freq==='weekly') start.setDate(start.getDate()-7);
    else if (freq==='biweekly') start.setDate(start.getDate()-14);
    else if (freq==='monthly') start.setMonth(start.getMonth()-1);
  }
  start.setHours(0,0,0,0);
  return {start, end};
}
function formatRangeShort(start,end){
  const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  return `${months[start.getMonth()]} ${start.getDate()}â€“${months[end.getMonth()]} ${end.getDate()}`;
}

/* ====== Filters (Transactions tab) ====== */
function getActiveRange(){
  const now = new Date();
  const sel = dom.filterRange.value;
  if (sel==='thisWeek'){ return {start: startOfWeekSunday(now), end: endOfWeekSunday(now)}; }
  if (sel==='lastWeek'){ const s = addDays(startOfWeekSunday(now), -7); return {start: s, end: addDays(endOfWeekSunday(now), -7)}; }
  if (sel==='payPeriod'){ return currentPayPeriodRange(); }
  if (sel==='custom'){
    const s = dom.customStart.value ? new Date(dom.customStart.value) : new Date('1970-01-01');
    const e = dom.customEnd.value ? new Date(dom.customEnd.value) : new Date('2999-12-31');
    e.setHours(23,59,59,999);
    return {start:s, end:e};
  }
  return {start: new Date('1970-01-01'), end: new Date('2999-12-31')};
}

/* ====== Calculations ====== */
function totalsForRange(range){
  const inc = getTransactionsInRange(state.incomes, range.start, range.end)
    .reduce((s,x)=>s+Number(x.amount||0),0);
  const exp = getTransactionsInRange(state.expenses, range.start, range.end)
    .reduce((s,x)=>s+Number(x.amount||0),0);
  return {inc, exp, net: inc-exp};
}
function computeUpcoming7(){
  const start = new Date(); start.setHours(0,0,0,0);
  const end = addDays(start, 7);
  const upsInc = state.incomes.filter(x=>x.scheduled && inRange(x.date, start, end));
  const upsExp = state.expenses.filter(x=>x.scheduled && inRange(x.date, start, end));
  const sumInc = upsInc.reduce((s,x)=>s+Number(x.amount||0),0);
  const sumExp = upsExp.reduce((s,x)=>s+Number(x.amount||0),0);
  const items = [...upsExp.map(x=>({...x, type:'expense'})), ...upsInc.map(x=>({...x, type:'income'}))]
    .sort((a,b)=>String(a.date).localeCompare(String(b.date)));
  return {sumInc, sumExp, items};
}
function computeProjectedToPayday(){
  const next = nextPaydayFromSettings();
  const today = new Date(); today.setHours(0,0,0,0);
  const upsInc = state.incomes.filter(x=>x.scheduled && inRange(x.date, today, next));
  const upsExp = state.expenses.filter(x=>x.scheduled && inRange(x.date, today, next));
  const sumInc = upsInc.reduce((s,x)=>s+Number(x.amount||0),0);
  const sumExp = upsExp.reduce((s,x)=>s+Number(x.amount||0),0);
  const actualRange = {start: new Date('1970-01-01'), end: today};
  const {net} = totalsForRange(actualRange);
  return {next, projected: net + sumInc - sumExp};
}
function computeSafeToSpend(){
  const next = nextPaydayFromSettings();
  const today = new Date(); today.setHours(0,0,0,0);
  const scheduledBills = state.expenses.filter(x=>x.scheduled && inRange(x.date, today, next))
        .reduce((s,x)=>s+Number(x.amount||0),0);
  const actualRange = {start: new Date('1970-01-01'), end: today};
  const {net: actualNet} = totalsForRange(actualRange);
  return {next, safe: actualNet - scheduledBills};
}
function weeklySummaryCalc(){
  const now = new Date(); now.setHours(0,0,0,0);
  const s = startOfWeekSunday(now), e=endOfWeekSunday(now);
  const daysElapsed = Math.max(1, Math.min(7, Math.floor((now - s)/86400000)+1));
  const spent = state.expenses.filter(x=>!x.scheduled && inRange(x.date, s, e)).reduce((a,b)=>a+Number(b.amount||0),0);
  const avg = spent / daysElapsed; const proj = avg * 7;
  let sumPrior=0; for (let i=1;i<=4;i++){ const ps=addDays(s,-7*i), pe=addDays(e,-7*i);
    sumPrior += state.expenses.filter(x=>!x.scheduled && inRange(x.date, ps, pe)).reduce((a,b)=>a+Number(b.amount||0),0);
  }
  const avg4 = sumPrior/4; return {spent, avg, proj, avg4};
}

/* ====== Recurring templates ====== */
function generateTemplateInstances(){
  const windowDays = 60;
  const start = new Date(); start.setHours(0,0,0,0);
  const end = addDays(start, windowDays);
  state.expenses = state.expenses.filter(x=>{
    if (!x.scheduled || !x.templateId) return true;
    const tpl = state.templates.find(t=>t.id===x.templateId);
    if (!tpl || tpl.active===false) return false;
    const d=new Date(x.date);
    return d>=start && d<=end;
  });
  for (const t of state.templates){
    if (t.active===false) continue;
    const genStart = new Date(Math.max(start, new Date(t.startDate||start)));
    const addInst = (d)=>{
      const iso=toISO(d);
      const exists = state.expenses.some(x=>x.scheduled && x.templateId===t.id && x.date===iso);
      if (!exists) state.expenses.push({id:uid(), date:iso, category:t.label||'Bill', amount:Number(t.amount||0), notes:t.notes||'', scheduled:true, templateId:t.id, updatedAt:nowIso()});
    };
    if (t.freq==='weekly'){
      let d=new Date(genStart);
      while (d.getDay()!= (t.weekday??0)) d.setDate(d.getDate()+1);
      while (d<=end){ addInst(d); d=addDays(d,7); }
    } else if (t.freq==='biweekly'){
      const seed=new Date(t.seedDate||t.startDate||genStart);
      let d=new Date(seed);
      while (d<genStart) d=addDays(d,14);
      while (d<=end){ addInst(d); d=addDays(d,14); }
    } else if (t.freq==='semimonthly'){
      let cursor=new Date(genStart.getFullYear(), genStart.getMonth(), 1);
      while (cursor<=end){
        const d1=new Date(cursor.getFullYear(), cursor.getMonth(), 1);
        const d15=new Date(cursor.getFullYear(), cursor.getMonth(), 15);
        if (d1>=genStart && d1<=end) addInst(d1);
        if (d15>=genStart && d15<=end) addInst(d15);
        cursor.setMonth(cursor.getMonth()+1,1);
      }
    } else if (t.freq==='monthly'){
      let cursor=new Date(genStart.getFullYear(), genStart.getMonth(), 1);
      const day = Math.min(31, Math.max(1, Number(t.day||1)));
      while (cursor<=end){
        const when=clipDOM(cursor.getFullYear(), cursor.getMonth(), day);
        if (when>=genStart && when<=end) addInst(when);
        cursor.setMonth(cursor.getMonth()+1,1);
      }
    }
  }
}

/* ====== DOM refs ====== */
const dom = {
  menuBtn: byId('menuBtn'),
  menuDropdown: byId('menuDropdown'),
  menuItems: document.querySelectorAll('[data-tab]'),
  sections: {
    home: byId('tab-home'),
    goals: byId('tab-goals'),
    insights: byId('tab-insights'),
    transactions: byId('tab-transactions'),
    calendar: byId('tab-calendar')
  },
  // appbar period nav
  appbarNav: byId('appbarNav'), appPrev: byId('appPrev'), appNext: byId('appNext'), appPeriodLabel: byId('appPeriodLabel'),
  // home
  sumIncome: byId('sumIncome'), sumExpenses: byId('sumExpenses'), sumNet: byId('sumNet'),
  projectedToPayday: byId('projectedToPayday'), nextPaydayLabel: byId('nextPaydayLabel'),
  safePill: byId('safePill'), safeToSpend: byId('safeToSpend'),
  dailyBurn: byId('dailyBurn'), savingsRate: byId('savingsRate'), debtPressure: byId('debtPressure'),
  cashflowChart: byId('cashflowChart'), categoryChart: byId('categoryChart'),
  recentTransactions: byId('recentTransactions'),
  insightSummary: byId('insightSummary'), insightWhatMatters: byId('insightWhatMatters'), insightAction: byId('insightAction'),
  monthIncome: byId('monthIncome'), monthSpending: byId('monthSpending'), monthProjected: byId('monthProjected'),
  addTransactionBtn: byId('addTransactionBtn'), setGoalBtn: byId('setGoalBtn'), runScenarioBtn: byId('runScenarioBtn'),
  recentAddBtn: byId('recentAddBtn'),
  // upcoming
  upBills: byId('upBills'), upIncome: byId('upIncome'), upNet: byId('upNet'), upcomingList: byId('upcomingList'),
  // goals
  newGoalBtn: byId('newGoalBtn'), totalGoalsSaved: byId('totalGoalsSaved'), totalGoalsTarget: byId('totalGoalsTarget'),
  totalGoalsPercent: byId('totalGoalsPercent'), totalGoalsBar: byId('totalGoalsBar'), goalsGrid: byId('goalsGrid'),
  goalModalOverlay: byId('goalModalOverlay'), goalModalClose: byId('goalModalClose'), goalModalCancel: byId('goalModalCancel'),
  goalModalCreate: byId('goalModalCreate'), goalName: byId('goalName'), goalType: byId('goalType'), goalTarget: byId('goalTarget'),
  goalCurrent: byId('goalCurrent'), goalDate: byId('goalDate'), goalMonthly: byId('goalMonthly'), goalPriorityGroup: byId('goalPriorityGroup'),
  goalTargetErr: byId('goalTargetErr'), goalCurrentErr: byId('goalCurrentErr'), goalMonthlyErr: byId('goalMonthlyErr'),
  // insights
  insightsTabs: document.querySelectorAll('.insights-tab'),
  insightsWeekly: byId('insights-weekly'), insightsTrends: byId('insights-trends'), insightsWhatif: byId('insights-whatif'),
  monthlySpendingChart: byId('monthlySpendingChart'), monthlyTrendNote: byId('monthlyTrendNote'),
  insightsCategoryChart: byId('insightsCategoryChart'), insightsCategoryList: byId('insightsCategoryList'),
  weeklyInsightText: byId('weeklyInsightText'),
  insightsTotalTx: byId('insightsTotalTx'), insightsActiveGoals: byId('insightsActiveGoals'),
  insightsIncome: byId('insightsIncome'), insightsSpending: byId('insightsSpending'),
  whatIfExtra: byId('whatIfExtra'), whatIfExtraLabel: byId('whatIfExtraLabel'),
  whatIfHorizon: byId('whatIfHorizon'), whatIfHorizonLabel: byId('whatIfHorizonLabel'),
  whatIfMonthly: byId('whatIfMonthly'), whatIfTotal: byId('whatIfTotal'), whatIfMonthsLabel: byId('whatIfMonthsLabel'),
  // add transaction modal
  txnModalOverlay: byId('txnModalOverlay'), txnModalClose: byId('txnModalClose'), txnModalCancel: byId('txnModalCancel'),
  txnModalAdd: byId('txnModalAdd'), txnTypeSwitch: byId('txnTypeSwitch'), txnAmount: byId('txnAmount'), txnAmountErr: byId('txnAmountErr'),
  txnDesc: byId('txnDesc'), txnDate: byId('txnDate'), txnCategory: byId('txnCategory'), txnCategoryWrap: byId('txnCategoryWrap'),
  txnRecurring: byId('txnRecurring'),
  // weekly summary
  wkSpent: byId('wkSpent'), wkAvg: byId('wkAvg'), wkProj: byId('wkProj'), wkTrend: byId('wkTrend'),
  // filters
  filtersCard: byId('filtersCard'), toggleFilters: byId('toggleFilters'),
  filterRange: byId('filterRange'), customStart: byId('customStart'), customEnd: byId('customEnd'), toSpan: byId('toSpan'),
  payFreq: byId('payFreq'), seedPayday: byId('seedPayday'),
  // forms and tables
  incomeForm: byId('incomeForm'), incomeDate: byId('incomeDate'), incomeSource: byId('incomeSource'), incomeAmount: byId('incomeAmount'), incomeAmountErr: byId('incomeAmountErr'), incomeScheduled: byId('incomeScheduled'), incomeSubmitBtn: byId('incomeSubmitBtn'), incomeCancelEdit: byId('incomeCancelEdit'),
  expenseForm: byId('expenseForm'), expenseDate: byId('expenseDate'), expenseCategory: byId('expenseCategory'), expenseCategoryCustom: byId('expenseCategoryCustom'), expenseAmount: byId('expenseAmount'), expenseAmountErr: byId('expenseAmountErr'), expenseNotes: byId('expenseNotes'), expenseScheduled: byId('expenseScheduled'), expenseSubmitBtn: byId('expenseSubmitBtn'), expenseCancelEdit: byId('expenseCancelEdit'),
  incomeTbody: byId('incomeTbody'), expenseTbody: byId('expenseTbody'),
  // calendar
  calPrev: byId('calPrev'), calNext: byId('calNext'), calLabel: byId('calLabel'), calGrid: byId('calGrid'), calMonthTotal: byId('calMonthTotal'), dayDetailTitle: byId('dayDetailTitle'), dayDetailBody: byId('dayDetailBody'),
  kpiGrid: byId('kpiGrid'),
  lastSavedLabel: byId('lastSavedLabel'), buildStamp: byId('buildStamp'),
  confirmModalOverlay: byId('confirmModalOverlay'), confirmModalClose: byId('confirmModalClose'),
  confirmModalCancel: byId('confirmModalCancel'), confirmModalConfirm: byId('confirmModalConfirm'),
  confirmModalMessage: byId('confirmModalMessage')
};

/* ====== Render ====== */
function renderHome(){
  renderKpiCards();
  generateTemplateInstances();
  const now = new Date(); now.setHours(0,0,0,0);
  const monthRange = getThisMonthRange(now);
  const {inc, exp, net} = totalsForRange(monthRange);
  dom.sumIncome.textContent = formatCurrency(inc);
  dom.sumExpenses.textContent = formatCurrency(exp);
  dom.sumNet.textContent = formatCurrency(net);
  if (dom.monthIncome) dom.monthIncome.textContent = formatCurrency(inc);
  if (dom.monthSpending) dom.monthSpending.textContent = formatCurrency(exp);

  const daysElapsed = Math.max(1, now.getDate());
  const burn = exp / daysElapsed;
  if (dom.dailyBurn) dom.dailyBurn.textContent = formatCurrency(burn);
  if (dom.savingsRate) dom.savingsRate.textContent = inc > 0 ? `${Math.round(((inc - exp) / inc) * 100)}%` : 'â€”';
  if (dom.debtPressure) dom.debtPressure.textContent = inc > 0 ? `${Math.round((exp / inc) * 100)}%` : 'â€”';

  const proj = computeProjectedToPayday();
  dom.projectedToPayday.textContent = formatCurrency(proj.projected);
  dom.nextPaydayLabel.textContent = formatDateDisplay(toISO(proj.next));

  const scheduledInc = state.incomes.filter(x=>x.scheduled && inRange(x.date, now, monthRange.end)).reduce((s,x)=>s+Number(x.amount||0),0);
  const scheduledExp = state.expenses.filter(x=>x.scheduled && inRange(x.date, now, monthRange.end)).reduce((s,x)=>s+Number(x.amount||0),0);
  if (dom.monthProjected) dom.monthProjected.textContent = formatCurrency(net + scheduledInc - scheduledExp);

  const sts = computeSafeToSpend();
  dom.safeToSpend.textContent = formatCurrency(sts.safe);
  dom.safePill.classList.toggle('negative', sts.safe < 0);

  const upcoming = computeUpcoming7();
  dom.upBills.textContent = formatCurrency(upcoming.sumExp);
  dom.upIncome.textContent = formatCurrency(upcoming.sumInc);
  dom.upNet.textContent = formatCurrency(upcoming.sumInc - upcoming.sumExp);
  dom.upcomingList.innerHTML = upcoming.items.length ? upcoming.items.map(x=>`
    <div style="display:flex; justify-content:space-between; gap:8px; padding:6px 0; border-bottom:1px dashed var(--border)">
      <div>
        <div class="txn-title">${escapeHtml(x.type==='income' ? (x.source||'Income') : (x.category||'Expense'))}</div>
        <div class="txn-meta">${escapeHtml(formatDateDisplay(x.date||''))} Â· ${x.scheduled ? 'Scheduled' : 'Actual'}</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center">
        <span class="txn-amount ${x.type==='expense' ? 'negative' : ''}">${formatCurrency(x.amount||0)}</span>
        <button class="btn btn-ghost btn-sm" data-act="paid" data-type="${x.type}" data-id="${x.id}">Mark Paid</button>
        <button class="btn btn-ghost btn-sm" data-act="del" data-type="${x.type}" data-id="${x.id}">Delete</button>
      </div>
    </div>`).join('') : '<div class="muted">No scheduled items in the next 7 days.</div>';

  const weekly = weeklySummaryCalc();
  if (dom.wkSpent) dom.wkSpent.textContent = formatCurrency(weekly.spent);
  if (dom.wkAvg) dom.wkAvg.textContent = formatCurrency(weekly.avg);
  if (dom.wkProj) dom.wkProj.textContent = formatCurrency(weekly.proj);
  const trendPct = weekly.avg4 ? ((weekly.spent - weekly.avg4) / weekly.avg4) * 100 : 0;
  if (dom.wkTrend) dom.wkTrend.textContent = `vs 4-wk avg: ${weekly.avg4 ? `${trendPct > 0 ? '+' : ''}${Math.round(trendPct)}%` : 'â€”'}`;
  if (dom.insightSummary) dom.insightSummary.textContent = weekly.spent ? `You are ${Math.abs(Math.round(trendPct))}% ${trendPct >= 0 ? 'above' : 'below'} your 4-week average.` : 'Add transactions to unlock weekly insights.';
  if (dom.insightWhatMatters) dom.insightWhatMatters.textContent = `Spent ${formatCurrency(weekly.spent)} Â· Avg/day ${formatCurrency(weekly.avg)}.`;
  if (dom.insightAction) dom.insightAction.textContent = trendPct > 10 ? 'Trim discretionary spend this week to stay on target.' : 'Keep current pace to finish the week strong.';

  const recent = [
    ...state.incomes.filter(x=>!x.scheduled).map(x=>({type:'income', label:x.source||'Income', amount:Number(x.amount||0), date:x.date, updatedAt:x.updatedAt||x.date})),
    ...state.expenses.filter(x=>!x.scheduled).map(x=>({type:'expense', label:x.category||'Expense', amount:Number(x.amount||0), date:x.date, note:x.notes, updatedAt:x.updatedAt||x.date}))
  ].sort((a,b)=>String(b.date||'').localeCompare(String(a.date||'')) || String(b.updatedAt||'').localeCompare(String(a.updatedAt||''))).slice(0,6);
  if (dom.recentTransactions){
    dom.recentTransactions.innerHTML = recent.length ? recent.map(x=>`
      <div class="txn-row">
        <div>
          <div class="txn-title">${escapeHtml(x.label)} ${x.note ? `<span class="txn-meta">${escapeHtml(x.note)}</span>` : ''}</div>
          <div class="txn-meta">${escapeHtml(formatDateDisplay(x.date||''))}</div>
        </div>
        <div class="txn-amount ${x.type==='expense' ? 'negative' : ''}">${x.type==='expense' ? '-' : '+'}${formatCurrency(x.amount||0)}</div>
      </div>`).join('') : '<div class="muted">No recent transactions yet.</div>';
  }

  if (dom.categoryChart){
    const categoryTotals = rollupSpendingByCategory(state.expenses, monthRange);
    const totalSpend = Object.values(categoryTotals).reduce((s,x)=>s+x,0);
    const topCategories = Object.entries(categoryTotals).sort((a,b)=>b[1]-a[1]).slice(0,5);
    dom.categoryChart.innerHTML = topCategories.length ? topCategories.map(([name, amount])=>{
      const pct = totalSpend ? Math.round((amount/totalSpend)*100) : 0;
      return `
        <div class="bar-row">
          <div class="txn-meta">${escapeHtml(name)}</div>
          <div class="bar-track"><div class="bar-fill" style="width:${pct}%"></div></div>
          <div class="right mono">${formatCurrency(amount)}</div>
        </div>`;
    }).join('') : '<div class="muted">No spending data yet.</div>';
  }

  if (dom.cashflowChart){
    const weeks = [];
    const thisWeekStart = startOfWeekSunday(now);
    for (let i=5;i>=0;i--){
      const s = addDays(thisWeekStart, -7*i);
      const e = endOfWeekSunday(s);
      const {net:weekNet} = totalsForRange({start:s, end:e});
      weeks.push(weekNet);
    }
    const max = Math.max(...weeks, 0);
    const min = Math.min(...weeks, 0);
    const range = Math.max(1, max - min);
    const w = 300, h = 120, pad = 12;
    const points = weeks.map((v, idx)=>{
      const x = pad + (idx * (w - pad*2) / (weeks.length - 1));
      const y = pad + ((max - v) / range) * (h - pad*2);
      return `${x},${y}`;
    });
    const line = `M ${points.join(' L ')}`;
    dom.cashflowChart.innerHTML = `
      <svg viewBox="0 0 ${w} ${h}" role="img" aria-label="Cash flow trend">
        <defs>
          <linearGradient id="lineGrad" x1="0" x2="1" y1="0" y2="0">
            <stop offset="0%" stop-color="#0ea5e9"/>
            <stop offset="100%" stop-color="#22c55e"/>
          </linearGradient>
        </defs>
        <rect x="0" y="0" width="${w}" height="${h}" fill="#f8fafc" rx="12"></rect>
        <path d="${line}" fill="none" stroke="url(#lineGrad)" stroke-width="3" stroke-linecap="round"></path>
        ${points.map(p=>`<circle cx="${p.split(',')[0]}" cy="${p.split(',')[1]}" r="3" fill="#0f172a"></circle>`).join('')}
      </svg>`;
  }

  const {start,end}=currentPayPeriodRange();
  dom.appPeriodLabel.textContent = formatRangeShort(start,end);
}
function goalTypeMeta(type){
  if (type==='Debt Payoff') return {icon:'ðŸ’³', bg:'#fee2e2'};
  if (type==='Big Purchase') return {icon:'ðŸŽ¯', bg:'#fef3c7'};
  return {icon:'ðŸ·', bg:'#dcfce7'};
}
function addGoalRecord(list, goalData){
  const next = Array.isArray(list) ? [...list] : [];
  const idx = next.findIndex(g=>g.id===goalData.id);
  if (idx >= 0) next[idx] = goalData;
  else next.push(goalData);
  return next;
}
function renderGoals(){
  const totalSaved = goals.reduce((s,g)=>s+Number(g.currentAmount||0),0);
  const totalTarget = goals.reduce((s,g)=>s+Number(g.targetAmount||0),0);
  const pct = totalTarget ? Math.round((totalSaved / totalTarget) * 100) : 0;
  dom.totalGoalsSaved.textContent = formatCurrency(totalSaved);
  dom.totalGoalsTarget.textContent = formatCurrency(totalTarget);
  dom.totalGoalsPercent.textContent = `${pct}%`;
  dom.totalGoalsBar.style.width = `${Math.min(100, pct)}%`;
  dom.goalsGrid.innerHTML = goals.length ? goals.map(goal=>{
    const meta = goalTypeMeta(goal.type);
    const percent = goal.targetAmount ? Math.round((goal.currentAmount / goal.targetAmount) * 100) : 0;
    const remaining = Math.max(0, Number(goal.targetAmount||0) - Number(goal.currentAmount||0));
    let helper = '';
    if (goal.targetDate){
      const targetDate = new Date(goal.targetDate);
      const months = Math.max(1, (targetDate.getFullYear()-new Date().getFullYear())*12 + (targetDate.getMonth()-new Date().getMonth()) + 1);
      const perMonth = remaining / months;
      helper = `To reach your goal, save ${formatCurrency(perMonth)} / month for the next ${months} months.`;
    } else if (goal.monthlyContribution){
      helper = `Monthly contribution: ${formatCurrency(goal.monthlyContribution)}.`;
    }
    return `
      <div class="goal-card">
        <div class="goal-actions">
          <button class="btn btn-ghost btn-sm" data-goal-action="edit" data-id="${goal.id}">âœŽ</button>
          <button class="btn btn-ghost btn-sm" data-goal-action="delete" data-id="${goal.id}">ðŸ—‘</button>
        </div>
        <div class="goal-meta">
          <div class="icon-pill" style="background:${meta.bg}">${meta.icon}</div>
          <div>
            <div style="font-weight:600">${escapeHtml(goal.name)}</div>
            <div class="goal-type">${escapeHtml(goal.type)}</div>
          </div>
        </div>
        <div class="goal-amount">${formatCurrency(goal.currentAmount)} <span class="muted">of ${formatCurrency(goal.targetAmount)}</span></div>
        <div class="goal-remaining">
          <span>Remaining ${formatCurrency(remaining)}</span>
          <strong>${percent}% complete</strong>
        </div>
        <div class="progress-bar" style="margin:10px 0">
          <div class="progress-fill" style="width:${Math.min(100, percent)}%"></div>
        </div>
        <div class="goal-remaining">
          <span>Target date</span>
          <strong>${goal.targetDate ? escapeHtml(formatDateDisplay(goal.targetDate)) : 'â€”'}</strong>
        </div>
        ${helper ? `<div class="goal-helper">${helper}</div>` : ''}
        <button class="btn btn-primary" data-goal-action="log" data-id="${goal.id}" type="button">Log contribution</button>
      </div>
    `;
  }).join('') : '<div class="muted">No goals yet. Click â€œ+ New Goalâ€ to get started.</div>';
}
function renderInsights(){
  const now = new Date(); now.setHours(0,0,0,0);
  const monthRange = getThisMonthRange(now);
  const {inc, exp} = totalsForRange(monthRange);
  dom.insightsIncome.textContent = formatCurrency(inc);
  dom.insightsSpending.textContent = formatCurrency(exp);
  dom.insightsActiveGoals.textContent = String(goals.length);
  dom.insightsTotalTx.textContent = String(state.incomes.length + state.expenses.length);

  const weekly = weeklySummaryCalc();
  const trendPct = weekly.avg4 ? ((weekly.spent - weekly.avg4) / weekly.avg4) * 100 : 0;
  dom.weeklyInsightText.textContent = weekly.spent
    ? `You spent ${Math.abs(Math.round(trendPct))}% ${trendPct <= 0 ? 'less' : 'more'} this week than your 4-week average.`
    : 'Add transactions to unlock weekly insights.';

  if (dom.monthlySpendingChart){
    const months = [];
    for (let i=5;i>=0;i--){
      const start = new Date(now.getFullYear(), now.getMonth()-i, 1);
      const end = new Date(now.getFullYear(), now.getMonth()-i+1, 0); end.setHours(23,59,59,999);
      const {exp:total} = totalsForRange({start, end});
      months.push({label:new Intl.DateTimeFormat(undefined,{month:'short'}).format(start), value:total});
    }
    const max = Math.max(...months.map(m=>m.value), 1);
    const w = 320, h = 140, pad = 16;
    const points = months.map((m, idx)=>{
      const x = pad + (idx * (w - pad*2) / (months.length - 1));
      const y = pad + ((max - m.value) / max) * (h - pad*2);
      return `${x},${y}`;
    });
    const line = `M ${points.join(' L ')}`;
    dom.monthlySpendingChart.innerHTML = `
      <svg viewBox="0 0 ${w} ${h}" role="img" aria-label="Monthly spending">
        <rect x="0" y="0" width="${w}" height="${h}" fill="#f8fafc" rx="12"></rect>
        <path d="${line}" fill="none" stroke="#22c55e" stroke-width="3" stroke-linecap="round"></path>
        ${points.map(p=>`<circle cx="${p.split(',')[0]}" cy="${p.split(',')[1]}" r="3" fill="#0f172a"></circle>`).join('')}
        ${months.map((m, idx)=>`<text x="${pad + (idx * (w - pad*2) / (months.length - 1))}" y="${h - 6}" font-size="10" text-anchor="middle" fill="#64748b">${m.label}</text>`).join('')}
      </svg>`;
    const prev = months[months.length-2]?.value || 0;
    const curr = months[months.length-1]?.value || 0;
    const delta = prev ? Math.round(((curr - prev) / prev) * 100) : 0;
    dom.monthlyTrendNote.textContent = prev ? `${Math.abs(delta)}% ${delta <= 0 ? 'less' : 'more'} than last month` : 'Same as last month';
  }

  if (dom.insightsCategoryChart){
    const totals = rollupSpendingByCategory(state.expenses, monthRange);
    const entries = Object.entries(totals).sort((a,b)=>b[1]-a[1]);
    const total = entries.reduce((s,[,v])=>s+v,0) || 1;
    const colors = ['#22c55e','#6366f1','#f97316','#ec4899','#3b82f6','#facc15'];
    let offset = 0;
    const radius = 50;
    const circumference = 2 * Math.PI * radius;
    const rings = entries.slice(0,5).map(([name,val], idx)=>{
      const pct = val / total;
      const length = pct * circumference;
      const dash = `${length} ${circumference - length}`;
      const circle = `<circle r="${radius}" cx="70" cy="70" fill="transparent" stroke="${colors[idx%colors.length]}" stroke-width="14" stroke-dasharray="${dash}" stroke-dashoffset="${-offset}" />`;
      offset += length;
      return circle;
    }).join('');
    dom.insightsCategoryChart.innerHTML = `
      <svg viewBox="0 0 140 140" role="img" aria-label="Category donut">
        <circle r="${radius}" cx="70" cy="70" fill="transparent" stroke="#e5e7eb" stroke-width="14"></circle>
        ${rings}
      </svg>`;
    dom.insightsCategoryList.innerHTML = entries.slice(0,5).map(([name,val], idx)=>`
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px">
        <span style="display:flex; align-items:center; gap:8px"><span style="width:10px;height:10px;border-radius:50%;background:${colors[idx%colors.length]}"></span>${escapeHtml(name)}</span>
        <strong>${formatCurrency(val)}</strong>
      </div>
    `).join('') || '<div class="muted">No spending data yet.</div>';
  }

  updateWhatIf();
}
function updateWhatIf(){
  if (!dom.whatIfExtra) return;
  const extra = Number(dom.whatIfExtra.value || 0);
  const months = Number(dom.whatIfHorizon.value || 12);
  dom.whatIfExtraLabel.textContent = formatCurrency(extra);
  dom.whatIfHorizonLabel.textContent = `${months} months`;
  dom.whatIfMonthsLabel.textContent = String(months);
  const now = new Date(); now.setHours(0,0,0,0);
  const monthRange = getThisMonthRange(now);
  const {inc, exp} = totalsForRange(monthRange);
  const baseSavings = inc - exp;
  const newMonthly = baseSavings + extra;
  dom.whatIfMonthly.textContent = formatCurrency(newMonthly);
  dom.whatIfTotal.textContent = formatCurrency(newMonthly * months);
}
function renderTransactions(){
  const range = getActiveRange();
  const incRows = getTransactionsInRange(state.incomes, range.start, range.end)
    .sort((a,b)=>String(b.date).localeCompare(String(a.date))).map(row=>`
    <tr>
      <td>${escapeHtml(formatDateDisplay(row.date||''))}</td>
      <td>${escapeHtml(row.source||'')}</td>
      <td>${row.scheduled ? 'Yes' : 'No'}</td>
      <td class="right mono">${formatCurrency(row.amount||0)}</td>
      <td class="right"><div class="actions" style="justify-content:flex-end">
        <button class="btn btn-ghost" data-action="edit-income" data-id="${row.id}">Edit</button>
        <button class="btn btn-danger" data-action="del-income" data-id="${row.id}">Delete</button>
      </div></td>
    </tr>`).join('');
  dom.incomeTbody.innerHTML = incRows || '<tr><td colspan="5" class="muted">No items for this view.</td></tr>';

  const expRows = getTransactionsInRange(state.expenses, range.start, range.end)
    .sort((a,b)=>String(b.date).localeCompare(String(a.date))).map(row=>`
    <tr>
      <td>${escapeHtml(formatDateDisplay(row.date||''))}</td>
      <td>${escapeHtml(row.category||'')}</td>
      <td>${row.scheduled ? 'Yes' : 'No'}</td>
      <td class="right mono">${formatCurrency(row.amount||0)}</td>
      <td class="muted">${escapeHtml(row.notes||'')}</td>
      <td class="right"><div class="actions" style="justify-content:flex-end">
        <button class="btn btn-ghost" data-action="edit-expense" data-id="${row.id}">Edit</button>
        <button class="btn btn-danger" data-action="del-expense" data-id="${row.id}">Delete</button>
      </div></td>
    </tr>`).join('');
  dom.expenseTbody.innerHTML = expRows || '<tr><td colspan="6" class="muted">No items for this view.</td></tr>';
}
let editingIncomeId=null;
let editingExpenseId=null;
let calCursor = new Date();
function getCalendarEntries(iso){
  const items = [
    ...state.incomes.map(x=>({ ...x, type:'income', label:x.source||'Income' })),
    ...state.expenses.map(x=>({ ...x, type:'expense', label:x.category||'Expense', notes:x.notes||'' }))
  ].filter(x=>x.date===iso);
  return items.sort((a,b)=>Number(a.amount||0)-Number(b.amount||0));
}
function renderCalendar(){
  const y=calCursor.getFullYear(), m=calCursor.getMonth();
  dom.calLabel.textContent = new Intl.DateTimeFormat(undefined,{month:'long', year:'numeric'}).format(calCursor);

  const firstOfMonth = new Date(y,m,1); firstOfMonth.setHours(0,0,0,0);
  const start = startOfWeekSunday(firstOfMonth);
  const end = endOfWeekSunday(new Date(y, m+1, 0));
  dom.calGrid.innerHTML = '';
  const monthStart = new Date(y,m,1); monthStart.setHours(0,0,0,0);
  const monthEnd = new Date(y, m+1, 0); monthEnd.setHours(23,59,59,999);
  const monthIncome = getTransactionsInRange(state.incomes, monthStart, monthEnd, {includeFutureScheduled:true})
    .reduce((s,x)=>s+Number(x.amount||0),0);
  const monthExpenses = getTransactionsInRange(state.expenses, monthStart, monthEnd, {includeFutureScheduled:true})
    .reduce((s,x)=>s+Number(x.amount||0),0);
  dom.calMonthTotal.textContent = formatCurrency(monthIncome - monthExpenses);

  const todayIso = todayStr();
  for (let d=new Date(start); d<=end; d=addDays(d,1)){
    const iso=toISO(d);
    const cell=document.createElement('div');
    cell.className='cal-cell'+(d.getMonth()!==m?' out':'')+(iso===todayIso?' today':'');
    cell.setAttribute('data-date', iso);
    const dayItems = getCalendarEntries(iso);
    const dayNet = dayItems.reduce((sum, item)=>sum + (item.type==='income' ? Number(item.amount||0) : -Number(item.amount||0)), 0);
    cell.innerHTML = `
      <div class="cal-date">${d.getDate()}</div>
      <div class="cal-amt">${formatCurrency(dayNet)}</div>
    `;
    cell.addEventListener('click', ()=>showDayDetails(iso));
    dom.calGrid.appendChild(cell);
  }
  const isInMonth = new Date(todayIso).getMonth()===m && new Date(todayIso).getFullYear()===y;
  showDayDetails(isInMonth ? todayIso : toISO(new Date(y,m,1)));
}
function showDayDetails(iso){
  const items = getCalendarEntries(iso);
  byId('dayDetailTitle').textContent = `Entries on ${formatDateDisplay(iso)}`;
  byId('dayDetailBody').innerHTML = items.length ? items.map(x=>{
    const amount = x.type==='expense' ? -Math.abs(Number(x.amount||0)) : Number(x.amount||0);
    return `
      <div style="display:flex; justify-content:space-between; gap:8px; padding:6px 0; border-bottom:1px solid #1a2030">
        <span>${escapeHtml(x.label||'Entry')} <span class="muted">${x.scheduled ? 'Scheduled' : 'Actual'}</span> ${x.notes ? `<span class="muted">${escapeHtml(x.notes)}</span>` : ''}</span>
        <div style="display:flex; gap:8px; align-items:center">
          <span style="color:${x.type==='expense' ? '#ff9c9c' : '#86efac'}">${formatCurrency(amount)}</span>
          ${x.scheduled ? `<button class="btn btn-ghost" data-dd="paid" data-id="${x.id}" data-type="${x.type}">Mark Paid</button>
          <button class="btn btn-ghost" data-dd="del" data-id="${x.id}" data-type="${x.type}">Delete</button>` : ''}
        </div>
      </div>`;
  }).join('') : '<div class="muted">No entries on this day.</div>';
}

/* ====== Events ====== */
function setActiveTab(tab){
  dom.menuItems.forEach(b=>b.classList.toggle('active', b.getAttribute('data-tab')===tab));
  Object.keys(dom.sections).forEach(k=>{ dom.sections[k].classList.toggle('hide', k!==tab); });
  dom.appbarNav.style.display = (tab==='home') ? '' : 'none';
  if (tab==='home') renderHome();
  if (tab==='goals') renderGoals();
  if (tab==='insights') renderInsights();
  if (tab==='transactions') renderTransactions();
  if (tab==='calendar') renderCalendar();
  dom.menuDropdown.classList.add('hide');
  dom.menuBtn.setAttribute('aria-expanded','false');
}
function setInsightsTab(tab){
  dom.insightsTabs.forEach(btn=>btn.classList.toggle('active', btn.getAttribute('data-insights-tab')===tab));
  if (dom.insightsWeekly) dom.insightsWeekly.classList.toggle('hide', tab!=='weekly');
  if (dom.insightsTrends) dom.insightsTrends.classList.toggle('hide', tab!=='trends');
  if (dom.insightsWhatif) dom.insightsWhatif.classList.toggle('hide', tab!=='whatif');
}
function openGoalModal(goal){
  dom.goalModalOverlay.style.display='flex';
  dom.goalModalOverlay.classList.add('is-open');
  dom.goalModalOverlay.setAttribute('aria-hidden','false');
  dom.goalName.value = goal ? goal.name : '';
  dom.goalType.value = goal ? goal.type : 'General Savings';
  dom.goalTarget.value = goal ? goal.targetAmount : '';
  dom.goalCurrent.value = goal ? goal.currentAmount : '';
  dom.goalDate.value = goal ? goal.targetDate : '';
  dom.goalMonthly.value = goal ? goal.monthlyContribution : '';
  dom.goalTargetErr.style.display='none';
  dom.goalCurrentErr.style.display='none';
  dom.goalMonthlyErr.style.display='none';
  const priority = goal ? goal.priority : 'medium';
  dom.goalPriorityGroup.querySelectorAll('button').forEach(btn=>{
    btn.classList.toggle('active', btn.dataset.priority===priority);
  });
  dom.goalModalCreate.textContent = goal ? 'Save Goal' : 'Create Goal';
  dom.goalModalCreate.dataset.editingId = goal ? goal.id : '';
}
function closeGoalModal(){
  dom.goalModalOverlay.style.display='none';
  dom.goalModalOverlay.classList.remove('is-open');
  dom.goalModalOverlay.setAttribute('aria-hidden','true');
  dom.goalModalCreate.dataset.editingId = '';
}
function openTxnModal(){
  dom.txnModalOverlay.style.display='flex';
  dom.txnModalOverlay.classList.add('is-open');
  dom.txnModalOverlay.setAttribute('aria-hidden','false');
  dom.txnAmount.value='';
  dom.txnAmountErr.style.display='none';
  dom.txnDesc.value='';
  dom.txnDate.value=todayStr();
  dom.txnCategory.value='';
  dom.txnRecurring.checked=false;
  dom.txnTypeSwitch.querySelectorAll('button').forEach((btn, idx)=>{
    btn.classList.toggle('active', idx===0);
  });
  dom.txnCategoryWrap.style.display='';
}
function closeTxnModal(){
  dom.txnModalOverlay.style.display='none';
  dom.txnModalOverlay.classList.remove('is-open');
  dom.txnModalOverlay.setAttribute('aria-hidden','true');
}
function initTabs(){
  dom.menuBtn.addEventListener('click', ()=>{
    const isOpen = !dom.menuDropdown.classList.contains('hide');
    dom.menuDropdown.classList.toggle('hide', isOpen);
    dom.menuBtn.setAttribute('aria-expanded', String(!isOpen));
  });
  dom.menuItems.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const tab=btn.getAttribute('data-tab');
      setActiveTab(tab);
    });
  });
  document.addEventListener('click', (e)=>{
    if (!dom.menuDropdown.contains(e.target) && !dom.menuBtn.contains(e.target)){
      dom.menuDropdown.classList.add('hide');
      dom.menuBtn.setAttribute('aria-expanded','false');
    }
  });
}
function initHome(){
  if (dom.addTransactionBtn){
    dom.addTransactionBtn.addEventListener('click', openTxnModal);
  }
  if (dom.recentAddBtn){
    dom.recentAddBtn.addEventListener('click', openTxnModal);
  }
  if (dom.setGoalBtn){
    dom.setGoalBtn.addEventListener('click', ()=>{
      setActiveTab('goals');
      openGoalModal();
    });
  }
  if (dom.runScenarioBtn){
    dom.runScenarioBtn.addEventListener('click', ()=>{
      setActiveTab('insights');
      setInsightsTab('whatif');
    });
  }
  // appbar nav buttons
  dom.appPrev.addEventListener('click', ()=>{ state.payPeriodOffset=(state.payPeriodOffset||0)-1; saveState(); renderHome(); });
  dom.appNext.addEventListener('click', ()=>{ state.payPeriodOffset=(state.payPeriodOffset||0)+1; saveState(); renderHome(); });
  // upcoming list actions
  dom.upcomingList.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-act]'); if(!btn) return;
    const act = btn.getAttribute('data-act'), id=btn.getAttribute('data-id'), typ=btn.getAttribute('data-type');
    if (act==='del'){
      confirmAction('Delete this scheduled item?', ()=>{
        if (typ==='income') state.incomes = state.incomes.filter(x=>x.id!==id);
        else state.expenses = state.expenses.filter(x=>x.id!==id);
        saveState(); renderHome(); renderTransactions(); renderCalendar(); updateLastSaved();
        showToast('Scheduled item deleted', 'success');
      });
    } else if (act==='paid'){
      if (typ==='income'){
        const it = state.incomes.find(x=>x.id===id); if(!it) return;
        const posted = toISO(new Date());
        state.incomes = state.incomes.filter(x=>x.id!==id);
        state.incomes.push({id:uid(), date:posted, source:it.source||'Income', amount:Number(it.amount||0), scheduled:false, updatedAt:nowIso()});
        saveState(); renderHome(); renderTransactions(); renderCalendar(); updateLastSaved(); showToast('Marked paid', 'success');
      } else {
        const it = state.expenses.find(x=>x.id===id); if(!it) return;
        const next = prompt('Confirm amount for payment (you can adjust):', (Number(it.amount||0).toFixed(2)));
        if (next===null) return;
        const check = validateAmountInput(next);
        if (!check.ok){ showToast(check.error, 'error'); return; }
        const posted = toISO(new Date());
        state.expenses = state.expenses.filter(x=>x.id!==id);
        state.expenses.push({id:uid(), date:posted, category:it.category||'Expense', amount:check.value, notes:it.notes||'', scheduled:false, updatedAt:nowIso()});
        saveState(); renderHome(); renderTransactions(); renderCalendar(); updateLastSaved(); showToast('Marked paid', 'success');
      }
    }
  });
}
function initGoals(){
  dom.newGoalBtn.addEventListener('click', ()=>openGoalModal());
  dom.goalModalClose.addEventListener('click', closeGoalModal);
  dom.goalModalCancel.addEventListener('click', closeGoalModal);
  dom.goalModalOverlay.addEventListener('click', (e)=>{
    if (e.target === dom.goalModalOverlay) closeGoalModal();
  });
  dom.goalPriorityGroup.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-priority]'); if(!btn) return;
    dom.goalPriorityGroup.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
  });
  dom.goalModalCreate.addEventListener('click', ()=>{
    dom.goalModalCreate.disabled = true;
    const name = dom.goalName.value.trim();
    const targetCheck = validateAmountInput(dom.goalTarget.value);
    const currentCheck = validateOptionalAmountInput(dom.goalCurrent.value);
    const monthlyCheck = validateOptionalAmountInput(dom.goalMonthly.value);
    dom.goalTargetErr.style.display = 'none';
    dom.goalCurrentErr.style.display = 'none';
    dom.goalMonthlyErr.style.display = 'none';
    if (!name){
      showToast('Please enter a goal name.', 'error');
      dom.goalModalCreate.disabled = false;
      return;
    }
    if (!targetCheck.ok){
      dom.goalTargetErr.textContent = targetCheck.error;
      dom.goalTargetErr.style.display = 'block';
      showToast(targetCheck.error, 'error');
      dom.goalModalCreate.disabled = false;
      return;
    }
    if (!currentCheck.ok){
      dom.goalCurrentErr.textContent = currentCheck.error;
      dom.goalCurrentErr.style.display = 'block';
      showToast(currentCheck.error, 'error');
      dom.goalModalCreate.disabled = false;
      return;
    }
    if (!monthlyCheck.ok){
      dom.goalMonthlyErr.textContent = monthlyCheck.error;
      dom.goalMonthlyErr.style.display = 'block';
      showToast(monthlyCheck.error, 'error');
      dom.goalModalCreate.disabled = false;
      return;
    }
    const priority = dom.goalPriorityGroup.querySelector('.active')?.dataset.priority || 'medium';
    const editingId = dom.goalModalCreate.dataset.editingId;
    const goalData = {
      id: editingId || uid(),
      name,
      type: dom.goalType.value,
      targetAmount: targetCheck.value,
      currentAmount: currentCheck.value,
      targetDate: dom.goalDate.value,
      monthlyContribution: monthlyCheck.value,
      priority,
      createdAt: editingId ? goals.find(g=>g.id===editingId)?.createdAt || nowIso() : nowIso()
    };
    goals = addGoalRecord(goals, goalData);
    setGoals(goals);
    saveGoals();
    closeGoalModal();
    renderGoals();
    renderInsights();
    updateLastSaved();
    showToast(editingId ? 'Goal updated' : 'Goal created', 'success');
    dom.goalModalCreate.disabled = false;
  });
  dom.goalsGrid.addEventListener('click', (e)=>{
    const action = e.target.closest('[data-goal-action]'); if(!action) return;
    const id = action.getAttribute('data-id');
    const goal = goals.find(g=>g.id===id);
    if (!goal) return;
    const act = action.getAttribute('data-goal-action');
    if (act==='delete'){
      confirmAction('Delete this goal?', ()=>{
        goals = goals.filter(g=>g.id!==id);
        setGoals(goals);
        saveGoals();
        renderGoals();
        renderInsights();
        updateLastSaved();
        showToast('Goal deleted', 'success');
      });
    }
    if (act==='edit'){
      openGoalModal(goal);
    }
    if (act==='log'){
      const input = prompt('Log contribution amount:', '0');
      if (input===null) return;
      const check = validateAmountInput(input);
      if (!check.ok){
        showToast(check.error, 'error');
        return;
      }
      goal.currentAmount = Number(goal.currentAmount||0) + check.value;
      setGoals(goals);
      saveGoals();
      renderGoals();
      renderInsights();
      updateLastSaved();
      showToast('Contribution logged', 'success');
    }
  });
}
function initInsights(){
  dom.insightsTabs.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const tab = btn.getAttribute('data-insights-tab');
      setInsightsTab(tab);
    });
  });
  dom.whatIfExtra.addEventListener('input', updateWhatIf);
  dom.whatIfHorizon.addEventListener('input', updateWhatIf);
  setInsightsTab('weekly');
}
function initTxnModal(){
  dom.txnModalClose.addEventListener('click', closeTxnModal);
  dom.txnModalCancel.addEventListener('click', closeTxnModal);
  dom.txnModalOverlay.addEventListener('click', (e)=>{
    if (e.target === dom.txnModalOverlay) closeTxnModal();
  });
  dom.txnTypeSwitch.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-txn-type]'); if(!btn) return;
    dom.txnTypeSwitch.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const type = btn.dataset.txnType;
    dom.txnCategoryWrap.style.display = type==='expense' ? '' : 'none';
  });
  dom.txnModalAdd.addEventListener('click', ()=>{
    dom.txnModalAdd.disabled = true;
    const activeBtn = dom.txnTypeSwitch.querySelector('button.active');
    const type = activeBtn?.dataset.txnType || 'expense';
    const validation = validateAmountInput(dom.txnAmount.value);
    if (!validation.ok){
      dom.txnAmountErr.textContent = validation.error;
      dom.txnAmountErr.style.display='block';
      showToast(validation.error, 'error');
      dom.txnModalAdd.disabled = false;
      return;
    }
    dom.txnAmountErr.style.display='none';
    const amt = validation.value;
    const desc = dom.txnDesc.value.trim();
    const date = dom.txnDate.value || todayStr();
    const scheduled = dom.txnRecurring.checked;
    if (type==='income'){
      state.incomes.push({
        id: uid(),
        date,
        source: desc || 'Income',
        amount: amt,
        scheduled,
        updatedAt: nowIso()
      });
      saveState();
      renderHome(); renderTransactions();
      showToast('Transaction added', 'success');
    } else {
      const category = dom.txnCategory.value || 'Other';
      state.expenses.push({
        id: uid(),
        date,
        category,
        amount: amt,
        notes: desc,
        scheduled,
        templateId: null,
        updatedAt: nowIso()
      });
      saveState();
      renderHome(); renderTransactions();
      showToast('Transaction added', 'success');
    }
    updateLastSaved();
    dom.txnModalAdd.disabled = false;
    closeTxnModal();
  });
  document.addEventListener('keydown', (e)=>{
    if (e.key === 'Escape'){
      if (dom.confirmModalOverlay.classList.contains('is-open')) closeConfirmModal('escape');
      if (dom.goalModalOverlay.style.display==='flex') closeGoalModal();
      if (dom.txnModalOverlay.style.display==='flex') closeTxnModal();
    }
    closeTxnModal();
  });
}
function initTransactions(){
  function onFilterChange(){
    const sel = dom.filterRange.value;
    const showCustom = sel==='custom';
    dom.customStart.style.display = showCustom ? '' : 'none';
    dom.customEnd.style.display = showCustom ? '' : 'none';
    dom.toSpan.style.display = showCustom ? '' : 'none';
    renderTransactions();
  }
  dom.filterRange.addEventListener('change', onFilterChange);
  dom.customStart.addEventListener('change', renderTransactions);
  dom.customEnd.addEventListener('change', renderTransactions);
  dom.payFreq.addEventListener('change', ()=>{ state.settings.payFreq = dom.payFreq.value; saveState(); renderHome(); });
  dom.seedPayday.addEventListener('change', ()=>{ state.settings.seedPayday = dom.seedPayday.value; saveState(); renderHome(); });

  // collapse toggle
  dom.toggleFilters.addEventListener('click', ()=>{
    const collapsed = !dom.filtersCard.classList.contains('collapsed');
    dom.filtersCard.classList.toggle('collapsed', collapsed);
    dom.toggleFilters.textContent = collapsed ? 'Expand' : 'Collapse';
    dom.toggleFilters.setAttribute('aria-expanded', String(!collapsed));
  });

  // Income form
  dom.incomeForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    dom.incomeSubmitBtn.disabled = true;
    const date=dom.incomeDate.value||todayStr();
    const source=dom.incomeSource.value.trim();
    const amountCheck = validateAmountInput(dom.incomeAmount.value);
    const scheduled= !!dom.incomeScheduled.checked;
    if(!amountCheck.ok){
      dom.incomeAmountErr.textContent = amountCheck.error;
      dom.incomeAmountErr.style.display='block';
      showToast(amountCheck.error, 'error');
      dom.incomeSubmitBtn.disabled = false;
      return;
    } else dom.incomeAmountErr.style.display='none';
    const amt = amountCheck.value;
    if (editingIncomeId){
      const idx = state.incomes.findIndex(x=>x.id===editingIncomeId);
      if (idx>=0){ state.incomes[idx]={...state.incomes[idx], date, source, amount:amt, scheduled, updatedAt:nowIso()}; }
      else { state.incomes.push({id:editingIncomeId, date, source, amount:amt, scheduled, updatedAt:nowIso()}); }
      saveState(); clearIncomeForm(); renderTransactions(); renderHome(); updateLastSaved(); showToast('Transaction updated', 'success');
    } else {
      state.incomes.push({id:uid(), date, source, amount:amt, scheduled, updatedAt:nowIso()});
      saveState(); clearIncomeForm(); renderTransactions(); renderHome(); updateLastSaved(); showToast('Transaction added', 'success');
    }
    dom.incomeSubmitBtn.disabled = false;
  });
  dom.incomeCancelEdit.addEventListener('click', ()=>{ clearIncomeForm(); });
  dom.incomeTbody.addEventListener('click', (e)=>{
    const btn=e.target.closest('button[data-action]'); if(!btn) return;
    const id=btn.getAttribute('data-id'); const action=btn.getAttribute('data-action');
    const it = state.incomes.find(x=>x.id===id);
    if(action==='edit-income' && it){
      dom.incomeDate.value=it.date||todayStr();
      dom.incomeSource.value=it.source||'';
      dom.incomeAmount.value=Number(it.amount||0).toFixed(2);
      dom.incomeScheduled.checked = !!it.scheduled;
      editingIncomeId=id;
      dom.incomeSubmitBtn.textContent='Save Income';
    }else if(action==='del-income'){
      confirmAction('Delete this transaction?', ()=>{
        state.incomes=state.incomes.filter(x=>x.id!==id);
        if (editingIncomeId===id){ clearIncomeForm(); }
        saveState(); renderTransactions(); renderHome(); updateLastSaved(); showToast('Transaction deleted', 'success');
      });
    }
  });

  // Expense form
  dom.expenseForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    dom.expenseSubmitBtn.disabled = true;
    const date=dom.expenseDate.value||todayStr();
    const selected=dom.expenseCategory.value;
    const custom=dom.expenseCategoryCustom.value.trim();
    const category=custom||selected;
    const amountCheck = validateAmountInput(dom.expenseAmount.value);
    const notes=dom.expenseNotes.value.trim();
    const scheduled= !!dom.expenseScheduled.checked;
    if(!amountCheck.ok){
      dom.expenseAmountErr.textContent = amountCheck.error;
      dom.expenseAmountErr.style.display='block';
      showToast(amountCheck.error, 'error');
      dom.expenseSubmitBtn.disabled = false;
      return;
    } else dom.expenseAmountErr.style.display='none';
    const amt = amountCheck.value;
    if (editingExpenseId){
      const idx = state.expenses.findIndex(x=>x.id===editingExpenseId);
      if (idx>=0){
        state.expenses[idx]={...state.expenses[idx], date, category, amount:amt, notes, scheduled, updatedAt:nowIso()};
      } else {
        state.expenses.push({id:editingExpenseId, date, category, amount:amt, notes, scheduled, templateId:null, updatedAt:nowIso()});
      }
      saveState(); clearExpenseForm(); renderTransactions(); renderHome(); updateLastSaved(); showToast('Transaction updated', 'success');
    } else {
      state.expenses.push({id:uid(), date, category, amount:amt, notes, scheduled, templateId:null, updatedAt:nowIso()});
      saveState(); clearExpenseForm(); renderTransactions(); renderHome(); updateLastSaved(); showToast('Transaction added', 'success');
    }
    dom.expenseSubmitBtn.disabled = false;
  });
  dom.expenseCancelEdit.addEventListener('click', ()=>{ clearExpenseForm(); });
  dom.expenseTbody.addEventListener('click', (e)=>{
    const btn=e.target.closest('button[data-action]'); if(!btn) return;
    const id=btn.getAttribute('data-id'); const action=btn.getAttribute('data-action');
    const it = state.expenses.find(x=>x.id===id);
    if(action==='edit-expense' && it){
      dom.expenseDate.value=it.date||todayStr();
      const opts=Array.from(dom.expenseCategory.options).map(o=>o.value);
      if(opts.includes(it.category)){ dom.expenseCategory.value=it.category; dom.expenseCategoryCustom.value=''; }
      else { dom.expenseCategory.value='Other'; dom.expenseCategoryCustom.value=it.category||''; }
      dom.expenseAmount.value=Number(it.amount||0).toFixed(2);
      dom.expenseNotes.value=it.notes||'';
      dom.expenseScheduled.checked = !!it.scheduled;
      editingExpenseId=id;
      dom.expenseSubmitBtn.textContent='Save Expense';
    }else if(action==='del-expense'){
      confirmAction('Delete this transaction?', ()=>{
        state.expenses=state.expenses.filter(x=>x.id!==id);
        if (editingExpenseId===id){ clearExpenseForm(); }
        saveState(); renderTransactions(); renderHome(); updateLastSaved(); showToast('Transaction deleted', 'success');
      });
    }
  });
}
function initCalendar(){
  dom.calPrev.addEventListener('click', ()=>{
    calCursor = new Date(calCursor.getFullYear(), calCursor.getMonth()-1, 1);
    renderCalendar();
  });
  dom.calNext.addEventListener('click', ()=>{
    calCursor = new Date(calCursor.getFullYear(), calCursor.getMonth()+1, 1);
    renderCalendar();
  });
  dom.dayDetailBody.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-dd]'); if (!btn) return;
    const act = btn.getAttribute('data-dd');
    const id = btn.getAttribute('data-id');
    const type = btn.getAttribute('data-type');
    if (!id || !type) return;
    if (act === 'del'){
      confirmAction('Delete this scheduled item?', ()=>{
        if (type === 'income') state.incomes = state.incomes.filter(x=>x.id!==id);
        else state.expenses = state.expenses.filter(x=>x.id!==id);
        saveState(); renderHome(); renderTransactions(); renderCalendar(); updateLastSaved();
        showToast('Scheduled item deleted', 'success');
      });
      return;
    }
    if (act === 'paid'){
      if (type === 'income'){
        const it = state.incomes.find(x=>x.id===id); if(!it) return;
        const posted = toISO(new Date());
        state.incomes = state.incomes.filter(x=>x.id!==id);
        state.incomes.push({id:uid(), date:posted, source:it.source||'Income', amount:Number(it.amount||0), scheduled:false, updatedAt:nowIso()});
        saveState(); renderHome(); renderTransactions(); renderCalendar(); updateLastSaved(); showToast('Marked paid', 'success');
      } else {
        const it = state.expenses.find(x=>x.id===id); if(!it) return;
        const next = prompt('Confirm amount for payment (you can adjust):', (Number(it.amount||0).toFixed(2)));
        if (next===null) return;
        const check = validateAmountInput(next);
        if (!check.ok){ showToast(check.error, 'error'); return; }
        const posted = toISO(new Date());
        state.expenses = state.expenses.filter(x=>x.id!==id);
        state.expenses.push({id:uid(), date:posted, category:it.category||'Expense', amount:check.value, notes:it.notes||'', scheduled:false, updatedAt:nowIso()});
        saveState(); renderHome(); renderTransactions(); renderCalendar(); updateLastSaved(); showToast('Marked paid', 'success');
      }
    }
  });
}

/* ====== Helpers & Init ====== */
function clearIncomeForm(){ editingIncomeId=null; dom.incomeDate.value=todayStr(); dom.incomeSource.value=''; dom.incomeAmount.value=''; dom.incomeScheduled.checked=false; dom.incomeAmountErr.style.display='none'; dom.incomeSubmitBtn.textContent='Add Income'; }
function clearExpenseForm(){ editingExpenseId=null; dom.expenseDate.value=todayStr(); dom.expenseCategory.value='Housing'; dom.expenseCategoryCustom.value=''; dom.expenseAmount.value=''; dom.expenseNotes.value=''; dom.expenseScheduled.checked=false; dom.expenseAmountErr.style.display='none'; dom.expenseSubmitBtn.textContent='Add Expense'; }

function init(){
  dom.incomeDate.value = todayStr(); dom.expenseDate.value = todayStr();
  dom.appbarNav.style.display=''; // visible on home initially
  dom.payFreq.value = state.settings.payFreq||'biweekly';
  dom.seedPayday.value = toISO(state.settings.seedPayday||todayStr());
  if (dom.buildStamp) dom.buildStamp.textContent = `Build ${BUILD_STAMP}`;

  initTabs(); initHome(); initGoals(); initInsights(); initTxnModal(); initTransactions(); initCalendar();
  renderHome(); renderGoals(); renderInsights(); renderTransactions();
}
init();
</script>
</body>
</html>
