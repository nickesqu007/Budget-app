<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>My Budget v1.3.1</title>
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#f7f8fb" />
<link rel="icon" href="./icon-192.png" sizes="192x192">
<link rel="apple-touch-icon" href="./icon-192.png">
<!--
v1.3.1 changes:
- CSV: Debit/Credit mode now treats Debit as ABS(outflow). Works even if your bank exports negative debits. One-pass import + Undo.
- Home: pay-period navigation moved to the sticky top app bar.
- Transactions: Filters card is collapsible to free vertical space.
- Calendar: today is highlighted.
- Export JSON remains in Tools (not on Home).

Notes:
- Storage key remains the same (simple_budget_v11) to preserve data.
- Safe-to-Spend (conservative): Net actuals up to today minus scheduled bills until next payday.
-->
<style>
  :root{
    --bg:#f7f8fb; --card:#ffffff; --muted:#6b7280; --text:#111827;
    --accent:#22c55e; --accent-2:#0ea5e9; --danger:#ef4444; --ok:#16a34a;
    --border:#e5e7eb; --shadow:0 10px 24px rgba(15,23,42,.08); --radius:16px;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    background:var(--bg); color:var(--text);}
  .wrap{max-width:1200px; margin:0 auto; padding:18px 18px 40px}
  header.appbar{position:sticky; top:0; z-index:5; background:rgba(247,248,251,.95);
    backdrop-filter: blur(6px); padding:12px 16px; border-bottom:1px solid var(--border); display:flex; gap:12px; align-items:center; justify-content:space-between}
  .tabs{display:flex; gap:8px; flex-wrap:wrap}
  .tab{padding:8px 12px; border:1px solid var(--border); background:#fff; border-radius:999px; cursor:pointer; color:#334155}
  .tab.active{background:#111827; color:#fff; border-color:#111827}
  .header-right{display:flex; gap:8px; align-items:center}
  .nav-btn{background:#fff;border:1px solid var(--border);border-radius:999px;padding:6px 10px;cursor:pointer}
  .pill{padding:8px 12px; border:1px solid var(--border); border-radius:999px; background:#fff; box-shadow:var(--shadow); display:inline-flex; gap:8px; align-items:center}
  .pill strong{font-variant-numeric: tabular-nums}
  .net{background: rgba(14,165,233,.08); border-color:#dbeafe}
  .safe{background: rgba(34,197,94,.08); border-color:#dcfce7}
  .safe.negative{background: rgba(239,68,68,.08); border-color:#fee2e2}
  .grid{display:grid; gap:16px; grid-template-columns:repeat(auto-fit, minmax(320px, 1fr))}
  .home-hero{display:flex; align-items:center; justify-content:space-between; gap:16px; padding:14px 0 6px; flex-wrap:wrap}
  .home-hero h1{margin:0; font-size:2rem}
  .home-hero p{margin:6px 0 0; color:var(--muted)}
  .hero-actions{display:flex; gap:10px; flex-wrap:wrap}
  .kpi-grid{display:grid; gap:16px; grid-template-columns:repeat(5, minmax(180px, 1fr)); margin:16px 0}
  .kpi-card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; display:flex; gap:12px; align-items:center}
  .kpi-icon{width:38px; height:38px; border-radius:12px; background:#f1f5f9; display:flex; align-items:center; justify-content:center; font-size:1.1rem}
  .kpi-label{font-size:.85rem; color:var(--muted); text-transform:uppercase; letter-spacing:.04em}
  .kpi-value{font-size:1.4rem; font-weight:700; margin:6px 0}
  .kpi-sub{font-size:.8rem; color:var(--muted)}
  .home-grid{display:grid; gap:16px; grid-template-columns:2fr 1fr}
  .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); margin-top:12px}
  .card h2{margin:0; font-size:1.05rem}
  .card-header{padding:14px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between}
  .card-body{padding:16px}
  .section-body{padding:14px}
  .card.collapsed .section-body{display:none}
  .chev{background:#fff;border:1px solid var(--border);border-radius:10px;padding:6px 8px;cursor:pointer}
  fieldset{border:1px dashed var(--border); padding:12px; border-radius:12px; margin:0 0 12px}
  legend{color:var(--muted); padding:0 8px; font-size:.9rem}
  label{display:block; font-size:.9rem; color:#475569; margin-bottom:6px}
  input, select, button, textarea{width:100%; padding:9px 10px; border-radius:10px; border:1px solid var(--border); background:#fff; color:var(--text); font-size:.95rem}
  input[type="number"]{font-variant-numeric: tabular-nums}
  textarea{min-height:64px; resize:vertical}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .row-3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}
  .actions{display:flex; gap:10px; margin-top:8px}
  .btn{cursor:pointer; border-radius:999px; border:1px solid var(--border); background:#fff; padding:8px 14px}
  .btn-primary{background:var(--accent); border-color:var(--accent); color:#fff}
  .btn-ghost{background:#fff; border:1px solid var(--border); color:#111827}
  .btn-danger{background:#fee2e2; border:1px solid #fecaca; color:#991b1b}
  .btn-sm{padding:6px 10px; font-size:.85rem}
  .badges{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .badge{background:#f8fafc; border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-variant-numeric: tabular-nums; color:#334155}
  table{width:100%; border-collapse:collapse; border:1px solid var(--border); border-radius:10px; overflow:hidden}
  thead th{background:#f8fafc; color:#334155; text-align:left; font-weight:600; padding:8px; border-bottom:1px solid var(--border)}
  tbody td{padding:8px; border-bottom:1px solid var(--border); vertical-align:top}
  tbody tr:hover{background:#f9fafb}
  .right{text-align:right} .muted{color:var(--muted); font-size:.9rem}
  .mono{font-variant-numeric:tabular-nums}
  .toast{position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#111827; color:#fff; border:1px solid #0f172a; border-radius:12px; padding:10px 14px; box-shadow:var(--shadow); z-index:50; opacity:0; pointer-events:none; transition:opacity .2s ease, transform .2s ease}
  .toast.show{opacity:1; pointer-events:auto; transform:translateX(-50%) translateY(-6px)}
  .mini-help{font-size:.85rem; color:var(--muted); margin-top:8px}
  .filters{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .filters select, .filters input[type="date"]{width:auto}
  .upcoming-list{max-height:200px; overflow:auto; border:1px dashed var(--border); border-radius:10px; padding:8px; background:#f8fafc}
  .chart-area{height:180px; display:flex; align-items:center; justify-content:center; background:#f8fafc; border:1px solid var(--border); border-radius:12px}
  .chart-area svg{width:100%; height:100%}
  .bar-row{display:grid; grid-template-columns:120px 1fr 80px; gap:10px; align-items:center; margin-bottom:10px}
  .bar-track{height:8px; background:#e2e8f0; border-radius:999px; overflow:hidden}
  .bar-fill{height:100%; background:linear-gradient(90deg, var(--accent-2), var(--accent)); border-radius:999px}
  .transactions-list{display:flex; flex-direction:column; gap:12px}
  .txn-row{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:#fff}
  .txn-title{font-weight:600}
  .txn-meta{font-size:.85rem; color:var(--muted)}
  .txn-amount{font-weight:700}
  .txn-amount.negative{color:#dc2626}
  .insight-box{border:1px solid var(--border); border-radius:12px; padding:12px; background:#f8fafc; margin-top:12px}
  .insight-label{font-size:.8rem; text-transform:uppercase; letter-spacing:.06em; color:var(--muted); margin-bottom:6px}
  .glance-row{display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed var(--border)}
  .glance-row:last-child{border-bottom:none}
  .glance-metrics{display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; margin:10px 0}
  .glance-metrics div{background:#f8fafc; border:1px solid var(--border); border-radius:10px; padding:8px; text-align:center; font-size:.85rem}
  @media (max-width: 1100px){ .kpi-grid{grid-template-columns:repeat(2, minmax(180px, 1fr));} }
  @media (max-width: 900px){ .home-grid{grid-template-columns:1fr;} }
  @media (max-width: 700px){
    .row, .row-3{grid-template-columns:1fr}
    .home-hero{align-items:flex-start}
    .kpi-grid{grid-template-columns:1fr}
    .bar-row{grid-template-columns:1fr}
    .glance-metrics{grid-template-columns:1fr}
  }
  .summary-row{display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:8px}
  /* Calendar */
  .cal-wrap{display:grid; grid-template-rows:auto 1fr; gap:12px}
  .cal-head{display:flex; gap:8px; align-items:center; justify-content:space-between}
  .cal-grid{display:grid; grid-template-columns:repeat(7, 1fr); gap:6px}
  .cal-cell{border:1px solid var(--border); border-radius:10px; padding:6px; min-height:80px; background:#fff}
  .cal-cell.out{opacity:.45}
  .cal-cell.today{border-color: var(--accent); box-shadow: inset 0 0 0 2px rgba(34,197,94,.35)}
  .cal-date{font-size:.9rem; color:#64748b}
  .cal-amt{margin-top:6px; font-variant-numeric: tabular-nums; color:#dc2626}
  .cal-weekdays{display:grid; grid-template-columns:repeat(7,1fr); gap:6px; color:#64748b; font-size:.9rem}
  .cal-total{margin-top:6px}
  .hide{display:none}
</style>
</head>
<body>
<div class="wrap">
  <header class="appbar">
    <div class="tabs" role="tablist" aria-label="Navigation">
      <button class="tab active" data-tab="home" role="tab" aria-selected="true">Home</button>
      <button class="tab" data-tab="goals" role="tab">Goals</button>
      <button class="tab" data-tab="insights" role="tab">Insights</button>
      <button class="tab" data-tab="transactions" role="tab">Transactions</button>
      <button class="tab" data-tab="calendar" role="tab">Calendar</button>
      <button class="tab" data-tab="tools" role="tab">Tools</button>
      <button class="tab" data-tab="templates" role="tab">Templates</button>
    </div>
    <div class="header-right" id="appbarNav" style="display:none">
      <button class="nav-btn" id="appPrev" title="Previous pay period">‚óÄ</button>
      <div class="badge" id="appPeriodLabel">‚Äî</div>
      <button class="nav-btn" id="appNext" title="Next pay period">‚ñ∂</button>
    </div>
  </header>

  <!-- HOME -->
  <section id="tab-home">
    <div class="home-hero">
      <div>
        <h1>Good morning</h1>
        <p>Here‚Äôs your financial snapshot</p>
      </div>
      <div class="hero-actions">
        <button class="btn btn-primary" id="addTransactionBtn" type="button">+ Add transaction</button>
        <button class="btn btn-ghost" id="setGoalBtn" type="button">Set a goal</button>
        <button class="btn btn-ghost" id="runScenarioBtn" type="button">Run scenario</button>
      </div>
    </div>

    <div class="kpi-grid">
      <div class="kpi-card safe" id="safePill">
        <div class="kpi-icon">üí≥</div>
        <div>
          <div class="kpi-label">Safe to spend</div>
          <div class="kpi-value" id="safeToSpend">$0.00</div>
          <div class="kpi-sub">Next payday <span id="nextPaydayLabel">‚Äî</span></div>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon">üìÜ</div>
        <div>
          <div class="kpi-label">This month</div>
          <div class="kpi-value" id="sumNet">$0.00</div>
          <div class="kpi-sub">Income <strong id="sumIncome">$0.00</strong> ¬∑ Out <strong id="sumExpenses">$0.00</strong></div>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon">üî•</div>
        <div>
          <div class="kpi-label">Daily burn</div>
          <div class="kpi-value" id="dailyBurn">$0.00</div>
          <div class="kpi-sub">Average spend per day</div>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon">üíπ</div>
        <div>
          <div class="kpi-label">Savings rate</div>
          <div class="kpi-value" id="savingsRate">0%</div>
          <div class="kpi-sub">Net vs income</div>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon">üìâ</div>
        <div>
          <div class="kpi-label">Debt pressure</div>
          <div class="kpi-value" id="debtPressure">0%</div>
          <div class="kpi-sub">Spending vs income</div>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon">üíπ</div>
        <div>
          <div class="kpi-label">Savings rate</div>
          <div class="kpi-value" id="savingsRate">0%</div>
          <div class="kpi-sub">Net vs income</div>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon">üìâ</div>
        <div>
          <div class="kpi-label">Debt pressure</div>
          <div class="kpi-value" id="debtPressure">0%</div>
          <div class="kpi-sub">Spending vs income</div>
        </div>
      </div>
    </div>

    <div class="home-grid">
      <div>
        <section class="card">
          <div class="card-header">
            <h2>Cash Flow Trend</h2>
            <span class="muted">Last 6 weeks</span>
          </div>
          <div class="card-body">
            <div class="chart-area" id="cashflowChart" aria-label="Cash flow trend chart"></div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <h2>Spending by Category</h2>
            <span class="muted">This month</span>
          </div>
          <div class="card-body">
            <div id="categoryChart"></div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <h2>Recent Transactions</h2>
            <button class="btn btn-ghost btn-sm" id="recentAddBtn" type="button">+ Add</button>
          </div>
          <div class="card-body">
            <div class="transactions-list" id="recentTransactions"></div>
          </div>
        </section>
      </div>

      <div>
        <section class="card">
          <div class="card-header">
            <h2>This week‚Äôs insight</h2>
          </div>
          <div class="card-body">
            <p class="muted" id="insightSummary">Add transactions to unlock weekly insights.</p>
            <div class="insight-box">
              <div class="insight-label">What matters</div>
              <div id="insightWhatMatters">‚Äî</div>
            </div>
            <div class="insight-box">
              <div class="insight-label">Suggested action</div>
              <div id="insightAction">‚Äî</div>
            </div>
            <div class="mini-help" id="wkTrend">vs 4-wk avg: ‚Äî</div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <h2>Month at a Glance</h2>
          </div>
          <div class="card-body">
            <div class="glance-row"><span>Income</span><strong id="monthIncome">$0.00</strong></div>
            <div class="glance-row"><span>Spending</span><strong id="monthSpending">$0.00</strong></div>
            <div class="glance-row"><span>Projected end</span><strong id="monthProjected">$0.00</strong></div>
            <div class="glance-row"><span>Projected to payday</span><strong id="projectedToPayday">$0.00</strong></div>
            <div class="muted" style="margin-top:10px">Next 7 days</div>
            <div class="glance-metrics">
              <div>Income<br><strong id="upIncome">$0.00</strong></div>
              <div>Bills<br><strong id="upBills">$0.00</strong></div>
              <div>Net<br><strong id="upNet">$0.00</strong></div>
            </div>
            <div class="upcoming-list" id="upcomingList" aria-live="polite"></div>
          </div>
        </section>
      </div>
    </div>

    <div class="summary-row" id="payPeriodHeader" style="display:none">
      <button class="nav-btn" id="prevPeriod" aria-label="Previous pay period">‚óÄ</button>
      <div class="badge" id="periodLabel">‚Äî</div>
      <button class="nav-btn" id="nextPeriod" aria-label="Next pay period">‚ñ∂</button>
    </div>
  </section>

  <!-- GOALS -->
  <section id="tab-goals" class="hide">
    <div class="page-header">
      <div>
        <h1>Your Goals</h1>
        <p>Track progress toward what matters most</p>
      </div>
      <button class="btn btn-primary" id="newGoalBtn" type="button">+ New Goal</button>
    </div>

    <div class="home-grid">
      <div>
        <section class="card">
          <div class="card-header">
            <h2>Cash Flow Trend</h2>
            <span class="muted">Last 6 weeks</span>
          </div>
          <div class="card-body">
            <div class="chart-area" id="cashflowChart" aria-label="Cash flow trend chart"></div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <h2>Spending by Category</h2>
            <span class="muted">This month</span>
          </div>
          <div class="card-body">
            <div id="categoryChart"></div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <h2>Recent Transactions</h2>
            <button class="btn btn-ghost btn-sm" id="recentAddBtn" type="button">+ Add</button>
          </div>
          <div class="card-body">
            <div class="transactions-list" id="recentTransactions"></div>
          </div>
        </section>
      </div>

      <div>
        <section class="card">
          <div class="card-header">
            <h2>This week‚Äôs insight</h2>
          </div>
          <div class="card-body">
            <p class="muted" id="insightSummary">Add transactions to unlock weekly insights.</p>
            <div class="insight-box">
              <div class="insight-label">What matters</div>
              <div id="insightWhatMatters">‚Äî</div>
            </div>
            <div class="insight-box">
              <div class="insight-label">Suggested action</div>
              <div id="insightAction">‚Äî</div>
            </div>
            <div class="mini-help" id="wkTrend">vs 4-wk avg: ‚Äî</div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <h2>Month at a Glance</h2>
          </div>
          <div class="card-body">
            <div class="glance-row"><span>Income</span><strong id="monthIncome">$0.00</strong></div>
            <div class="glance-row"><span>Spending</span><strong id="monthSpending">$0.00</strong></div>
            <div class="glance-row"><span>Projected end</span><strong id="monthProjected">$0.00</strong></div>
            <div class="glance-row"><span>Projected to payday</span><strong id="projectedToPayday">$0.00</strong></div>
            <div class="muted" style="margin-top:10px">Next 7 days</div>
            <div class="glance-metrics">
              <div>Income<br><strong id="upIncome">$0.00</strong></div>
              <div>Bills<br><strong id="upBills">$0.00</strong></div>
              <div>Net<br><strong id="upNet">$0.00</strong></div>
            </div>
            <div class="upcoming-list" id="upcomingList" aria-live="polite"></div>
          </div>
        </section>
      </div>
    </div>

    <div class="summary-row" id="payPeriodHeader" style="display:none">
      <button class="nav-btn" id="prevPeriod" aria-label="Previous pay period">‚óÄ</button>
      <div class="badge" id="periodLabel">‚Äî</div>
      <button class="nav-btn" id="nextPeriod" aria-label="Next pay period">‚ñ∂</button>
    </div>
  </section>

  <!-- TRANSACTIONS -->
  <section id="tab-transactions" class="hide">
    <div class="card collapsed" id="filtersCard">
      <h2>
        Filters
        <button type="button" class="chev" id="toggleFilters" aria-expanded="false">Expand</button>
      </h2>
      <div class="section-body">
        <div class="filters">
          <label class="muted" for="filterRange">View:</label>
          <select id="filterRange">
            <option value="all">All</option>
            <option value="thisWeek">This Week</option>
            <option value="lastWeek">Last Week</option>
            <option value="payPeriod">Current Pay Period</option>
            <option value="custom">Custom Range</option>
          </select>
          <input id="customStart" type="date" style="display:none">
          <span id="toSpan" class="muted" style="display:none">to</span>
          <input id="customEnd" type="date" style="display:none">
          <span class="muted">¬∑ Pay schedule:</span>
          <select id="payFreq">
            <option value="biweekly">Biweekly</option>
            <option value="weekly">Weekly</option>
            <option value="semimonthly">Semi-monthly (1st & 15th)</option>
            <option value="monthly">Monthly</option>
          </select>
          <label class="muted">Seed payday:</label>
          <input id="seedPayday" type="date">
        </div>
      </div>
    </div>

    <div class="grid">
      <section class="card" aria-labelledby="incomeHeading">
        <h2 id="incomeHeading">Income</h2>
        <div class="section-body">
          <form id="incomeForm" novalidate>
            <fieldset>
              <legend>Add / Edit Income</legend>
              <div class="row">
                <div>
                  <label for="incomeDate">Date</label>
                  <input id="incomeDate" name="date" type="date" required />
                  <div style="display:flex; gap:6px; align-items:center; margin-top:6px">
                    <input id="incomeScheduled" type="checkbox" />
                    <label for="incomeScheduled" class="muted">Scheduled (future)</label>
                  </div>
                </div>
                <div>
                  <label for="incomeSource">Source</label>
                  <input id="incomeSource" name="source" type="text" placeholder="Paycheck, Refund‚Ä¶" required />
                </div>
              </div>
              <div class="row">
                <div>
                  <label for="incomeAmount">Amount</label>
                  <input id="incomeAmount" name="amount" type="number" step="0.01" min="0" inputmode="decimal" placeholder="0.00" required />
                  <div id="incomeAmountErr" class="error">Enter a valid non-negative amount.</div>
                </div>
                <div>
                  <label>&nbsp;</label>
                  <div class="actions">
                    <button class="btn btn-primary" id="incomeSubmitBtn" type="submit">Add Income</button>
                    <button class="btn btn-ghost" id="incomeCancelEdit" type="button" style="display:none">Cancel Edit</button>
                  </div>
                </div>
              </div>
            </fieldset>
          </form>

          <div style="overflow:auto">
            <table aria-describedby="incomeHeading">
              <thead><tr><th>Date</th><th>Source</th><th>Scheduled</th><th class="right">Amount</th><th class="right">Actions</th></tr></thead>
              <tbody id="incomeTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="card" aria-labelledby="expenseHeading">
        <h2 id="expenseHeading">Expenses</h2>
        <div class="section-body">
          <form id="expenseForm" novalidate>
            <fieldset>
              <legend>Add / Edit Expense</legend>
              <div class="row-3">
                <div>
                  <label for="expenseDate">Date</label>
                  <input id="expenseDate" name="date" type="date" required />
                  <div style="display:flex; gap:6px; align-items:center; margin-top:6px">
                    <input id="expenseScheduled" type="checkbox" />
                    <label for="expenseScheduled" class="muted">Scheduled (future)</label>
                  </div>
                </div>
                <div>
                  <label for="expenseCategory">Category</label>
                  <select id="expenseCategory" name="category">
                    <option value="Housing">Housing</option>
                    <option value="Utilities">Utilities</option>
                    <option value="Food">Food</option>
                    <option value="Transport">Transport</option>
                    <option value="Debt">Debt</option>
                    <option value="Health">Health</option>
                    <option value="Entertainment">Entertainment</option>
                    <option value="Savings">Savings</option>
                    <option value="Other">Other</option>
                  </select>
                  <div class="mini-help">Or type a custom category:</div>
                  <input id="expenseCategoryCustom" type="text" placeholder="Custom category (optional)" />
                </div>
                <div>
                  <label for="expenseAmount">Amount</label>
                  <input id="expenseAmount" name="amount" type="number" step="0.01" min="0" inputmode="decimal" placeholder="0.00" required />
                  <div id="expenseAmountErr" class="error">Enter a valid non-negative amount.</div>
                </div>
              </div>
              <div class="row">
                <div>
                  <label for="expenseNotes">Notes (optional)</label>
                  <textarea id="expenseNotes" name="notes" placeholder="Short note‚Ä¶"></textarea>
                </div>
                <div>
                  <label>&nbsp;</label>
                  <div class="actions">
                    <button class="btn btn-primary" id="expenseSubmitBtn" type="submit">Add Expense</button>
                    <button class="btn btn-ghost" id="expenseCancelEdit" type="button" style="display:none">Cancel Edit</button>
                  </div>
                </div>
              </div>
            </fieldset>
          </form>

          <div style="overflow:auto">
            <table aria-describedby="expenseHeading">
              <thead><tr><th>Date</th><th>Category</th><th>Scheduled</th><th class="right">Amount</th><th>Notes</th><th class="right">Actions</th></tr></thead>
              <tbody id="expenseTbody"></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </section>

  <!-- CALENDAR -->
  <section id="tab-calendar" class="hide">
    <div class="card">
      <h2>Calendar (bills-only)</h2>
      <div class="section-body cal-wrap">
        <div class="cal-head">
          <div style="display:flex; gap:8px; align-items:center">
            <button class="nav-btn" id="calPrev">‚óÄ</button>
            <div class="badge" id="calLabel">‚Äî</div>
            <button class="nav-btn" id="calNext">‚ñ∂</button>
          </div>
          <div class="badge cal-total">Monthly scheduled bills: <strong id="calMonthTotal">$0.00</strong></div>
        </div>
        <div class="cal-weekdays"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div>
        <div class="cal-grid" id="calGrid"></div>
        <div class="card" style="margin:0">
          <h2 id="dayDetailTitle">Selected day</h2>
          <div class="section-body" id="dayDetailBody" class="muted">Click a day to see bills.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- TOOLS -->
  <section id="tab-tools" class="hide">
    <div class="card">
      <h2>Import / Export</h2>
      <div class="section-body">
        <div class="actions">
          <button id="exportBtn" class="btn btn-ghost">Export JSON</button>
          <label for="importFile" class="btn btn-ghost" style="display:inline-flex; align-items:center; gap:8px; cursor:pointer">
            Import JSON <input id="importFile" type="file" accept="application/json" style="display:none" />
          </label>
          <label for="csvFile" class="btn btn-ghost" style="display:inline-flex; align-items:center; gap:8px; cursor:pointer">
            Import CSV <input id="csvFile" type="file" accept=".csv,text/csv" style="display:none" />
          </label>
          <button id="undoImportBtn" class="btn btn-ghost" title="Undo last import" disabled>Undo Last Import</button>
          <button id="resetBtn" class="btn btn-danger">‚ö† Reset Data</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Calculators</h2>
      <div class="section-body">
        <div class="row">
          <div>
            <label for="whatIfNumber">What-If amount</label>
            <input id="whatIfNumber" type="number" min="0" step="1" inputmode="decimal" />
            <div class="mini-help">Projected Balance (Net ‚àí What-If): <strong id="projectedBalance">$0.00</strong></div>
          </div>
          <div>
            <label for="calcAmount">Quick Calculator: Planned purchase</label>
            <input id="calcAmount" type="number" min="0" step="1" inputmode="decimal" placeholder="e.g., 250" />
            <div class="mini-help">New Balance (Net ‚àí Planned): <strong id="calcResult">$0.00</strong></div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Sync (E2EE via GitHub Gist)</h2>
      <div class="section-body">
        <div class="mini-help">Bring your own token (gist scope). We store only encrypted data.</div>
        <div class="row">
          <div>
            <label for="syncPass">Passphrase (don‚Äôt lose this)</label>
            <input id="syncPass" type="password" placeholder="Your passphrase" />
          </div>
          <div>
            <label for="syncToken">GitHub Token (gist scope)</label>
            <input id="syncToken" type="password" placeholder="ghp_..." />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="syncId">Sync ID (Gist ID)</label>
            <input id="syncId" type="text" placeholder="e.g., a1b2c3d4..." />
          </div>
          <div class="actions" style="align-items:end">
            <button id="btnCreateGist" class="btn btn-primary" type="button" style="width:auto">Create New Sync</button>
            <button id="btnConnect" class="btn btn-ghost" type="button" style="width:auto">Connect</button>
            <button id="btnSyncNow" class="btn btn-ghost" type="button" style="width:auto" disabled>Sync Now</button>
            <button id="btnSignOut" class="btn btn-danger" type="button" style="width:auto">Sign out of Sync</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- TEMPLATES -->
  <section id="tab-templates" class="hide">
    <div class="card">
      <h2>Recurring Expense Templates</h2>
      <div class="section-body">
        <form id="tplForm">
          <fieldset>
            <legend>Create / Edit Template</legend>
            <div class="row-3">
              <div><label for="tplLabel">Label (e.g., Rent)</label><input id="tplLabel" type="text" required /></div>
              <div><label for="tplAmount">Amount</label><input id="tplAmount" type="number" min="0" step="0.01" inputmode="decimal" required /></div>
              <div><label for="tplFreq">Frequency</label>
                <select id="tplFreq">
                  <option value="weekly">Weekly</option>
                  <option value="biweekly">Biweekly</option>
                  <option value="semimonthly">Semi-monthly (1st & 15th)</option>
                  <option value="monthly">Monthly</option>
                </select>
              </div>
            </div>
            <div id="tplAnchors" class="row-3" style="margin-top:8px">
              <div id="anchWeekly" class="hide"><label for="tplWeekday">Weekday</label>
                <select id="tplWeekday"><option value="0">Sunday</option><option value="1">Monday</option><option value="2">Tuesday</option><option value="3">Wednesday</option><option value="4">Thursday</option><option value="5">Friday</option><option value="6">Saturday</option></select>
              </div>
              <div id="anchBiweekly" class="hide"><label for="tplSeedDate">Seed date</label><input id="tplSeedDate" type="date" /></div>
              <div id="anchMonthly" class="hide"><label for="tplMonthDay">Day of month</label><input id="tplMonthDay" type="number" min="1" max="31" /></div>
            </div>
            <div class="row">
              <div><label for="tplStart">Start date</label><input id="tplStart" type="date" /></div>
              <div><label for="tplNotes">Notes (optional)</label><input id="tplNotes" type="text" /></div>
            </div>
            <div class="actions"><button class="btn btn-primary" id="tplSave" type="submit">Save Template</button><button class="btn btn-ghost" id="tplCancel" type="button">Cancel</button></div>
            <div id="tplErr" class="error" style="display:none">Please fill the highlighted fields.</div>
          </fieldset>
        </form>
        <div class="card" style="margin:12px 0 0">
          <h2>Templates List</h2>
          <div class="section-body" id="tplList" class="muted">No templates yet.</div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- CSV Mapping Modal -->
<div id="csvModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:60; align-items:center; justify-content:center;">
  <div class="card" style="width:min(980px, 96%); max-height:90%; overflow:auto;">
    <h2 style="display:flex;justify-content:space-between;align-items:center;padding:12px 14px;">
      Import CSV
      <button id="csvClose" class="btn btn-ghost" style="width:auto">Close</button>
    </h2>
    <div class="section-body">
      <div class="row-3">
        <div><label for="mapDate">Date column</label><select id="mapDate"></select></div>
        <div><label for="mapDesc">Description column</label><select id="mapDesc"></select></div>
        <div><label for="amountMode">Amount mode</label>
          <select id="amountMode">
            <option value="auto">Auto-detect</option>
            <option value="signed">Signed Amount column (neg=expense)</option>
            <option value="dc">Debit/Credit columns</option>
          </select>
        </div>
      </div>
      <div class="row-3" id="amountRowSigned" style="margin-top:8px; display:none">
        <div><label for="mapAmount">Amount column</label><select id="mapAmount"></select></div>
        <div><label for="invertSign">Invert sign</label>
          <select id="invertSign"><option value="no">No</option><option value="yes">Yes</option></select>
        </div>
      </div>
      <div class="row-3" id="amountRowDC" style="margin-top:8px; display:none">
        <div><label for="mapDebit">Debit column</label><select id="mapDebit"></select></div>
        <div><label for="mapCredit">Credit column</label><select id="mapCredit"></select></div>
        <div><label for="treatBlankAsZero">Treat blank as 0</label>
          <select id="treatBlankAsZero"><option value="yes">Yes</option><option value="no">No</option></select>
        </div>
      </div>
      <div class="mini-help" style="margin-top:6px">Rows with Description containing ‚ÄúBeginning Balance‚Äù are skipped.</div>
      <div style="margin:10px 0"><button id="csvImportBtn" class="btn btn-primary" style="width:auto">Import</button></div>
      <div style="overflow:auto; border:1px solid var(--border); border-radius:10px">
        <table><thead><tr id="csvHead"></tr></thead><tbody id="csvBody"></tbody></table>
      </div>
    </div>
  </div>
</div>

<!-- Goals Modal -->
<div class="modal-overlay" id="goalModalOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="goalModalTitle">
    <button class="close-btn" type="button" id="goalModalClose">√ó</button>
    <h3 id="goalModalTitle">Create New Goal</h3>
    <div class="row" style="margin-top:12px">
      <div style="grid-column:1 / -1">
        <label for="goalName">Goal Name</label>
        <input id="goalName" type="text" placeholder="e.g., Emergency Fund" required>
      </div>
    </div>
    <div style="margin-top:12px">
      <label for="goalType">Goal Type</label>
      <select id="goalType">
        <option value="General Savings">General Savings</option>
        <option value="Debt Payoff">Debt Payoff</option>
        <option value="Big Purchase">Big Purchase</option>
      </select>
    </div>
    <div class="row" style="margin-top:12px">
      <div>
        <label for="goalTarget">Target Amount</label>
        <input id="goalTarget" type="number" min="0" step="0.01" placeholder="10000">
      </div>
      <div>
        <label for="goalCurrent">Current Progress</label>
        <input id="goalCurrent" type="number" min="0" step="0.01" placeholder="0">
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <div>
        <label for="goalDate">Target Date</label>
        <input id="goalDate" type="date">
      </div>
      <div>
        <label for="goalMonthly">Monthly Contribution</label>
        <input id="goalMonthly" type="number" min="0" step="0.01" placeholder="500">
      </div>
    </div>
    <div style="margin-top:12px">
      <label>Priority</label>
      <div class="priority-group" id="goalPriorityGroup">
        <button class="pill-btn" type="button" data-priority="low">Low</button>
        <button class="pill-btn active" type="button" data-priority="medium">Medium</button>
        <button class="pill-btn" type="button" data-priority="high">High</button>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" id="goalModalCancel" type="button">Cancel</button>
      <button class="btn btn-primary" id="goalModalCreate" type="button">Create Goal</button>
    </div>
  </div>
</div>

<!-- Add Transaction Modal -->
<div class="modal-overlay" id="txnModalOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="txnModalTitle">
    <button class="close-btn" type="button" id="txnModalClose">√ó</button>
    <h3 id="txnModalTitle">Add Transaction</h3>
    <div class="segmented" id="txnTypeSwitch" style="margin-top:12px">
      <button type="button" class="active" data-txn-type="expense">Expense</button>
      <button type="button" data-txn-type="income">Income</button>
    </div>
    <div style="margin-top:12px">
      <label for="txnAmount">Amount</label>
      <input id="txnAmount" type="number" min="0" step="0.01" placeholder="0.00">
    </div>
    <div style="margin-top:12px">
      <label for="txnDesc">Description</label>
      <input id="txnDesc" type="text" placeholder="e.g., Coffee at Starbucks">
    </div>
    <div class="row" style="margin-top:12px">
      <div>
        <label for="txnDate">Date</label>
        <input id="txnDate" type="date">
      </div>
      <div id="txnCategoryWrap">
        <label for="txnCategory">Category</label>
        <select id="txnCategory">
          <option value="">Select category</option>
          <option value="Housing">Housing</option>
          <option value="Utilities">Utilities</option>
          <option value="Food">Food</option>
          <option value="Transport">Transport</option>
          <option value="Debt">Debt</option>
          <option value="Health">Health</option>
          <option value="Entertainment">Entertainment</option>
          <option value="Savings">Savings</option>
          <option value="Other">Other</option>
        </select>
      </div>
    </div>
    <div class="toggle-row" style="margin-top:12px">
      <span class="muted">This is a recurring transaction</span>
      <label class="toggle-switch">
        <input type="checkbox" id="txnRecurring">
        <span class="toggle-slider"></span>
      </label>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" id="txnModalCancel" type="button">Cancel</button>
      <button class="btn btn-primary" id="txnModalAdd" type="button">Add Transaction</button>
    </div>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(console.error); });
}

/* ====== Storage & Utilities ====== */
const LS_KEY='simple_budget_v11';
const GOALS_KEY='budget_goals_v1';
const fmt=new Intl.NumberFormat(undefined,{style:'currency',currency:getLikelyCurrency(),minimumFractionDigits:2,maximumFractionDigits:2});
function getLikelyCurrency(){try{new Intl.NumberFormat(undefined,{style:'currency',currency:'USD'}).formatToParts(1);return(Intl.NumberFormat().resolvedOptions().currency||'USD')}catch{return'USD'}}
function formatCurrency(n){return fmt.format(Number(n||0))}
function parseAmount(v){if(typeof v==='number')return v;if(!v&&v!==0)return NaN;v=String(v).replace(/[^0-9,.\-]/g,'').replace(',', '.');const num=Number(v);return Number.isFinite(num)?num:NaN}
function uid(){return Math.random().toString(36).slice(2)+Date.now().toString(36)}
function nowIso(){return new Date().toISOString()}
function todayStr(){return new Date().toISOString().slice(0,10)}
function toISO(d){return new Date(d).toISOString().slice(0,10)}
function startOfWeekSunday(d){const dt=new Date(d);const dow=dt.getDay();dt.setDate(dt.getDate()-dow);dt.setHours(0,0,0,0);return dt}
function endOfWeekSunday(d){const s=startOfWeekSunday(d);const e=new Date(s);e.setDate(s.getDate()+6);e.setHours(23,59,59,999);return e}
function addDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return x}
function clipDOM(year, month, day){const last=new Date(year, month+1, 0).getDate(); return new Date(year, month, Math.min(day,last));}
function isFuture(iso){const d=new Date(iso);const t=new Date();t.setHours(0,0,0,0);return d>t}
function inRange(iso,start,end){try{const d=new Date(iso);return d>=start && d<=end}catch{return false}}
function escapeHtml(s){return String(s).replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;'}[c]))}
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1400)}
function byId(id){return document.getElementById(id)}

/* ====== State ====== */
let state = loadState();
if (!state.settings) state.settings = { payFreq:'biweekly', seedPayday: toISO(addDays(new Date(), 14)) };
if (!('payPeriodOffset' in state)) state.payPeriodOffset = 0;
if (!state.templates) state.templates = [];
if (!state.lastImportBatch) state.lastImportBatch = null;
if (!state.sync) state.sync = { provider:null, gistId:null, token:null, keySalt:null, passHint:null, lastRev:0 };
saveState();
let goals = loadGoals();

function loadState(){try{const raw=localStorage.getItem(LS_KEY); if(!raw) return seed(); const obj=JSON.parse(raw); return obj;}catch{return seed()}}
function saveState(){localStorage.setItem(LS_KEY, JSON.stringify(state))}
function loadGoals(){try{const raw=localStorage.getItem(GOALS_KEY); if(!raw) return []; const obj=JSON.parse(raw); return Array.isArray(obj)?obj:[];}catch{return []}}
function saveGoals(){localStorage.setItem(GOALS_KEY, JSON.stringify(goals))}
function seed(){
  const s = { version:'1.3.1', settings:{payFreq:'biweekly', seedPayday: toISO(addDays(new Date(), 14))}, payPeriodOffset:0, incomes:[], expenses:[], templates:[], lastImportBatch:null, sync:{provider:null,gistId:null,token:null,keySalt:null,passHint:null,lastRev:0} };
  s.incomes.push({id:uid(), date:toISO(addDays(new Date(), -10)), source:'Paycheck', amount:3200, scheduled:false, updatedAt:nowIso()});
  s.incomes.push({id:uid(), date:toISO(addDays(new Date(), -3)), source:'Freelance', amount:450, scheduled:false, updatedAt:nowIso()});
  s.expenses.push({id:uid(), date:toISO(addDays(new Date(), -9)), category:'Housing', amount:1200, notes:'Rent', scheduled:false, updatedAt:nowIso()});
  s.expenses.push({id:uid(), date:toISO(addDays(new Date(), -2)), category:'Food', amount:245.37, notes:'Groceries', scheduled:false, updatedAt:nowIso()});
  return s;
}

/* ====== Pay period helpers (semimonthly fixed windows honored) ====== */
function nextPaydayFromSettings(offset=0){
  const freq = state.settings.payFreq||'biweekly';
  const seed = new Date(state.settings.seedPayday||todayStr());
  const today = new Date(); today.setHours(0,0,0,0); let next = new Date(seed);
  function advance(n){ next.setDate(next.getDate()+n); }
  if (freq==='weekly'){ while (next <= today) advance(7); advance(7*offset); }
  else if (freq==='biweekly'){ while (next <= today) advance(14); advance(14*offset); }
  else if (freq==='semimonthly'){
    const y=today.getFullYear(), m=today.getMonth();
    let c=[new Date(y,m,1), new Date(y,m,15), new Date(y,m+1,1), new Date(y,m+1,15)];
    c=c.map(x=>{x.setHours(0,0,0,0);return x;}).filter(x=>x>today);
    next = c[0] || new Date(y,m+1,1);
    for (let i=0;i<Math.abs(offset);i++){
      const cur=next;
      if (offset>0){ next=(cur.getDate()===1)? new Date(cur.getFullYear(), cur.getMonth(), 15)
                                             : new Date(cur.getFullYear(), cur.getMonth()+1, 1); }
      else { next=(cur.getDate()===15)? new Date(cur.getFullYear(), cur.getMonth(), 1)
                                      : new Date(cur.getFullYear(), cur.getMonth()-1, 15); }
    }
  } else if (freq==='monthly'){
    const day = new Date(state.settings.seedPayday||todayStr()).getDate();
    next = new Date(today.getFullYear(), today.getMonth(), day);
    if (next <= today) next = new Date(today.getFullYear(), today.getMonth()+1, day);
    next.setMonth(next.getMonth()+offset);
  }
  next.setHours(0,0,0,0);
  return next;
}
function currentPayPeriodRange(){
  const freq = state.settings.payFreq||'biweekly';
  const next = nextPaydayFromSettings(state.payPeriodOffset||0);
  let start, end;
  if (freq==='semimonthly'){
    if (next.getDate()===1){
      const pm=new Date(next.getFullYear(), next.getMonth()-1, 1);
      start=new Date(pm.getFullYear(), pm.getMonth(), 16);
      end=new Date(pm.getFullYear(), pm.getMonth()+1, 0);
    } else if (next.getDate()===15){
      start=new Date(next.getFullYear(), next.getMonth(), 1);
      end=new Date(next.getFullYear(), next.getMonth(), 15);
    } else { start=new Date(next.getFullYear(), next.getMonth(), 1); end=new Date(next.getFullYear(), next.getMonth(), 15); }
  } else {
    end = new Date(next); end.setHours(23,59,59,999);
    start = new Date(next);
    if (freq==='weekly') start.setDate(start.getDate()-7);
    else if (freq==='biweekly') start.setDate(start.getDate()-14);
    else if (freq==='monthly') start.setMonth(start.getMonth()-1);
  }
  start.setHours(0,0,0,0);
  return {start, end};
}
function formatRangeShort(start,end){
  const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  return `${months[start.getMonth()]} ${start.getDate()}‚Äì${months[end.getMonth()]} ${end.getDate()}`;
}

/* ====== Filters (Transactions tab) ====== */
function getActiveRange(){
  const now = new Date();
  const sel = dom.filterRange.value;
  if (sel==='thisWeek'){ return {start: startOfWeekSunday(now), end: endOfWeekSunday(now)}; }
  if (sel==='lastWeek'){ const s = addDays(startOfWeekSunday(now), -7); return {start: s, end: addDays(endOfWeekSunday(now), -7)}; }
  if (sel==='payPeriod'){ return currentPayPeriodRange(); }
  if (sel==='custom'){
    const s = dom.customStart.value ? new Date(dom.customStart.value) : new Date('1970-01-01');
    const e = dom.customEnd.value ? new Date(dom.customEnd.value) : new Date('2999-12-31');
    e.setHours(23,59,59,999);
    return {start:s, end:e};
  }
  return {start: new Date('1970-01-01'), end: new Date('2999-12-31')};
}

/* ====== Calculations ====== */
function totalsForRange(range){
  const today = new Date(); today.setHours(0,0,0,0);
  const inc = state.incomes.filter(x=>inRange(x.date, range.start, range.end) && !(x.scheduled && isFuture(x.date)))
                           .reduce((s,x)=>s+Number(x.amount||0),0);
  const exp = state.expenses.filter(x=>inRange(x.date, range.start, range.end) && !(x.scheduled && isFuture(x.date)))
                            .reduce((s,x)=>s+Number(x.amount||0),0);
  return {inc, exp, net: inc-exp};
}
function computeUpcoming7(){
  const start = new Date(); start.setHours(0,0,0,0);
  const end = addDays(start, 7);
  const upsInc = state.incomes.filter(x=>x.scheduled && inRange(x.date, start, end));
  const upsExp = state.expenses.filter(x=>x.scheduled && inRange(x.date, start, end));
  const sumInc = upsInc.reduce((s,x)=>s+Number(x.amount||0),0);
  const sumExp = upsExp.reduce((s,x)=>s+Number(x.amount||0),0);
  const items = [...upsExp.map(x=>({...x, type:'expense'})), ...upsInc.map(x=>({...x, type:'income'}))]
    .sort((a,b)=>String(a.date).localeCompare(String(b.date)));
  return {sumInc, sumExp, items};
}
function computeProjectedToPayday(){
  const next = nextPaydayFromSettings();
  const today = new Date(); today.setHours(0,0,0,0);
  const upsInc = state.incomes.filter(x=>x.scheduled && inRange(x.date, today, next));
  const upsExp = state.expenses.filter(x=>x.scheduled && inRange(x.date, today, next));
  const sumInc = upsInc.reduce((s,x)=>s+Number(x.amount||0),0);
  const sumExp = upsExp.reduce((s,x)=>s+Number(x.amount||0),0);
  const actualRange = {start: new Date('1970-01-01'), end: today};
  const {net} = totalsForRange(actualRange);
  return {next, projected: net + sumInc - sumExp};
}
function computeSafeToSpend(){
  const next = nextPaydayFromSettings();
  const today = new Date(); today.setHours(0,0,0,0);
  const scheduledBills = state.expenses.filter(x=>x.scheduled && inRange(x.date, today, next))
        .reduce((s,x)=>s+Number(x.amount||0),0);
  const actualRange = {start: new Date('1970-01-01'), end: today};
  const {net: actualNet} = totalsForRange(actualRange);
  return {next, safe: actualNet - scheduledBills};
}
function weeklySummaryCalc(){
  const now = new Date(); now.setHours(0,0,0,0);
  const s = startOfWeekSunday(now), e=endOfWeekSunday(now);
  const daysElapsed = Math.max(1, Math.min(7, Math.floor((now - s)/86400000)+1));
  const spent = state.expenses.filter(x=>!x.scheduled && inRange(x.date, s, e)).reduce((a,b)=>a+Number(b.amount||0),0);
  const avg = spent / daysElapsed; const proj = avg * 7;
  let sumPrior=0; for (let i=1;i<=4;i++){ const ps=addDays(s,-7*i), pe=addDays(e,-7*i);
    sumPrior += state.expenses.filter(x=>!x.scheduled && inRange(x.date, ps, pe)).reduce((a,b)=>a+Number(b.amount||0),0);
  }
  const avg4 = sumPrior/4; return {spent, avg, proj, avg4};
}

/* ====== Recurring templates ====== */
function generateTemplateInstances(){
  const windowDays = 60;
  const start = new Date(); start.setHours(0,0,0,0);
  const end = addDays(start, windowDays);
  state.expenses = state.expenses.filter(x=>{
    if (!x.scheduled || !x.templateId) return true;
    const tpl = state.templates.find(t=>t.id===x.templateId);
    if (!tpl || tpl.active===false) return false;
    const d=new Date(x.date);
    return d>=start && d<=end;
  });
  for (const t of state.templates){
    if (t.active===false) continue;
    const genStart = new Date(Math.max(start, new Date(t.startDate||start)));
    const addInst = (d)=>{
      const iso=toISO(d);
      const exists = state.expenses.some(x=>x.scheduled && x.templateId===t.id && x.date===iso);
      if (!exists) state.expenses.push({id:uid(), date:iso, category:t.label||'Bill', amount:Number(t.amount||0), notes:t.notes||'', scheduled:true, templateId:t.id, updatedAt:nowIso()});
    };
    if (t.freq==='weekly'){
      let d=new Date(genStart);
      while (d.getDay()!= (t.weekday??0)) d.setDate(d.getDate()+1);
      while (d<=end){ addInst(d); d=addDays(d,7); }
    } else if (t.freq==='biweekly'){
      const seed=new Date(t.seedDate||t.startDate||genStart);
      let d=new Date(seed);
      while (d<genStart) d=addDays(d,14);
      while (d<=end){ addInst(d); d=addDays(d,14); }
    } else if (t.freq==='semimonthly'){
      let cursor=new Date(genStart.getFullYear(), genStart.getMonth(), 1);
      while (cursor<=end){
        const d1=new Date(cursor.getFullYear(), cursor.getMonth(), 1);
        const d15=new Date(cursor.getFullYear(), cursor.getMonth(), 15);
        if (d1>=genStart && d1<=end) addInst(d1);
        if (d15>=genStart && d15<=end) addInst(d15);
        cursor.setMonth(cursor.getMonth()+1,1);
      }
    } else if (t.freq==='monthly'){
      let cursor=new Date(genStart.getFullYear(), genStart.getMonth(), 1);
      const day = Math.min(31, Math.max(1, Number(t.day||1)));
      while (cursor<=end){
        const when=clipDOM(cursor.getFullYear(), cursor.getMonth(), day);
        if (when>=genStart && when<=end) addInst(when);
        cursor.setMonth(cursor.getMonth()+1,1);
      }
    }
  }
}

/* ====== DOM refs ====== */
const dom = {
  tabs: document.querySelectorAll('.tab'),
  sections: {
    home: byId('tab-home'),
    goals: byId('tab-goals'),
    insights: byId('tab-insights'),
    transactions: byId('tab-transactions'),
    calendar: byId('tab-calendar'),
    tools: byId('tab-tools'),
    templates: byId('tab-templates')
  },
  // appbar period nav
  appbarNav: byId('appbarNav'), appPrev: byId('appPrev'), appNext: byId('appNext'), appPeriodLabel: byId('appPeriodLabel'),
  // home
  sumIncome: byId('sumIncome'), sumExpenses: byId('sumExpenses'), sumNet: byId('sumNet'),
  projectedToPayday: byId('projectedToPayday'), nextPaydayLabel: byId('nextPaydayLabel'),
  safePill: byId('safePill'), safeToSpend: byId('safeToSpend'),
  dailyBurn: byId('dailyBurn'), savingsRate: byId('savingsRate'), debtPressure: byId('debtPressure'),
  cashflowChart: byId('cashflowChart'), categoryChart: byId('categoryChart'),
  recentTransactions: byId('recentTransactions'),
  insightSummary: byId('insightSummary'), insightWhatMatters: byId('insightWhatMatters'), insightAction: byId('insightAction'),
  monthIncome: byId('monthIncome'), monthSpending: byId('monthSpending'), monthProjected: byId('monthProjected'),
  addTransactionBtn: byId('addTransactionBtn'), setGoalBtn: byId('setGoalBtn'), runScenarioBtn: byId('runScenarioBtn'),
  recentAddBtn: byId('recentAddBtn'),
  payPeriodHeader: byId('payPeriodHeader'), periodLabel: byId('periodLabel'),
  // upcoming
  upBills: byId('upBills'), upIncome: byId('upIncome'), upNet: byId('upNet'), upcomingList: byId('upcomingList'),
  // goals
  newGoalBtn: byId('newGoalBtn'), totalGoalsSaved: byId('totalGoalsSaved'), totalGoalsTarget: byId('totalGoalsTarget'),
  totalGoalsPercent: byId('totalGoalsPercent'), totalGoalsBar: byId('totalGoalsBar'), goalsGrid: byId('goalsGrid'),
  goalModalOverlay: byId('goalModalOverlay'), goalModalClose: byId('goalModalClose'), goalModalCancel: byId('goalModalCancel'),
  goalModalCreate: byId('goalModalCreate'), goalName: byId('goalName'), goalType: byId('goalType'), goalTarget: byId('goalTarget'),
  goalCurrent: byId('goalCurrent'), goalDate: byId('goalDate'), goalMonthly: byId('goalMonthly'), goalPriorityGroup: byId('goalPriorityGroup'),
  // insights
  insightsTabs: document.querySelectorAll('.insights-tab'),
  insightsWeekly: byId('insights-weekly'), insightsTrends: byId('insights-trends'), insightsWhatif: byId('insights-whatif'),
  monthlySpendingChart: byId('monthlySpendingChart'), monthlyTrendNote: byId('monthlyTrendNote'),
  insightsCategoryChart: byId('insightsCategoryChart'), insightsCategoryList: byId('insightsCategoryList'),
  weeklyInsightText: byId('weeklyInsightText'),
  insightsTotalTx: byId('insightsTotalTx'), insightsActiveGoals: byId('insightsActiveGoals'),
  insightsIncome: byId('insightsIncome'), insightsSpending: byId('insightsSpending'),
  whatIfExtra: byId('whatIfExtra'), whatIfExtraLabel: byId('whatIfExtraLabel'),
  whatIfHorizon: byId('whatIfHorizon'), whatIfHorizonLabel: byId('whatIfHorizonLabel'),
  whatIfMonthly: byId('whatIfMonthly'), whatIfTotal: byId('whatIfTotal'), whatIfMonthsLabel: byId('whatIfMonthsLabel'),
  // add transaction modal
  txnModalOverlay: byId('txnModalOverlay'), txnModalClose: byId('txnModalClose'), txnModalCancel: byId('txnModalCancel'),
  txnModalAdd: byId('txnModalAdd'), txnTypeSwitch: byId('txnTypeSwitch'), txnAmount: byId('txnAmount'),
  txnDesc: byId('txnDesc'), txnDate: byId('txnDate'), txnCategory: byId('txnCategory'), txnCategoryWrap: byId('txnCategoryWrap'),
  txnRecurring: byId('txnRecurring'),
  // weekly summary
  wkSpent: byId('wkSpent'), wkAvg: byId('wkAvg'), wkProj: byId('wkProj'), wkTrend: byId('wkTrend'),
  // filters
  filtersCard: byId('filtersCard'), toggleFilters: byId('toggleFilters'),
  filterRange: byId('filterRange'), customStart: byId('customStart'), customEnd: byId('customEnd'), toSpan: byId('toSpan'),
  payFreq: byId('payFreq'), seedPayday: byId('seedPayday'),
  // forms and tables
  incomeForm: byId('incomeForm'), incomeDate: byId('incomeDate'), incomeSource: byId('incomeSource'), incomeAmount: byId('incomeAmount'), incomeAmountErr: byId('incomeAmountErr'), incomeScheduled: byId('incomeScheduled'), incomeSubmitBtn: byId('incomeSubmitBtn'), incomeCancelEdit: byId('incomeCancelEdit'),
  expenseForm: byId('expenseForm'), expenseDate: byId('expenseDate'), expenseCategory: byId('expenseCategory'), expenseCategoryCustom: byId('expenseCategoryCustom'), expenseAmount: byId('expenseAmount'), expenseAmountErr: byId('expenseAmountErr'), expenseNotes: byId('expenseNotes'), expenseScheduled: byId('expenseScheduled'), expenseSubmitBtn: byId('expenseSubmitBtn'), expenseCancelEdit: byId('expenseCancelEdit'),
  incomeTbody: byId('incomeTbody'), expenseTbody: byId('expenseTbody'),
  // tools
  exportBtn: byId('exportBtn'), importFile: byId('importFile'),
  csvFile: byId('csvFile'), csvModal: byId('csvModal'), csvClose: byId('csvClose'),
  mapDate: byId('mapDate'), mapDesc: byId('mapDesc'), amountMode: byId('amountMode'), mapAmount: byId('mapAmount'), invertSign: byId('invertSign'), mapDebit: byId('mapDebit'), mapCredit: byId('mapCredit'), treatBlankAsZero: byId('treatBlankAsZero'),
  csvHead: byId('csvHead'), csvBody: byId('csvBody'), csvImportBtn: byId('csvImportBtn'),
  undoImportBtn: byId('undoImportBtn'),
  resetBtn: byId('resetBtn'),
  whatIfNumber: byId('whatIfNumber'), projectedBalance: byId('projectedBalance'), calcAmount: byId('calcAmount'), calcResult: byId('calcResult'),
  // calendar
  calPrev: byId('calPrev'), calNext: byId('calNext'), calLabel: byId('calLabel'), calGrid: byId('calGrid'), calMonthTotal: byId('calMonthTotal'), dayDetailTitle: byId('dayDetailTitle'), dayDetailBody: byId('dayDetailBody'),
  // templates
  tplForm: byId('tplForm'), tplLabel: byId('tplLabel'), tplAmount: byId('tplAmount'), tplFreq: byId('tplFreq'), tplWeekday: byId('tplWeekday'), tplSeedDate: byId('tplSeedDate'), tplMonthDay: byId('tplMonthDay'), tplStart: byId('tplStart'), tplNotes: byId('tplNotes'), tplSave: byId('tplSave'), tplCancel: byId('tplCancel'), tplList: byId('tplList'), tplErr: byId('tplErr'),
  anchWeekly: byId('anchWeekly'), anchBiweekly: byId('anchBiweekly'), anchMonthly: byId('anchMonthly'),
  // sync
  syncPass: byId('syncPass'), syncToken: byId('syncToken'), syncId: byId('syncId'),
  btnCreateGist: byId('btnCreateGist'), btnConnect: byId('btnConnect'), btnSyncNow: byId('btnSyncNow'), btnSignOut: byId('btnSignOut')
};

/* ====== Render ====== */
function renderHome(){
  generateTemplateInstances();
  const now = new Date(); now.setHours(0,0,0,0);
  const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
  const monthEnd = new Date(now.getFullYear(), now.getMonth()+1, 0); monthEnd.setHours(23,59,59,999);
  const monthRange = {start: monthStart, end: monthEnd};
  const {inc, exp, net} = totalsForRange(monthRange);
  dom.sumIncome.textContent = formatCurrency(inc);
  dom.sumExpenses.textContent = formatCurrency(exp);
  dom.sumNet.textContent = formatCurrency(net);
  if (dom.monthIncome) dom.monthIncome.textContent = formatCurrency(inc);
  if (dom.monthSpending) dom.monthSpending.textContent = formatCurrency(exp);

  const daysElapsed = Math.max(1, now.getDate());
  const burn = exp / daysElapsed;
  if (dom.dailyBurn) dom.dailyBurn.textContent = formatCurrency(burn);
  if (dom.savingsRate) dom.savingsRate.textContent = inc > 0 ? `${Math.round(((inc - exp) / inc) * 100)}%` : '‚Äî';
  if (dom.debtPressure) dom.debtPressure.textContent = inc > 0 ? `${Math.round((exp / inc) * 100)}%` : '‚Äî';

  const proj = computeProjectedToPayday();
  dom.projectedToPayday.textContent = formatCurrency(proj.projected);
  dom.nextPaydayLabel.textContent = toISO(proj.next);

  const scheduledInc = state.incomes.filter(x=>x.scheduled && inRange(x.date, now, monthEnd)).reduce((s,x)=>s+Number(x.amount||0),0);
  const scheduledExp = state.expenses.filter(x=>x.scheduled && inRange(x.date, now, monthEnd)).reduce((s,x)=>s+Number(x.amount||0),0);
  if (dom.monthProjected) dom.monthProjected.textContent = formatCurrency(net + scheduledInc - scheduledExp);

  const sts = computeSafeToSpend();
  dom.safeToSpend.textContent = formatCurrency(sts.safe);
  dom.safePill.classList.toggle('negative', sts.safe < 0);

  const upcoming = computeUpcoming7();
  dom.upBills.textContent = formatCurrency(upcoming.sumExp);
  dom.upIncome.textContent = formatCurrency(upcoming.sumInc);
  dom.upNet.textContent = formatCurrency(upcoming.sumInc - upcoming.sumExp);
  dom.upcomingList.innerHTML = upcoming.items.length ? upcoming.items.map(x=>`
    <div style="display:flex; justify-content:space-between; gap:8px; padding:6px 0; border-bottom:1px dashed var(--border)">
      <div>
        <div class="txn-title">${escapeHtml(x.type==='income' ? (x.source||'Income') : (x.category||'Expense'))}</div>
        <div class="txn-meta">${escapeHtml(x.date||'')} ¬∑ ${x.scheduled ? 'Scheduled' : 'Actual'}</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center">
        <span class="txn-amount ${x.type==='expense' ? 'negative' : ''}">${formatCurrency(x.amount||0)}</span>
        <button class="btn btn-ghost btn-sm" data-act="paid" data-type="${x.type}" data-id="${x.id}">Mark Paid</button>
        <button class="btn btn-ghost btn-sm" data-act="del" data-type="${x.type}" data-id="${x.id}">Delete</button>
      </div>
    </div>`).join('') : '<div class="muted">No scheduled items in the next 7 days.</div>';

  const weekly = weeklySummaryCalc();
  if (dom.wkSpent) dom.wkSpent.textContent = formatCurrency(weekly.spent);
  if (dom.wkAvg) dom.wkAvg.textContent = formatCurrency(weekly.avg);
  if (dom.wkProj) dom.wkProj.textContent = formatCurrency(weekly.proj);
  const trendPct = weekly.avg4 ? ((weekly.spent - weekly.avg4) / weekly.avg4) * 100 : 0;
  if (dom.wkTrend) dom.wkTrend.textContent = `vs 4-wk avg: ${weekly.avg4 ? `${trendPct > 0 ? '+' : ''}${Math.round(trendPct)}%` : '‚Äî'}`;
  if (dom.insightSummary) dom.insightSummary.textContent = weekly.spent ? `You are ${Math.abs(Math.round(trendPct))}% ${trendPct >= 0 ? 'above' : 'below'} your 4-week average.` : 'Add transactions to unlock weekly insights.';
  if (dom.insightWhatMatters) dom.insightWhatMatters.textContent = `Spent ${formatCurrency(weekly.spent)} ¬∑ Avg/day ${formatCurrency(weekly.avg)}.`;
  if (dom.insightAction) dom.insightAction.textContent = trendPct > 10 ? 'Trim discretionary spend this week to stay on target.' : 'Keep current pace to finish the week strong.';

  const recent = [
    ...state.incomes.filter(x=>!x.scheduled).map(x=>({type:'income', label:x.source||'Income', amount:Number(x.amount||0), date:x.date, updatedAt:x.updatedAt||x.date})),
    ...state.expenses.filter(x=>!x.scheduled).map(x=>({type:'expense', label:x.category||'Expense', amount:Number(x.amount||0), date:x.date, note:x.notes, updatedAt:x.updatedAt||x.date}))
  ].sort((a,b)=>String(b.date||'').localeCompare(String(a.date||'')) || String(b.updatedAt||'').localeCompare(String(a.updatedAt||''))).slice(0,6);
  if (dom.recentTransactions){
    dom.recentTransactions.innerHTML = recent.length ? recent.map(x=>`
      <div class="txn-row">
        <div>
          <div class="txn-title">${escapeHtml(x.label)} ${x.note ? `<span class="txn-meta">${escapeHtml(x.note)}</span>` : ''}</div>
          <div class="txn-meta">${escapeHtml(x.date||'')}</div>
        </div>
        <div class="txn-amount ${x.type==='expense' ? 'negative' : ''}">${x.type==='expense' ? '-' : '+'}${formatCurrency(x.amount||0)}</div>
      </div>`).join('') : '<div class="muted">No recent transactions yet.</div>';
  }

  if (dom.categoryChart){
    const categoryTotals = {};
    state.expenses.filter(x=>!x.scheduled && inRange(x.date, monthStart, monthEnd)).forEach(x=>{
      const key = (x.category || 'Other');
      categoryTotals[key] = (categoryTotals[key] || 0) + Number(x.amount||0);
    });
    const totalSpend = Object.values(categoryTotals).reduce((s,x)=>s+x,0);
    const topCategories = Object.entries(categoryTotals).sort((a,b)=>b[1]-a[1]).slice(0,5);
    dom.categoryChart.innerHTML = topCategories.length ? topCategories.map(([name, amount])=>{
      const pct = totalSpend ? Math.round((amount/totalSpend)*100) : 0;
      return `
        <div class="bar-row">
          <div class="txn-meta">${escapeHtml(name)}</div>
          <div class="bar-track"><div class="bar-fill" style="width:${pct}%"></div></div>
          <div class="right mono">${formatCurrency(amount)}</div>
        </div>`;
    }).join('') : '<div class="muted">No spending data yet.</div>';
  }

  if (dom.cashflowChart){
    const weeks = [];
    const thisWeekStart = startOfWeekSunday(now);
    for (let i=5;i>=0;i--){
      const s = addDays(thisWeekStart, -7*i);
      const e = endOfWeekSunday(s);
      const {net:weekNet} = totalsForRange({start:s, end:e});
      weeks.push(weekNet);
    }
    const max = Math.max(...weeks, 0);
    const min = Math.min(...weeks, 0);
    const range = Math.max(1, max - min);
    const w = 300, h = 120, pad = 12;
    const points = weeks.map((v, idx)=>{
      const x = pad + (idx * (w - pad*2) / (weeks.length - 1));
      const y = pad + ((max - v) / range) * (h - pad*2);
      return `${x},${y}`;
    });
    const line = `M ${points.join(' L ')}`;
    dom.cashflowChart.innerHTML = `
      <svg viewBox="0 0 ${w} ${h}" role="img" aria-label="Cash flow trend">
        <defs>
          <linearGradient id="lineGrad" x1="0" x2="1" y1="0" y2="0">
            <stop offset="0%" stop-color="#0ea5e9"/>
            <stop offset="100%" stop-color="#22c55e"/>
          </linearGradient>
        </defs>
        <rect x="0" y="0" width="${w}" height="${h}" fill="#f8fafc" rx="12"></rect>
        <path d="${line}" fill="none" stroke="url(#lineGrad)" stroke-width="3" stroke-linecap="round"></path>
        ${points.map(p=>`<circle cx="${p.split(',')[0]}" cy="${p.split(',')[1]}" r="3" fill="#0f172a"></circle>`).join('')}
      </svg>`;
  }

  const {start,end}=currentPayPeriodRange();
  dom.appPeriodLabel.textContent = formatRangeShort(start,end);
}
function goalTypeMeta(type){
  if (type==='Debt Payoff') return {icon:'üí≥', bg:'#fee2e2'};
  if (type==='Big Purchase') return {icon:'üéØ', bg:'#fef3c7'};
  return {icon:'üê∑', bg:'#dcfce7'};
}
function renderGoals(){
  const totalSaved = goals.reduce((s,g)=>s+Number(g.currentAmount||0),0);
  const totalTarget = goals.reduce((s,g)=>s+Number(g.targetAmount||0),0);
  const pct = totalTarget ? Math.round((totalSaved / totalTarget) * 100) : 0;
  dom.totalGoalsSaved.textContent = formatCurrency(totalSaved);
  dom.totalGoalsTarget.textContent = formatCurrency(totalTarget);
  dom.totalGoalsPercent.textContent = `${pct}%`;
  dom.totalGoalsBar.style.width = `${Math.min(100, pct)}%`;
  dom.goalsGrid.innerHTML = goals.length ? goals.map(goal=>{
    const meta = goalTypeMeta(goal.type);
    const percent = goal.targetAmount ? Math.round((goal.currentAmount / goal.targetAmount) * 100) : 0;
    const remaining = Math.max(0, Number(goal.targetAmount||0) - Number(goal.currentAmount||0));
    let helper = '';
    if (goal.targetDate){
      const targetDate = new Date(goal.targetDate);
      const months = Math.max(1, (targetDate.getFullYear()-new Date().getFullYear())*12 + (targetDate.getMonth()-new Date().getMonth()) + 1);
      const perMonth = remaining / months;
      helper = `To reach your goal, save ${formatCurrency(perMonth)} / month for the next ${months} months.`;
    } else if (goal.monthlyContribution){
      helper = `Monthly contribution: ${formatCurrency(goal.monthlyContribution)}.`;
    }
    return `
      <div class="goal-card">
        <div class="goal-actions">
          <button class="btn btn-ghost btn-sm" data-goal-action="edit" data-id="${goal.id}">‚úé</button>
          <button class="btn btn-ghost btn-sm" data-goal-action="delete" data-id="${goal.id}">üóë</button>
        </div>
        <div class="goal-meta">
          <div class="icon-pill" style="background:${meta.bg}">${meta.icon}</div>
          <div>
            <div style="font-weight:600">${escapeHtml(goal.name)}</div>
            <div class="goal-type">${escapeHtml(goal.type)}</div>
          </div>
        </div>
        <div class="goal-amount">${formatCurrency(goal.currentAmount)} <span class="muted">of ${formatCurrency(goal.targetAmount)}</span></div>
        <div class="goal-remaining">
          <span>Remaining ${formatCurrency(remaining)}</span>
          <strong>${percent}% complete</strong>
        </div>
        <div class="progress-bar" style="margin:10px 0">
          <div class="progress-fill" style="width:${Math.min(100, percent)}%"></div>
        </div>
        <div class="goal-remaining">
          <span>Target date</span>
          <strong>${goal.targetDate ? escapeHtml(goal.targetDate) : '‚Äî'}</strong>
        </div>
        ${helper ? `<div class="goal-helper">${helper}</div>` : ''}
        <button class="btn btn-primary" data-goal-action="log" data-id="${goal.id}" type="button">Log contribution</button>
      </div>
    `;
  }).join('') : '<div class="muted">No goals yet. Click ‚Äú+ New Goal‚Äù to get started.</div>';
}
function renderInsights(){
  const now = new Date(); now.setHours(0,0,0,0);
  const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
  const monthEnd = new Date(now.getFullYear(), now.getMonth()+1, 0); monthEnd.setHours(23,59,59,999);
  const {inc, exp} = totalsForRange({start: monthStart, end: monthEnd});
  dom.insightsIncome.textContent = formatCurrency(inc);
  dom.insightsSpending.textContent = formatCurrency(exp);
  dom.insightsActiveGoals.textContent = String(goals.length);
  dom.insightsTotalTx.textContent = String(state.incomes.length + state.expenses.length);

  const weekly = weeklySummaryCalc();
  const trendPct = weekly.avg4 ? ((weekly.spent - weekly.avg4) / weekly.avg4) * 100 : 0;
  dom.weeklyInsightText.textContent = weekly.spent
    ? `You spent ${Math.abs(Math.round(trendPct))}% ${trendPct <= 0 ? 'less' : 'more'} this week than your 4-week average.`
    : 'Add transactions to unlock weekly insights.';

  if (dom.monthlySpendingChart){
    const months = [];
    for (let i=5;i>=0;i--){
      const start = new Date(now.getFullYear(), now.getMonth()-i, 1);
      const end = new Date(now.getFullYear(), now.getMonth()-i+1, 0); end.setHours(23,59,59,999);
      const {exp:total} = totalsForRange({start, end});
      months.push({label:new Intl.DateTimeFormat(undefined,{month:'short'}).format(start), value:total});
    }
    const max = Math.max(...months.map(m=>m.value), 1);
    const w = 320, h = 140, pad = 16;
    const points = months.map((m, idx)=>{
      const x = pad + (idx * (w - pad*2) / (months.length - 1));
      const y = pad + ((max - m.value) / max) * (h - pad*2);
      return `${x},${y}`;
    });
    const line = `M ${points.join(' L ')}`;
    dom.monthlySpendingChart.innerHTML = `
      <svg viewBox="0 0 ${w} ${h}" role="img" aria-label="Monthly spending">
        <rect x="0" y="0" width="${w}" height="${h}" fill="#f8fafc" rx="12"></rect>
        <path d="${line}" fill="none" stroke="#22c55e" stroke-width="3" stroke-linecap="round"></path>
        ${points.map(p=>`<circle cx="${p.split(',')[0]}" cy="${p.split(',')[1]}" r="3" fill="#0f172a"></circle>`).join('')}
        ${months.map((m, idx)=>`<text x="${pad + (idx * (w - pad*2) / (months.length - 1))}" y="${h - 6}" font-size="10" text-anchor="middle" fill="#64748b">${m.label}</text>`).join('')}
      </svg>`;
    const prev = months[months.length-2]?.value || 0;
    const curr = months[months.length-1]?.value || 0;
    const delta = prev ? Math.round(((curr - prev) / prev) * 100) : 0;
    dom.monthlyTrendNote.textContent = prev ? `${Math.abs(delta)}% ${delta <= 0 ? 'less' : 'more'} than last month` : 'Same as last month';
  }

  if (dom.insightsCategoryChart){
    const totals = {};
    state.expenses.filter(x=>!x.scheduled && inRange(x.date, monthStart, monthEnd)).forEach(x=>{
      const key = x.category || 'Other';
      totals[key] = (totals[key] || 0) + Number(x.amount||0);
    });
    const entries = Object.entries(totals).sort((a,b)=>b[1]-a[1]);
    const total = entries.reduce((s,[,v])=>s+v,0) || 1;
    const colors = ['#22c55e','#6366f1','#f97316','#ec4899','#3b82f6','#facc15'];
    let offset = 0;
    const radius = 50;
    const circumference = 2 * Math.PI * radius;
    const rings = entries.slice(0,5).map(([name,val], idx)=>{
      const pct = val / total;
      const length = pct * circumference;
      const dash = `${length} ${circumference - length}`;
      const circle = `<circle r="${radius}" cx="70" cy="70" fill="transparent" stroke="${colors[idx%colors.length]}" stroke-width="14" stroke-dasharray="${dash}" stroke-dashoffset="${-offset}" />`;
      offset += length;
      return circle;
    }).join('');
    dom.insightsCategoryChart.innerHTML = `
      <svg viewBox="0 0 140 140" role="img" aria-label="Category donut">
        <circle r="${radius}" cx="70" cy="70" fill="transparent" stroke="#e5e7eb" stroke-width="14"></circle>
        ${rings}
      </svg>`;
    dom.insightsCategoryList.innerHTML = entries.slice(0,5).map(([name,val], idx)=>`
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px">
        <span style="display:flex; align-items:center; gap:8px"><span style="width:10px;height:10px;border-radius:50%;background:${colors[idx%colors.length]}"></span>${escapeHtml(name)}</span>
        <strong>${formatCurrency(val)}</strong>
      </div>
    `).join('') || '<div class="muted">No spending data yet.</div>';
  }

  updateWhatIf();
}
function updateWhatIf(){
  if (!dom.whatIfExtra) return;
  const extra = Number(dom.whatIfExtra.value || 0);
  const months = Number(dom.whatIfHorizon.value || 12);
  dom.whatIfExtraLabel.textContent = formatCurrency(extra);
  dom.whatIfHorizonLabel.textContent = `${months} months`;
  dom.whatIfMonthsLabel.textContent = String(months);
  const now = new Date(); now.setHours(0,0,0,0);
  const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
  const monthEnd = new Date(now.getFullYear(), now.getMonth()+1, 0); monthEnd.setHours(23,59,59,999);
  const {inc, exp} = totalsForRange({start: monthStart, end: monthEnd});
  const baseSavings = inc - exp;
  const newMonthly = baseSavings + extra;
  dom.whatIfMonthly.textContent = formatCurrency(newMonthly);
  dom.whatIfTotal.textContent = formatCurrency(newMonthly * months);
}
function renderTransactions(){
  const range = getActiveRange();
  const incRows = state.incomes.filter(x=>inRange(x.date, range.start, range.end) && !(x.scheduled && isFuture(x.date)))
    .sort((a,b)=>String(b.date).localeCompare(String(a.date))).map(row=>`
    <tr>
      <td>${escapeHtml(row.date||'')}</td>
      <td>${escapeHtml(row.source||'')}</td>
      <td>${row.scheduled ? 'Yes' : 'No'}</td>
      <td class="right mono">${formatCurrency(row.amount||0)}</td>
      <td class="right"><div class="actions" style="justify-content:flex-end">
        <button class="btn btn-ghost" data-action="edit-income" data-id="${row.id}">Edit</button>
        <button class="btn btn-danger" data-action="del-income" data-id="${row.id}">Delete</button>
      </div></td>
    </tr>`).join('');
  dom.incomeTbody.innerHTML = incRows || '<tr><td colspan="5" class="muted">No items for this view.</td></tr>';

  const expRows = state.expenses.filter(x=>inRange(x.date, range.start, range.end) && !(x.scheduled && isFuture(x.date)))
    .sort((a,b)=>String(b.date).localeCompare(String(a.date))).map(row=>`
    <tr>
      <td>${escapeHtml(row.date||'')}</td>
      <td>${escapeHtml(row.category||'')}</td>
      <td>${row.scheduled ? 'Yes' : 'No'}</td>
      <td class="right mono">${formatCurrency(row.amount||0)}</td>
      <td class="muted">${escapeHtml(row.notes||'')}</td>
      <td class="right"><div class="actions" style="justify-content:flex-end">
        <button class="btn btn-ghost" data-action="edit-expense" data-id="${row.id}">Edit</button>
        <button class="btn btn-danger" data-action="del-expense" data-id="${row.id}">Delete</button>
      </div></td>
    </tr>`).join('');
  dom.expenseTbody.innerHTML = expRows || '<tr><td colspan="6" class="muted">No items for this view.</td></tr>';
}
let calCursor = new Date();
function renderCalendar(){
  const y=calCursor.getFullYear(), m=calCursor.getMonth();
  dom.calLabel.textContent = new Intl.DateTimeFormat(undefined,{month:'long', year:'numeric'}).format(calCursor);

  const firstOfMonth = new Date(y,m,1); firstOfMonth.setHours(0,0,0,0);
  const start = startOfWeekSunday(firstOfMonth);
  const end = endOfWeekSunday(new Date(y, m+1, 0));
  dom.calGrid.innerHTML = '';
  const monthStart = new Date(y,m,1); monthStart.setHours(0,0,0,0);
  const monthEnd = new Date(y, m+1, 0); monthEnd.setHours(23,59,59,999);
  const monthBills = state.expenses.filter(x=>x.scheduled && inRange(x.date, monthStart, monthEnd))
                    .reduce((s,x)=>s+Number(x.amount||0),0);
  dom.calMonthTotal.textContent = formatCurrency(monthBills);

  const todayIso = todayStr();
  for (let d=new Date(start); d<=end; d=addDays(d,1)){
    const iso=toISO(d);
    const cell=document.createElement('div');
    cell.className='cal-cell'+(d.getMonth()!==m?' out':'')+(iso===todayIso?' today':'');
    cell.setAttribute('data-date', iso);
    cell.innerHTML = `
      <div class="cal-date">${d.getDate()}</div>
      <div class="cal-amt">${formatCurrency(
        state.expenses.filter(x=>x.scheduled && x.date===iso).reduce((s,x)=>s+Number(x.amount||0),0)
      )}</div>
    `;
    cell.addEventListener('click', ()=>showDayDetails(iso));
    dom.calGrid.appendChild(cell);
  }
  const isInMonth = new Date(todayIso).getMonth()===m && new Date(todayIso).getFullYear()===y;
  showDayDetails(isInMonth ? todayIso : toISO(new Date(y,m,1)));
}
function showDayDetails(iso){
  const items = state.expenses.filter(x=>x.scheduled && x.date===iso).sort((a,b)=>Number(a.amount)-Number(b.amount));
  byId('dayDetailTitle').textContent = `Bills on ${iso}`;
  byId('dayDetailBody').innerHTML = items.length ? items.map(x=>`
    <div style="display:flex; justify-content:space-between; gap:8px; padding:6px 0; border-bottom:1px solid #1a2030">
      <span>${escapeHtml(x.category||'Bill')} <span class="muted">${escapeHtml(x.notes||'')}</span></span>
      <div style="display:flex; gap:8px; align-items:center">
        <span style="color:#ff9c9c">${formatCurrency(x.amount||0)}</span>
        <button class="btn btn-ghost" data-dd="paid" data-id="${x.id}">Mark Paid</button>
        <button class="btn btn-ghost" data-dd="del"  data-id="${x.id}">Delete</button>
      </div>
    </div>`).join('') : '<div class="muted">No scheduled bills on this day.</div>';
}

/* ====== Events ====== */
function setActiveTab(tab){
  dom.tabs.forEach(b=>b.classList.toggle('active', b.getAttribute('data-tab')===tab));
  Object.keys(dom.sections).forEach(k=>{ dom.sections[k].classList.toggle('hide', k!==tab); });
  dom.appbarNav.style.display = (tab==='home') ? '' : 'none';
  if (tab==='home') renderHome();
  if (tab==='transactions') renderTransactions();
  if (tab==='calendar') renderCalendar();
}
function initTabs(){
  dom.tabs.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const tab=btn.getAttribute('data-tab');
      setActiveTab(tab);
    });
  });
}
function initHome(){
  if (dom.addTransactionBtn){
    dom.addTransactionBtn.addEventListener('click', ()=>setActiveTab('transactions'));
  }
  if (dom.recentAddBtn){
    dom.recentAddBtn.addEventListener('click', ()=>setActiveTab('transactions'));
  }
  if (dom.setGoalBtn){
    dom.setGoalBtn.addEventListener('click', ()=>{ setActiveTab('templates'); toast('Set up a recurring goal from templates.'); });
  }
  if (dom.runScenarioBtn){
    dom.runScenarioBtn.addEventListener('click', ()=>{ setActiveTab('tools'); byId('whatIfNumber')?.focus(); });
  }
  // appbar nav buttons
  dom.appPrev.addEventListener('click', ()=>{ state.payPeriodOffset=(state.payPeriodOffset||0)-1; saveState(); renderHome(); });
  dom.appNext.addEventListener('click', ()=>{ state.payPeriodOffset=(state.payPeriodOffset||0)+1; saveState(); renderHome(); });
  // upcoming list actions
  dom.upcomingList.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-act]'); if(!btn) return;
    const act = btn.getAttribute('data-act'), id=btn.getAttribute('data-id'), typ=btn.getAttribute('data-type');
    if (act==='del'){
      if (!confirm('Delete this scheduled item?')) return;
      if (typ==='income') state.incomes = state.incomes.filter(x=>x.id!==id);
      else state.expenses = state.expenses.filter(x=>x.id!==id);
      saveState(); renderHome(); renderTransactions(); renderCalendar(); toast('Scheduled item deleted');
    } else if (act==='paid'){
      if (typ==='income'){
        const it = state.incomes.find(x=>x.id===id); if(!it) return;
        const posted = toISO(new Date());
        state.incomes = state.incomes.filter(x=>x.id!==id);
        state.incomes.push({id:uid(), date:posted, source:it.source||'Income', amount:Number(it.amount||0), scheduled:false, updatedAt:nowIso()});
        saveState(); renderHome(); renderTransactions(); renderCalendar(); toast('Marked paid');
      } else {
        const it = state.expenses.find(x=>x.id===id); if(!it) return;
        const next = prompt('Confirm amount for payment (you can adjust):', (Number(it.amount||0).toFixed(2)));
        if (next===null) return;
        const parsed = parseAmount(next);
        if (!Number.isFinite(parsed) || parsed<0){ alert('Invalid amount'); return; }
        const posted = toISO(new Date());
        state.expenses = state.expenses.filter(x=>x.id!==id);
        state.expenses.push({id:uid(), date:posted, category:it.category||'Expense', amount:parsed, notes:it.notes||'', scheduled:false, updatedAt:nowIso()});
        saveState(); renderHome(); renderTransactions(); renderCalendar(); toast('Marked paid');
      }
    }
  });
}
function initGoals(){
  dom.newGoalBtn.addEventListener('click', ()=>openGoalModal());
  dom.goalModalClose.addEventListener('click', closeGoalModal);
  dom.goalModalCancel.addEventListener('click', closeGoalModal);
  dom.goalPriorityGroup.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-priority]'); if(!btn) return;
    dom.goalPriorityGroup.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
  });
  dom.goalModalCreate.addEventListener('click', ()=>{
    const name = dom.goalName.value.trim();
    const target = parseAmount(dom.goalTarget.value);
    const current = parseAmount(dom.goalCurrent.value || '0');
    if (!name){ alert('Goal name is required.'); return; }
    if (!Number.isFinite(target) || target<=0){ alert('Target amount must be greater than 0.'); return; }
    if (!Number.isFinite(current) || current<0){ alert('Current progress cannot be negative.'); return; }
    const priority = dom.goalPriorityGroup.querySelector('.active')?.dataset.priority || 'medium';
    const editingId = dom.goalModalCreate.dataset.editingId;
    const goalData = {
      id: editingId || uid(),
      name,
      type: dom.goalType.value,
      targetAmount: target,
      currentAmount: current,
      targetDate: dom.goalDate.value,
      monthlyContribution: parseAmount(dom.goalMonthly.value || '0'),
      priority,
      createdAt: editingId ? goals.find(g=>g.id===editingId)?.createdAt || nowIso() : nowIso()
    };
    if (editingId){
      goals = goals.map(g=>g.id===editingId ? goalData : g);
    } else {
      goals.push(goalData);
    }
    saveGoals();
    closeGoalModal();
    renderGoals();
    renderInsights();
  });
  dom.goalsGrid.addEventListener('click', (e)=>{
    const action = e.target.closest('[data-goal-action]'); if(!action) return;
    const id = action.getAttribute('data-id');
    const goal = goals.find(g=>g.id===id);
    if (!goal) return;
    const act = action.getAttribute('data-goal-action');
    if (act==='delete'){
      if (!confirm('Delete this goal?')) return;
      goals = goals.filter(g=>g.id!==id);
      saveGoals();
      renderGoals();
      renderInsights();
    }
    if (act==='edit'){
      openGoalModal(goal);
    }
    if (act==='log'){
      const input = prompt('Log contribution amount:', '0');
      if (input===null) return;
      const amt = parseAmount(input);
      if (!Number.isFinite(amt) || amt<=0){ alert('Enter a valid amount.'); return; }
      goal.currentAmount = Number(goal.currentAmount||0) + amt;
      saveGoals();
      renderGoals();
      renderInsights();
    }
  });
}
function initInsights(){
  dom.insightsTabs.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const tab = btn.getAttribute('data-insights-tab');
      setInsightsTab(tab);
    });
  });
  dom.whatIfExtra.addEventListener('input', updateWhatIf);
  dom.whatIfHorizon.addEventListener('input', updateWhatIf);
  setInsightsTab('weekly');
}
function initTxnModal(){
  dom.txnModalClose.addEventListener('click', closeTxnModal);
  dom.txnModalCancel.addEventListener('click', closeTxnModal);
  dom.txnTypeSwitch.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-txn-type]'); if(!btn) return;
    dom.txnTypeSwitch.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const type = btn.dataset.txnType;
    dom.txnCategoryWrap.style.display = type==='expense' ? '' : 'none';
  });
  dom.txnModalAdd.addEventListener('click', ()=>{
    const activeBtn = dom.txnTypeSwitch.querySelector('button.active');
    const type = activeBtn?.dataset.txnType || 'expense';
    const amt = parseAmount(dom.txnAmount.value);
    if (!Number.isFinite(amt) || amt<=0){ alert('Enter a valid amount.'); return; }
    const desc = dom.txnDesc.value.trim();
    const date = dom.txnDate.value || todayStr();
    const scheduled = dom.txnRecurring.checked;
    if (type==='income'){
      state.incomes.push({
        id: uid(),
        date,
        source: desc || 'Income',
        amount: amt,
        scheduled,
        updatedAt: nowIso()
      });
      saveState();
      renderHome(); renderTransactions();
      toast('Income added');
    } else {
      const category = dom.txnCategory.value || 'Other';
      state.expenses.push({
        id: uid(),
        date,
        category,
        amount: amt,
        notes: desc,
        scheduled,
        templateId: null,
        updatedAt: nowIso()
      });
      saveState();
      renderHome(); renderTransactions();
      toast('Expense added');
    }
    closeTxnModal();
  });
}
function initTransactions(){
  function onFilterChange(){
    const sel = dom.filterRange.value;
    const showCustom = sel==='custom';
    dom.customStart.style.display = showCustom ? '' : 'none';
    dom.customEnd.style.display = showCustom ? '' : 'none';
    dom.toSpan.style.display = showCustom ? '' : 'none';
    renderTransactions();
  }
  dom.filterRange.addEventListener('change', onFilterChange);
  dom.customStart.addEventListener('change', renderTransactions);
  dom.customEnd.addEventListener('change', renderTransactions);
  dom.payFreq.addEventListener('change', ()=>{ state.settings.payFreq = dom.payFreq.value; saveState(); renderHome(); });
  dom.seedPayday.addEventListener('change', ()=>{ state.settings.seedPayday = dom.seedPayday.value; saveState(); renderHome(); });

  // collapse toggle
  dom.toggleFilters.addEventListener('click', ()=>{
    const collapsed = !dom.filtersCard.classList.contains('collapsed');
    dom.filtersCard.classList.toggle('collapsed', collapsed);
    dom.toggleFilters.textContent = collapsed ? 'Expand' : 'Collapse';
    dom.toggleFilters.setAttribute('aria-expanded', String(!collapsed));
  });

  // Income form
  dom.incomeForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    const date=dom.incomeDate.value||todayStr();
    const source=dom.incomeSource.value.trim();
    const amt=parseAmount(dom.incomeAmount.value);
    const scheduled= !!dom.incomeScheduled.checked;
    if(!Number.isFinite(amt)||amt<0){ dom.incomeAmountErr.style.display='block'; return; } else dom.incomeAmountErr.style.display='none';
    if (editingIncomeId){
      const idx = state.incomes.findIndex(x=>x.id===editingIncomeId);
      if (idx>=0){ state.incomes[idx]={...state.incomes[idx], date, source, amount:amt, scheduled, updatedAt:nowIso()}; }
      else { state.incomes.push({id:editingIncomeId, date, source, amount:amt, scheduled, updatedAt:nowIso()}); }
      saveState(); clearIncomeForm(); renderTransactions(); renderHome(); toast('Income updated');
    } else {
      state.incomes.push({id:uid(), date, source, amount:amt, scheduled, updatedAt:nowIso()});
      saveState(); clearIncomeForm(); renderTransactions(); renderHome(); toast('Income added');
    }
  });
  dom.incomeCancelEdit.addEventListener('click', ()=>{ clearIncomeForm(); });
  dom.incomeTbody.addEventListener('click', (e)=>{
    const btn=e.target.closest('button[data-action]'); if(!btn) return;
    const id=btn.getAttribute('data-id'); const action=btn.getAttribute('data-action');
    const it = state.incomes.find(x=>x.id===id);
    if(action==='edit-income' && it){
      dom.incomeDate.value=it.date||todayStr();
      dom.incomeSource.value=it.source||'';
      dom.incomeAmount.value=Number(it.amount||0).toFixed(2);
      dom.incomeScheduled.checked = !!it.scheduled;
      editingIncomeId=id;
      dom.incomeSubmitBtn.textContent='Save Income';
    }else if(action==='del-income'){
      if(confirm('Delete this income item?')){
        state.incomes=state.incomes.filter(x=>x.id!==id);
        if (editingIncomeId===id){ clearIncomeForm(); }
        saveState(); renderTransactions(); renderHome(); toast('Income deleted');
      }
    }
  });

  // Expense form
  dom.expenseForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    const date=dom.expenseDate.value||todayStr();
    const selected=dom.expenseCategory.value;
    const custom=dom.expenseCategoryCustom.value.trim();
    const category=custom||selected;
    const amt=parseAmount(dom.expenseAmount.value);
    const notes=dom.expenseNotes.value.trim();
    const scheduled= !!dom.expenseScheduled.checked;
    if(!Number.isFinite(amt)||amt<0){ dom.expenseAmountErr.style.display='block'; return; } else dom.expenseAmountErr.style.display='none';
    if (editingExpenseId){
      const idx = state.expenses.findIndex(x=>x.id===editingExpenseId);
      if (idx>=0){
        state.expenses[idx]={...state.expenses[idx], date, category, amount:amt, notes, scheduled, updatedAt:nowIso()};
      } else {
        state.expenses.push({id:editingExpenseId, date, category, amount:amt, notes, scheduled, templateId:null, updatedAt:nowIso()});
      }
      saveState(); clearExpenseForm(); renderTransactions(); renderHome(); toast('Expense updated');
    } else {
      state.expenses.push({id:uid(), date, category, amount:amt, notes, scheduled, templateId:null, updatedAt:nowIso()});
      saveState(); clearExpenseForm(); renderTransactions(); renderHome(); toast('Expense added');
    }
  });
  dom.expenseCancelEdit.addEventListener('click', ()=>{ clearExpenseForm(); });
  dom.expenseTbody.addEventListener('click', (e)=>{
    const btn=e.target.closest('button[data-action]'); if(!btn) return;
    const id=btn.getAttribute('data-id'); const action=btn.getAttribute('data-action');
    const it = state.expenses.find(x=>x.id===id);
    if(action==='edit-expense' && it){
      dom.expenseDate.value=it.date||todayStr();
      const opts=Array.from(dom.expenseCategory.options).map(o=>o.value);
      if(opts.includes(it.category)){ dom.expenseCategory.value=it.category; dom.expenseCategoryCustom.value=''; }
      else { dom.expenseCategory.value='Other'; dom.expenseCategoryCustom.value=it.category||''; }
      dom.expenseAmount.value=Number(it.amount||0).toFixed(2);
      dom.expenseNotes.value=it.notes||'';
      dom.expenseScheduled.checked = !!it.scheduled;
      editingExpenseId=id;
      dom.expenseSubmitBtn.textContent='Save Expense';
    }else if(action==='del-expense'){
      if(confirm('Delete this expense item?')){
        state.expenses=state.expenses.filter(x=>x.id!==id);
        if (editingExpenseId===id){ clearExpenseForm(); }
        saveState(); renderTransactions(); renderHome(); toast('Expense deleted');
      }
    }
  });
}

/* Templates tab (unchanged render/handlers from 1.3.0)‚Ä¶ */
let editingIncomeId=null;
let editingExpenseId=null;
let editingTplId=null;
function showTplAnchors(){ const f=dom.tplFreq.value; byId('anchWeekly').classList.toggle('hide', f!=='weekly'); byId('anchBiweekly').classList.toggle('hide', f!=='biweekly'); byId('anchMonthly').classList.toggle('hide', f!=='monthly'); }
function renderTemplates(){
  if (!state.templates.length){ dom.tplList.innerHTML='<div class="muted">No templates yet.</div>'; return; }
  dom.tplList.innerHTML = state.templates.map(t=>`
    <div style="display:flex; justify-content:space-between; gap:8px; padding:8px 0; border-bottom:1px solid #1a2030">
      <div><strong>${escapeHtml(t.label)}</strong> ‚Äî ${formatCurrency(t.amount)} ‚Ä¢ ${escapeHtml(t.freq)} ${t.freq==='weekly'?('( '+['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][t.weekday??0]+' )'):''}
        ${t.freq==='biweekly'?('( seed '+escapeHtml(t.seedDate||t.startDate||'')+' )'):''}
        ${t.freq==='monthly'?('( day '+(t.day||1)+' )'):''}
        <div class="muted">Start: ${escapeHtml(t.startDate||'‚Äî')} ${t.notes?('‚Ä¢ '+escapeHtml(t.notes)) : ''}</div>
      </div>
      <div class="actions" style="align-items:center">
        <label class="muted" style="display:flex; gap:6px; align-items:center">Active <input type="checkbox" data-tpl="toggle" data-id="${t.id}" ${t.active===false?'':'checked'}></label>
        <button class="btn btn-ghost" data-tpl="edit" data-id="${t.id}">Edit</button>
        <button class="btn btn-danger" data-tpl="del" data-id="${t.id}">Delete</button>
      </div>
    </div>`).join('');
}
function clearTplForm(){ editingTplId=null; dom.tplLabel.value=''; dom.tplAmount.value=''; dom.tplFreq.value='monthly'; dom.tplWeekday.value='0'; dom.tplSeedDate.value=''; dom.tplMonthDay.value='1'; dom.tplStart.value=''; dom.tplNotes.value=''; showTplAnchors(); }
function initTemplates(){
  showTplAnchors();
  dom.tplFreq.addEventListener('change', showTplAnchors);
  dom.tplCancel.addEventListener('click', clearTplForm);
  dom.tplForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    const label=dom.tplLabel.value.trim();
    const amount=parseAmount(dom.tplAmount.value);
    const freq=dom.tplFreq.value;
    const weekday=Number(dom.tplWeekday.value);
    const seedDate=dom.tplSeedDate.value||null;
    const day=Number(dom.tplMonthDay.value||1);
    const startDate=dom.tplStart.value||todayStr();
    const notes=dom.tplNotes.value.trim();
    if (!label || !Number.isFinite(amount) || amount<0){ dom.tplErr.style.display='block'; setTimeout(()=>dom.tplErr.style.display='none',1500); return; }
    if (editingTplId){
      const i=state.templates.findIndex(t=>t.id===editingTplId);
      if (i>=0){ const old=state.templates[i];
        state.templates[i]={...old, label, amount, freq, weekday, seedDate, day, startDate, notes, active:(old.active!==false), updatedAt:nowIso()};
      }
      toast('Template updated');
    } else {
      state.templates.push({id:uid(), label, amount, freq, weekday, seedDate, day, startDate, notes, active:true, updatedAt:nowIso()});
      toast('Template added');
    }
    saveState(); clearTplForm(); renderTemplates(); renderHome(); renderCalendar();
  });
  dom.tplList.addEventListener('click', (e)=>{
    const btn=e.target.closest('button, input[type="checkbox"]'); if(!btn) return;
    const id=btn.getAttribute('data-id'); const act=btn.getAttribute('data-tpl');
    const i=state.templates.findIndex(t=>t.id===id); if(i<0) return;
    if (act==='edit'){
      const t=state.templates[i]; editingTplId=id;
      dom.tplLabel.value=t.label||''; dom.tplAmount.value=Number(t.amount||0).toFixed(2);
      dom.tplFreq.value=t.freq||'monthly'; dom.tplWeekday.value=String(t.weekday??0);
      dom.tplSeedDate.value=t.seedDate||''; dom.tplMonthDay.value=String(t.day||1);
      dom.tplStart.value=t.startDate||todayStr(); dom.tplNotes.value=t.notes||'';
      showTplAnchors();
    } else if (act==='del'){
      if (!confirm('Delete this template?')) return;
      state.templates.splice(i,1);
      state.expenses = state.expenses.filter(x=>x.templateId!==id || !x.scheduled);
      saveState(); renderTemplates(); renderCalendar(); renderHome(); toast('Template deleted');
    } else if (act==='toggle'){
      state.templates[i].active = btn.checked;
      saveState(); renderTemplates(); renderCalendar(); renderHome(); toast(btn.checked?'Template enabled':'Template disabled');
    }
  });
}

/* ====== Tools: Export/Import/CSV/Reset & Calcs ====== */
function initTools(){
  dom.exportBtn.addEventListener('click', ()=>{
    const blob=new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download=`budget-export-v131-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); toast('Exported JSON');
  });
  dom.importFile.addEventListener('change', async (e)=>{
    const file=e.target.files[0]; if(!file) return;
    try{ const text=await file.text(); const obj=JSON.parse(text);
      if(!obj || !Array.isArray(obj.incomes) || !Array.isArray(obj.expenses)) throw new Error('Invalid format');
      state={
        version: obj.version||'1.3.1',
        settings: obj.settings||state.settings,
        payPeriodOffset: obj.payPeriodOffset||0,
        incomes: obj.incomes.map(x=>({...x, scheduled: !!x.scheduled, updatedAt:x.updatedAt||nowIso()})),
        expenses: obj.expenses.map(x=>({...x, scheduled: !!x.scheduled, updatedAt:x.updatedAt||nowIso()})),
        templates: Array.isArray(obj.templates)? obj.templates : (state.templates||[]),
        lastImportBatch: null,
        sync: obj.sync || state.sync
      };
      saveState(); renderHome(); renderTransactions(); renderCalendar(); renderTemplates(); toast('Imported data');
    }catch(err){ alert('Import failed: '+(err.message||err)); } finally { e.target.value=''; }
  });

  // calculators
  dom.whatIfNumber.addEventListener('input', ()=>{
    const actualRange = {start: new Date('1970-01-01'), end: new Date()}; actualRange.end.setHours(0,0,0,0);
    const {net:actualNet} = totalsForRange(actualRange); const whatIf = Number(dom.whatIfNumber.value||0);
    dom.projectedBalance.textContent = formatCurrency(actualNet - whatIf);
  });
  dom.calcAmount.addEventListener('input', ()=>{
    const actualRange = {start: new Date('1970-01-01'), end: new Date()}; actualRange.end.setHours(0,0,0,0);
    const {net:actualNet} = totalsForRange(actualRange); const planned = parseAmount(dom.calcAmount.value);
    dom.calcResult.textContent = formatCurrency(actualNet - (Number.isFinite(planned)?planned:0));
  });

  // Reset
  dom.resetBtn.addEventListener('click', ()=>{
    if (!confirm('Erase ALL incomes/expenses (keep settings & templates)?')) return;
    const settings = state.settings, templates=state.templates, sync=state.sync;
    state = { version:'1.3.1', settings, payPeriodOffset:0, incomes:[], expenses:[], templates, lastImportBatch:null, sync };
    saveState();
    renderHome(); renderTransactions(); renderCalendar(); renderTemplates();
    toast('All transactions cleared');
  });

  // CSV
  dom.csvFile.addEventListener('change', handleCsvFile);
  dom.csvClose.addEventListener('click', closeCsvModal);
  dom.csvImportBtn.addEventListener('click', importCsvMapped);
  dom.amountMode.addEventListener('change', updateAmountModeUI);
  dom.undoImportBtn.addEventListener('click', undoLastImport);
}

/* ====== CSV support (v1.3.1 DC fix) ====== */
let _csvData = { headers:[], rows:[] };
function handleCsvFile(e){
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload = () => {
    const text=reader.result;
    const parsed=parseCSV(text);
    if (!parsed.headers.length){ alert('Could not read CSV headers.'); return; }
    _csvData=parsed;
    openCsvModal(parsed);
  };
  reader.readAsText(file);
  e.target.value='';
}
function parseCSV(text){
  const rows=[]; let cur='', inQ=false; let row=[];
  for (let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if (inQ){
      if (c==='\"' && n==='\"'){ cur+='\"'; i++; }
      else if (c==='\"'){ inQ=false; }
      else cur+=c;
    }else{
      if (c==='\"'){ inQ=true; }
      else if (c===',' ){ row.push(cur); cur=''; }
      else if (c==='\n' || c==='\r'){ if (cur!=='' || row.length){ row.push(cur); rows.push(row); row=[]; cur=''; } }
      else cur+=c;
    }
  }
  if (cur!=='' || row.length){ row.push(cur); rows.push(row); }
  const headers = (rows.shift()||[]).map(h=>h.trim());
  return { headers, rows };
}
function openCsvModal(parsed){
  const H=parsed.headers;
  fillSelect(dom.mapDate, H, guessHeader(H, ['post date','date','effective date']));
  fillSelect(dom.mapDesc, H, guessHeader(H, ['transaction description','description','memo','details']));
  fillSelect(dom.mapAmount, H, guessHeader(H, ['amount','transaction amount']));
  fillSelect(dom.mapDebit, H, guessHeader(H, ['debit']));
  fillSelect(dom.mapCredit, H, guessHeader(H, ['credit']));
  dom.amountMode.value = autoAmountMode(H);
  updateAmountModeUI();
  dom.csvHead.innerHTML = H.map(h=>`<th>${escapeHtml(h||'')}</th>`).join('');
  const max= Math.min(20, parsed.rows.length);
  dom.csvBody.innerHTML = parsed.rows.slice(0,max).map(r=>`<tr>${H.map((_,i)=>`<td>${escapeHtml(r[i]||'')}</td>`).join('')}</tr>`).join('');
  dom.csvModal.style.display='flex';
}
function closeCsvModal(){ dom.csvModal.style.display='none'; _csvData={headers:[],rows:[]}; }
function fillSelect(sel, headers, selected){
  sel.innerHTML = headers.map(h=>`<option value="${escapeHtml(h)}">${escapeHtml(h)}</option>`).join('');
  if (selected && headers.includes(selected)) sel.value=selected;
}
function guessHeader(headers, candidates){
  const lower=headers.map(h=>h.toLowerCase());
  for (const c of candidates){
    const idx=lower.indexOf(c);
    if (idx>=0) return headers[idx];
    const foundIdx=lower.findIndex(h=>h.includes(c));
    if (foundIdx>=0) return headers[foundIdx];
  }
  return headers[0]||'';
}
function autoAmountMode(H){
  const lower=H.map(h=>h.toLowerCase());
  if (lower.some(h=>h.includes('debit')) && lower.some(h=>h.includes('credit'))) return 'dc';
  if (lower.some(h=>h.includes('amount'))) return 'signed';
  return 'auto';
}
function updateAmountModeUI(){
  const mode=dom.amountMode.value;
  byId('amountRowSigned').style.display = (mode==='signed' || mode==='auto') ? '' : 'none';
  byId('amountRowDC').style.display = (mode==='dc') ? '' : 'none';
}
function importCsvMapped(){
  const H=_csvData.headers, rows=_csvData.rows;
  if (!H.length){ alert('No CSV loaded'); return; }
  const hDate = dom.mapDate.value, hDesc=dom.mapDesc.value;
  const mode = (dom.amountMode.value==='auto') ? autoAmountMode(H) : dom.amountMode.value;
  const idsImported=[];
  let count=0;
  for (const r of rows){
    const map = Object.create(null);
    H.forEach((h,i)=> map[h]=r[i]||'');
    const desc = String(map[hDesc]||'').trim();
    if (/beginning balance/i.test(desc)) continue;

    let dstr = String(map[hDate]||'').trim();
    if (!dstr) continue;
    const dtry = new Date(dstr);
    if (isNaN(dtry.getTime())) continue;
    const iso = toISO(dtry);

    let amt = 0;
    if (mode==='dc'){
      // NEW: treat Debit as absolute outflow; support negative debits
      let debit = parseAmount(map[dom.mapDebit.value]);
      let credit = parseAmount(map[dom.mapCredit.value]);
      const d = Number.isFinite(debit) ? Math.abs(debit) : (dom.treatBlankAsZero.value==='yes'?0:NaN);
      const c = Number.isFinite(credit) ? credit : (dom.treatBlankAsZero.value==='yes'?0:NaN);
      if (!Number.isFinite(d) && !Number.isFinite(c)) continue;
      const dd = Number.isFinite(d)?d:0, cc=Number.isFinite(c)?c:0;
      amt = cc - dd; // positive=income, negative=expense
    } else {
      let a = parseAmount(map[dom.mapAmount.value]);
      if (!Number.isFinite(a)) continue;
      if (dom.invertSign.value==='yes') a = -a;
      amt = a;
    }

    if (amt === 0) continue;
    if (amt > 0){
      const id=uid();
      state.incomes.push({id, date:iso, source:desc||'Import', amount:amt, scheduled:false, updatedAt:nowIso()});
      idsImported.push(id);
    } else {
      const id=uid();
      state.expenses.push({id, date:iso, category:'Imported', amount:Math.abs(amt), notes:desc||'', scheduled:false, updatedAt:nowIso()});
      idsImported.push(id);
    }
    count++;
  }
  state.lastImportBatch = { ids: idsImported, ts: Date.now() };
  saveState(); renderHome(); renderTransactions(); renderCalendar(); closeCsvModal();
  dom.undoImportBtn.disabled = idsImported.length===0;
  toast(`Imported ${count} rows`);
}
function undoLastImport(){
  const batch = state.lastImportBatch;
  if (!batch || !Array.isArray(batch.ids) || !batch.ids.length) return;
  const set=new Set(batch.ids);
  const b1=state.incomes.length, b2=state.expenses.length;
  state.incomes = state.incomes.filter(x=>!set.has(x.id));
  state.expenses = state.expenses.filter(x=>!set.has(x.id));
  const removed=(b1-state.incomes.length)+(b2-state.expenses.length);
  state.lastImportBatch=null;
  saveState(); renderHome(); renderTransactions(); renderCalendar(); toast(`Undid ${removed} imported rows`);
}

/* ====== Sync (updated for 1.3.1) ====== */
async function deriveKey(pass, salt){
  const enc=new TextEncoder();
  const keyMaterial=await crypto.subtle.importKey('raw', enc.encode(pass), {name:'PBKDF2'}, false, ['deriveKey']);
  return crypto.subtle.deriveKey({name:'PBKDF2', salt, iterations:120000, hash:'SHA-256'}, keyMaterial, {name:'AES-GCM', length:256}, true, ['encrypt','decrypt']);
}
async function encryptJSON(obj, pass, saltHex){
  const enc=new TextEncoder();
  const salt = saltHex ? Uint8Array.from(saltHex.match(/.{1,2}/g).map(b=>parseInt(b,16))) : crypto.getRandomValues(new Uint8Array(16));
  const key=await deriveKey(pass, salt);
  const iv=crypto.getRandomValues(new Uint8Array(12));
  const data=enc.encode(JSON.stringify(obj));
  const ct= new Uint8Array(await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, data));
  function hex(buf){return Array.from(buf).map(b=>b.toString(16).padStart(2,'0')).join('')}
  return { salt: hex(salt), iv: hex(iv), ct: btoa(String.fromCharCode(...ct)) };
}
async function decryptJSON(payload, pass){
  const dec=new TextDecoder();
  function fromHex(h){return new Uint8Array(h.match(/.{1,2}/g).map(b=>parseInt(b,16)))}
  const salt=fromHex(payload.salt), iv=fromHex(payload.iv);
  const key=await deriveKey(pass, salt);
  const ctBytes=Uint8Array.from(atob(payload.ct), c=>c.charCodeAt(0));
  const pt= await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ctBytes);
  return JSON.parse(dec.decode(pt));
}
async function gistRequest(method, path, token, body){
  const res = await fetch(`https://api.github.com${path}`, {
    method, headers: { 'Authorization': `token ${token}`, 'Accept':'application/vnd.github+json' },
    body: body? JSON.stringify(body): undefined
  });
  if (!res.ok) throw new Error(`${method} ${path} ‚Üí ${res.status}`);
  return res.json();
}
async function createGist(token){
  const body = { description:'Budget App Sync (encrypted)', public:false, files: { 'budget.enc': { content: JSON.stringify({note:'init'}) } } };
  const js = await gistRequest('POST','/gists', token, body);
  return js.id;
}
async function pullSync(gistId, token){
  const js = await gistRequest('GET', `/gists/${gistId}`, token);
  const file = js.files && (js.files['budget.enc'] || Object.values(js.files)[0]);
  if (!file || !file.content) throw new Error('No sync file found');
  return JSON.parse(file.content);
}
async function pushSync(gistId, token, content){
  const body={ files: { 'budget.enc': { content: JSON.stringify(content) } } };
  await gistRequest('PATCH', `/gists/${gistId}`, token, body);
}
function initSync(){
  dom.syncId.value = state.sync.gistId||'';
  dom.syncToken.value = state.sync.token||'';
  dom.syncPass.value = '';
  dom.btnSyncNow.disabled = !(state.sync.gistId && state.sync.token);

  byId('btnCreateGist').addEventListener('click', async ()=>{
    try{
      const token = dom.syncToken.value.trim();
      if (!token){ alert('Enter your GitHub token with gist scope.'); return;}
      const id = await createGist(token);
      dom.syncId.value = id; toast('Created sync');
    }catch(e){ alert('Create failed: '+e.message); }
  });
  byId('btnConnect').addEventListener('click', ()=>{
    const id=dom.syncId.value.trim(), token=dom.syncToken.value.trim(), pass=dom.syncPass.value.trim();
    if (!id || !token || !pass){ alert('Enter Sync ID, Token, and Passphrase.'); return; }
    if (!state.sync.keySalt) state.sync.keySalt = Array.from(crypto.getRandomValues(new Uint8Array(16))).map(b=>b.toString(16).padStart(2,'0')).join('');
    state.sync.gistId = id; state.sync.token = token; state.sync.passHint = `len:${pass.length}`; saveState();
    dom.btnSyncNow.disabled=false; toast('Connected to sync');
  });
  byId('btnSignOut').addEventListener('click', ()=>{
    state.sync = { provider:null, gistId:null, token:null, keySalt:null, passHint:null, lastRev:0 };
    saveState(); dom.syncId.value=''; dom.syncToken.value=''; dom.syncPass.value=''; dom.btnSyncNow.disabled=true; toast('Signed out of sync');
  });
  byId('btnSyncNow').addEventListener('click', async ()=>{
    const id=state.sync.gistId, token=state.sync.token, pass=dom.syncPass.value.trim();
    if (!id || !token || !pass){ alert('Enter Sync ID/Token and Passphrase.'); return; }
    try{
      let remoteRaw; try{ remoteRaw = await pullSync(id, token); }catch(e){ remoteRaw=null; }
      let remote = null; if (remoteRaw && remoteRaw.ct){ remote = await decryptJSON(remoteRaw, pass); } else if (remoteRaw && remoteRaw.note==='init'){ remote = null; }
      let merged = JSON.parse(JSON.stringify(state));
      if (remote){
        function upsert(local, incoming, key='id'){
          const map=new Map(local.map(i=>[i[key], i]));
          for (const r of (incoming||[])){
            const l=map.get(r[key]); const tL=new Date(l?.updatedAt||0).getTime(); const tR=new Date(r.updatedAt||0).getTime();
            if (!l || tR>tL) map.set(r[key], r);
          }
          return Array.from(map.values());
        }
        merged.incomes = upsert(merged.incomes||[], remote.incomes||[]);
        merged.expenses = upsert(merged.expenses||[], remote.expenses||[]);
        merged.templates = upsert(merged.templates||[], remote.templates||[]);
        const tL=new Date((state.syncUpdatedAt||state.versionDate||0)).getTime();
        const tR=new Date((remote.syncUpdatedAt||remote.versionDate||0)).getTime();
        if (tR>tL) merged.settings = remote.settings||merged.settings;
      }
      merged.version='1.3.1'; merged.syncUpdatedAt=nowIso();
      const payload = await encryptJSON(merged, pass, state.sync.keySalt||null);
      await pushSync(id, token, payload);
      state = merged; saveState();
      renderHome(); renderTransactions(); renderCalendar(); renderTemplates();
      toast('Synced');
    }catch(e){ alert('Sync failed: '+e.message); }
  });
}

/* ====== Helpers & Init ====== */
function clearIncomeForm(){ editingIncomeId=null; dom.incomeDate.value=todayStr(); dom.incomeSource.value=''; dom.incomeAmount.value=''; dom.incomeScheduled.checked=false; dom.incomeAmountErr.style.display='none'; dom.incomeSubmitBtn.textContent='Add Income'; }
function clearExpenseForm(){ editingExpenseId=null; dom.expenseDate.value=todayStr(); dom.expenseCategory.value='Housing'; dom.expenseCategoryCustom.value=''; dom.expenseAmount.value=''; dom.expenseNotes.value=''; dom.expenseScheduled.checked=false; dom.expenseAmountErr.style.display='none'; dom.expenseSubmitBtn.textContent='Add Expense'; }

function init(){
  dom.incomeDate.value = todayStr(); dom.expenseDate.value = todayStr();
  dom.appbarNav.style.display=''; // visible on home initially
  dom.payFreq.value = state.settings.payFreq||'biweekly';
  dom.seedPayday.value = toISO(state.settings.seedPayday||todayStr());

  initTabs(); initHome(); initGoals(); initInsights(); initTxnModal(); initTransactions(); initCalendar(); initTemplates(); initTools(); initSync();
  renderHome(); renderGoals(); renderInsights(); renderTransactions();
}
init();
</script>
</body>
</html>
