<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>My Budget v1.3.1</title>
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#0b0e13" />
<link rel="icon" href="./icon-192.png" sizes="192x192">
<link rel="apple-touch-icon" href="./icon-192.png">
<!--
v1.3.1 changes:
- CSV: Debit/Credit mode now treats Debit as ABS(outflow). Works even if your bank exports negative debits. One-pass import + Undo.
- Home: pay-period navigation moved to the sticky top app bar.
- Transactions: Filters card is collapsible to free vertical space.
- Calendar: today is highlighted.
- Export JSON remains in Tools (not on Home).

Notes:
- Storage key remains the same (simple_budget_v11) to preserve data.
- Safe-to-Spend (conservative): Net actuals up to today minus scheduled bills until next payday.
-->
<style>
  :root{
    --bg:#0b0e13; --card:#121722; --muted:#8fa1b3; --text:#e6edf3;
    --accent:#4aa3ff; --accent-2:#6fe3b7; --danger:#ff6b6b; --ok:#58d68d;
    --border:#1f2633; --shadow:0 8px 24px rgba(0,0,0,.3); --radius:16px;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    background: radial-gradient(1200px 600px at 20% -10%, #132033 0%, #0b0e13 50%) no-repeat, var(--bg); color:var(--text);}
  .wrap{max-width:1200px; margin:0 auto; padding:18px}
  header.appbar{position:sticky; top:0; z-index:5; background:linear-gradient(180deg, rgba(11,14,19,.96), rgba(11,14,19,.85));
    backdrop-filter: blur(6px); padding:12px 16px; border-bottom:1px solid var(--border); display:flex; gap:12px; align-items:center; justify-content:space-between}
  .tabs{display:flex; gap:8px; flex-wrap:wrap}
  .tab{padding:8px 12px; border:1px solid var(--border); background:#0f1420; border-radius:10px; cursor:pointer}
  .tab.active{background:linear-gradient(90deg, #2a86f3, #1ec9a5); color:#041018; border:none}
  .header-right{display:flex; gap:8px; align-items:center}
  .nav-btn{background:#0a0f17;border:1px solid #273046;border-radius:999px;padding:6px 10px;cursor:pointer}
  .pill{padding:8px 12px; border:1px solid var(--border); border-radius:999px; background:#0f1420; box-shadow:var(--shadow); display:inline-flex; gap:8px; align-items:center}
  .pill strong{font-variant-numeric: tabular-nums}
  .net{background: linear-gradient(90deg, rgba(74,163,255,.15), rgba(111,227,183,.15)); border-color:#233044}
  .safe{background: linear-gradient(90deg, rgba(111,227,183,.22), rgba(111,227,183,.05)); border-color:#244238}
  .safe.negative{background: linear-gradient(90deg, rgba(255,107,107,.20), rgba(255,107,107,.06)); border-color:#4a1f20}
  .grid{display:grid; gap:16px; grid-template-columns:1.15fr 1.15fr .95fr}
  @media (max-width: 1020px){ .grid{grid-template-columns:1fr} }
  .card{background:linear-gradient(180deg, #0f1522, #0c1018); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); margin-top:12px}
  .card h2{margin:0; padding:14px; border-bottom:1px solid var(--border); font-size:1.05rem; color:#cfe1ff; display:flex; align-items:center; justify-content:space-between}
  .section-body{padding:14px}
  .card.collapsed .section-body{display:none}
  .chev{background:#0a0f17;border:1px solid #273046;border-radius:10px;padding:6px 8px;cursor:pointer}
  fieldset{border:1px dashed #273046; padding:12px; border-radius:12px; margin:0 0 12px}
  legend{color:var(--muted); padding:0 8px; font-size:.9rem}
  label{display:block; font-size:.9rem; color:#bcd; margin-bottom:6px}
  input, select, button, textarea{width:100%; padding:9px 10px; border-radius:10px; border:1px solid #273046; background:#0a0f17; color:var(--text); font-size:.95rem}
  input[type="number"]{font-variant-numeric: tabular-nums}
  textarea{min-height:64px; resize:vertical}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .row-3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}
  .actions{display:flex; gap:10px; margin-top:8px} .btn{cursor:pointer} .btn-ghost{background:#0a0f17; border:1px solid #273046}
  .btn-primary{background:linear-gradient(90deg, #2a86f3, #1ec9a5); border:none}
  .btn-danger{background:#2a1010; border:1px solid #512020; color:#ffd5d5}
  .badges{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .badge{background:#0a0f17; border:1px solid #273046; border-radius:999px; padding:6px 10px; font-variant-numeric: tabular-nums; color:#cfe1ff}
  table{width:100%; border-collapse:collapse; border:1px solid var(--border); border-radius:10px; overflow:hidden}
  thead th{background:#0a0f17; color:#a8bdd6; text-align:left; font-weight:600; padding:8px; border-bottom:1px solid var(--border)}
  tbody td{padding:8px; border-bottom:1px solid #1a2030; vertical-align:top}
  tbody tr:hover{background:#111722}
  .right{text-align:right} .muted{color:#9fb2cc; font-size:.9rem}
  .toast{position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#101726; color:#def; border:1px solid #273046; border-radius:12px; padding:10px 14px; box-shadow:var(--shadow); z-index:50; opacity:0; pointer-events:none; transition:opacity .2s ease, transform .2s ease}
  .toast.show{opacity:1; pointer-events:auto; transform:translateX(-50%) translateY(-6px)}
  .mini-help{font-size:.85rem; color:#9fb2cc; margin-top:8px}
  .filters{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .filters select, .filters input[type="date"]{width:auto}
  .upcoming-list{max-height:200px; overflow:auto; border:1px dashed #273046; border-radius:10px; padding:8px}
  .summary-row{display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:8px}
  /* Calendar */
  .cal-wrap{display:grid; grid-template-rows:auto 1fr; gap:12px}
  .cal-head{display:flex; gap:8px; align-items:center; justify-content:space-between}
  .cal-grid{display:grid; grid-template-columns:repeat(7, 1fr); gap:6px}
  .cal-cell{border:1px solid var(--border); border-radius:10px; padding:6px; min-height:80px; background:#0a0f17}
  .cal-cell.out{opacity:.35}
  .cal-cell.today{border-color: var(--accent); box-shadow: inset 0 0 0 2px rgba(74,163,255,.4)}
  .cal-date{font-size:.9rem; color:#a8bdd6}
  .cal-amt{margin-top:6px; font-variant-numeric: tabular-nums; color:#ff9c9c}
  .cal-weekdays{display:grid; grid-template-columns:repeat(7,1fr); gap:6px; color:#9fb2cc; font-size:.9rem}
  .cal-total{margin-top:6px}
  .hide{display:none}
</style>
</head>
<body>
<div class="wrap">
  <header class="appbar">
    <div class="tabs" role="tablist" aria-label="Navigation">
      <button class="tab active" data-tab="home" role="tab" aria-selected="true">Home</button>
      <button class="tab" data-tab="transactions" role="tab">Transactions</button>
      <button class="tab" data-tab="calendar" role="tab">Calendar</button>
      <button class="tab" data-tab="tools" role="tab">Tools</button>
      <button class="tab" data-tab="templates" role="tab">Templates</button>
    </div>
    <div class="header-right" id="appbarNav" style="display:none">
      <button class="nav-btn" id="appPrev" title="Previous pay period">◀</button>
      <div class="badge" id="appPeriodLabel">—</div>
      <button class="nav-btn" id="appNext" title="Next pay period">▶</button>
    </div>
  </header>

  <!-- HOME -->
  <section id="tab-home">
    <div class="card">
      <h2>Overview</h2>
      <div class="section-body">
        <div class="badges">
          <div class="pill"><span class="muted">Income:</span>&nbsp;<strong id="sumIncome">$0.00</strong></div>
          <div class="pill"><span class="muted">Expenses:</span>&nbsp;<strong id="sumExpenses">$0.00</strong></div>
          <div class="pill net"><span>Net:</span>&nbsp;<strong id="sumNet">$0.00</strong></div>
          <div class="pill"><span class="muted">Projected to Payday:</span>&nbsp;<strong id="projectedToPayday">$0.00</strong></div>
          <div class="pill safe" id="safePill"><span>Safe to Spend:</span>&nbsp;<strong id="safeToSpend">$0.00</strong></div>
        </div>
        <!-- moved period nav to app bar; keep hidden header row -->
        <div class="summary-row" id="payPeriodHeader" style="display:none">
          <button class="nav-btn" id="prevPeriod" aria-label="Previous pay period">◀</button>
          <div class="badge" id="periodLabel">—</div>
          <button class="nav-btn" id="nextPeriod" aria-label="Next pay period">▶</button>
        </div>
      </div>
    </div>

    <section class="card">
      <h2>Upcoming (next 7 days)</h2>
      <div class="section-body">
        <div class="badges" style="margin-bottom:8px">
          <div class="badge">Bills: <strong id="upBills">$0.00</strong></div>
          <div class="badge">Income: <strong id="upIncome">$0.00</strong></div>
          <div class="badge">Net effect: <strong id="upNet">$0.00</strong></div>
          <div class="badge">Next payday: <strong id="nextPaydayLabel">—</strong></div>
        </div>
        <div class="upcoming-list" id="upcomingList" aria-live="polite"></div>
      </div>
    </section>

    <section class="card">
      <h2>This Week (actuals)</h2>
      <div class="section-body">
        <div class="badges">
          <div class="badge">Spent: <strong id="wkSpent">$0.00</strong></div>
          <div class="badge">Avg/day: <strong id="wkAvg">$0.00</strong></div>
          <div class="badge">Projected: <strong id="wkProj">$0.00</strong></div>
          <div class="badge" id="wkTrend">vs 4-wk avg: <strong>—</strong></div>
        </div>
      </div>
    </section>
  </section>

  <!-- TRANSACTIONS -->
  <section id="tab-transactions" class="hide">
    <div class="card collapsed" id="filtersCard">
      <h2>
        Filters
        <button type="button" class="chev" id="toggleFilters" aria-expanded="false">Expand</button>
      </h2>
      <div class="section-body">
        <div class="filters">
          <label class="muted" for="filterRange">View:</label>
          <select id="filterRange">
            <option value="all">All</option>
            <option value="thisWeek">This Week</option>
            <option value="lastWeek">Last Week</option>
            <option value="payPeriod">Current Pay Period</option>
            <option value="custom">Custom Range</option>
          </select>
          <input id="customStart" type="date" style="display:none">
          <span id="toSpan" class="muted" style="display:none">to</span>
          <input id="customEnd" type="date" style="display:none">
          <span class="muted">· Pay schedule:</span>
          <select id="payFreq">
            <option value="biweekly">Biweekly</option>
            <option value="weekly">Weekly</option>
            <option value="semimonthly">Semi-monthly (1st & 15th)</option>
            <option value="monthly">Monthly</option>
          </select>
          <label class="muted">Seed payday:</label>
          <input id="seedPayday" type="date">
        </div>
      </div>
    </div>

    <div class="grid">
      <section class="card" aria-labelledby="incomeHeading">
        <h2 id="incomeHeading">Income</h2>
        <div class="section-body">
          <form id="incomeForm" novalidate>
            <fieldset>
              <legend>Add / Edit Income</legend>
              <div class="row">
                <div>
                  <label for="incomeDate">Date</label>
                  <input id="incomeDate" name="date" type="date" required />
                  <div style="display:flex; gap:6px; align-items:center; margin-top:6px">
                    <input id="incomeScheduled" type="checkbox" />
                    <label for="incomeScheduled" class="muted">Scheduled (future)</label>
                  </div>
                </div>
                <div>
                  <label for="incomeSource">Source</label>
                  <input id="incomeSource" name="source" type="text" placeholder="Paycheck, Refund…" required />
                </div>
              </div>
              <div class="row">
                <div>
                  <label for="incomeAmount">Amount</label>
                  <input id="incomeAmount" name="amount" type="number" step="0.01" min="0" inputmode="decimal" placeholder="0.00" required />
                  <div id="incomeAmountErr" class="error">Enter a valid non-negative amount.</div>
                </div>
                <div>
                  <label>&nbsp;</label>
                  <div class="actions">
                    <button class="btn btn-primary" id="incomeSubmitBtn" type="submit">Add Income</button>
                    <button class="btn btn-ghost" id="incomeCancelEdit" type="button" style="display:none">Cancel Edit</button>
                  </div>
                </div>
              </div>
            </fieldset>
          </form>

          <div style="overflow:auto">
            <table aria-describedby="incomeHeading">
              <thead><tr><th>Date</th><th>Source</th><th>Scheduled</th><th class="right">Amount</th><th class="right">Actions</th></tr></thead>
              <tbody id="incomeTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="card" aria-labelledby="expenseHeading">
        <h2 id="expenseHeading">Expenses</h2>
        <div class="section-body">
          <form id="expenseForm" novalidate>
            <fieldset>
              <legend>Add / Edit Expense</legend>
              <div class="row-3">
                <div>
                  <label for="expenseDate">Date</label>
                  <input id="expenseDate" name="date" type="date" required />
                  <div style="display:flex; gap:6px; align-items:center; margin-top:6px">
                    <input id="expenseScheduled" type="checkbox" />
                    <label for="expenseScheduled" class="muted">Scheduled (future)</label>
                  </div>
                </div>
                <div>
                  <label for="expenseCategory">Category</label>
                  <select id="expenseCategory" name="category">
                    <option value="Housing">Housing</option>
                    <option value="Utilities">Utilities</option>
                    <option value="Food">Food</option>
                    <option value="Transport">Transport</option>
                    <option value="Debt">Debt</option>
                    <option value="Health">Health</option>
                    <option value="Entertainment">Entertainment</option>
                    <option value="Savings">Savings</option>
                    <option value="Other">Other</option>
                  </select>
                  <div class="mini-help">Or type a custom category:</div>
                  <input id="expenseCategoryCustom" type="text" placeholder="Custom category (optional)" />
                </div>
                <div>
                  <label for="expenseAmount">Amount</label>
                  <input id="expenseAmount" name="amount" type="number" step="0.01" min="0" inputmode="decimal" placeholder="0.00" required />
                  <div id="expenseAmountErr" class="error">Enter a valid non-negative amount.</div>
                </div>
              </div>
              <div class="row">
                <div>
                  <label for="expenseNotes">Notes (optional)</label>
                  <textarea id="expenseNotes" name="notes" placeholder="Short note…"></textarea>
                </div>
                <div>
                  <label>&nbsp;</label>
                  <div class="actions">
                    <button class="btn btn-primary" id="expenseSubmitBtn" type="submit">Add Expense</button>
                    <button class="btn btn-ghost" id="expenseCancelEdit" type="button" style="display:none">Cancel Edit</button>
                  </div>
                </div>
              </div>
            </fieldset>
          </form>

          <div style="overflow:auto">
            <table aria-describedby="expenseHeading">
              <thead><tr><th>Date</th><th>Category</th><th>Scheduled</th><th class="right">Amount</th><th>Notes</th><th class="right">Actions</th></tr></thead>
              <tbody id="expenseTbody"></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </section>

  <!-- CALENDAR -->
  <section id="tab-calendar" class="hide">
    <div class="card">
      <h2>Calendar (bills-only)</h2>
      <div class="section-body cal-wrap">
        <div class="cal-head">
          <div style="display:flex; gap:8px; align-items:center">
            <button class="nav-btn" id="calPrev">◀</button>
            <div class="badge" id="calLabel">—</div>
            <button class="nav-btn" id="calNext">▶</button>
          </div>
          <div class="badge cal-total">Monthly scheduled bills: <strong id="calMonthTotal">$0.00</strong></div>
        </div>
        <div class="cal-weekdays"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div>
        <div class="cal-grid" id="calGrid"></div>
        <div class="card" style="margin:0">
          <h2 id="dayDetailTitle">Selected day</h2>
          <div class="section-body" id="dayDetailBody" class="muted">Click a day to see bills.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- TOOLS -->
  <section id="tab-tools" class="hide">
    <div class="card">
      <h2>Import / Export</h2>
      <div class="section-body">
        <div class="actions">
          <button id="exportBtn" class="btn btn-ghost">Export JSON</button>
          <label for="importFile" class="btn btn-ghost" style="display:inline-flex; align-items:center; gap:8px; cursor:pointer">
            Import JSON <input id="importFile" type="file" accept="application/json" style="display:none" />
          </label>
          <label for="csvFile" class="btn btn-ghost" style="display:inline-flex; align-items:center; gap:8px; cursor:pointer">
            Import CSV <input id="csvFile" type="file" accept=".csv,text/csv" style="display:none" />
          </label>
          <button id="undoImportBtn" class="btn btn-ghost" title="Undo last import" disabled>Undo Last Import</button>
          <button id="resetBtn" class="btn btn-danger">⚠ Reset Data</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Calculators</h2>
      <div class="section-body">
        <div class="row">
          <div>
            <label for="whatIfNumber">What-If amount</label>
            <input id="whatIfNumber" type="number" min="0" step="1" inputmode="decimal" />
            <div class="mini-help">Projected Balance (Net − What-If): <strong id="projectedBalance">$0.00</strong></div>
          </div>
          <div>
            <label for="calcAmount">Quick Calculator: Planned purchase</label>
            <input id="calcAmount" type="number" min="0" step="1" inputmode="decimal" placeholder="e.g., 250" />
            <div class="mini-help">New Balance (Net − Planned): <strong id="calcResult">$0.00</strong></div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Sync (E2EE via GitHub Gist)</h2>
      <div class="section-body">
        <div class="mini-help">Bring your own token (gist scope). We store only encrypted data.</div>
        <div class="row">
          <div>
            <label for="syncPass">Passphrase (don’t lose this)</label>
            <input id="syncPass" type="password" placeholder="Your passphrase" />
          </div>
          <div>
            <label for="syncToken">GitHub Token (gist scope)</label>
            <input id="syncToken" type="password" placeholder="ghp_..." />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="syncId">Sync ID (Gist ID)</label>
            <input id="syncId" type="text" placeholder="e.g., a1b2c3d4..." />
          </div>
          <div class="actions" style="align-items:end">
            <button id="btnCreateGist" class="btn btn-primary" type="button" style="width:auto">Create New Sync</button>
            <button id="btnConnect" class="btn btn-ghost" type="button" style="width:auto">Connect</button>
            <button id="btnSyncNow" class="btn btn-ghost" type="button" style="width:auto" disabled>Sync Now</button>
            <button id="btnSignOut" class="btn btn-danger" type="button" style="width:auto">Sign out of Sync</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- TEMPLATES -->
  <section id="tab-templates" class="hide">
    <div class="card">
      <h2>Recurring Expense Templates</h2>
      <div class="section-body">
        <form id="tplForm">
          <fieldset>
            <legend>Create / Edit Template</legend>
            <div class="row-3">
              <div><label for="tplLabel">Label (e.g., Rent)</label><input id="tplLabel" type="text" required /></div>
              <div><label for="tplAmount">Amount</label><input id="tplAmount" type="number" min="0" step="0.01" inputmode="decimal" required /></div>
              <div><label for="tplFreq">Frequency</label>
                <select id="tplFreq">
                  <option value="weekly">Weekly</option>
                  <option value="biweekly">Biweekly</option>
                  <option value="semimonthly">Semi-monthly (1st & 15th)</option>
                  <option value="monthly">Monthly</option>
                </select>
              </div>
            </div>
            <div id="tplAnchors" class="row-3" style="margin-top:8px">
              <div id="anchWeekly" class="hide"><label for="tplWeekday">Weekday</label>
                <select id="tplWeekday"><option value="0">Sunday</option><option value="1">Monday</option><option value="2">Tuesday</option><option value="3">Wednesday</option><option value="4">Thursday</option><option value="5">Friday</option><option value="6">Saturday</option></select>
              </div>
              <div id="anchBiweekly" class="hide"><label for="tplSeedDate">Seed date</label><input id="tplSeedDate" type="date" /></div>
              <div id="anchMonthly" class="hide"><label for="tplMonthDay">Day of month</label><input id="tplMonthDay" type="number" min="1" max="31" /></div>
            </div>
            <div class="row">
              <div><label for="tplStart">Start date</label><input id="tplStart" type="date" /></div>
              <div><label for="tplNotes">Notes (optional)</label><input id="tplNotes" type="text" /></div>
            </div>
            <div class="actions"><button class="btn btn-primary" id="tplSave" type="submit">Save Template</button><button class="btn btn-ghost" id="tplCancel" type="button">Cancel</button></div>
            <div id="tplErr" class="error" style="display:none">Please fill the highlighted fields.</div>
          </fieldset>
        </form>
        <div class="card" style="margin:12px 0 0">
          <h2>Templates List</h2>
          <div class="section-body" id="tplList" class="muted">No templates yet.</div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- CSV Mapping Modal -->
<div id="csvModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:60; align-items:center; justify-content:center;">
  <div class="card" style="width:min(980px, 96%); max-height:90%; overflow:auto;">
    <h2 style="display:flex;justify-content:space-between;align-items:center;padding:12px 14px;">
      Import CSV
      <button id="csvClose" class="btn btn-ghost" style="width:auto">Close</button>
    </h2>
    <div class="section-body">
      <div class="row-3">
        <div><label for="mapDate">Date column</label><select id="mapDate"></select></div>
        <div><label for="mapDesc">Description column</label><select id="mapDesc"></select></div>
        <div><label for="amountMode">Amount mode</label>
          <select id="amountMode">
            <option value="auto">Auto-detect</option>
            <option value="signed">Signed Amount column (neg=expense)</option>
            <option value="dc">Debit/Credit columns</option>
          </select>
        </div>
      </div>
      <div class="row-3" id="amountRowSigned" style="margin-top:8px; display:none">
        <div><label for="mapAmount">Amount column</label><select id="mapAmount"></select></div>
        <div><label for="invertSign">Invert sign</label>
          <select id="invertSign"><option value="no">No</option><option value="yes">Yes</option></select>
        </div>
      </div>
      <div class="row-3" id="amountRowDC" style="margin-top:8px; display:none">
        <div><label for="mapDebit">Debit column</label><select id="mapDebit"></select></div>
        <div><label for="mapCredit">Credit column</label><select id="mapCredit"></select></div>
        <div><label for="treatBlankAsZero">Treat blank as 0</label>
          <select id="treatBlankAsZero"><option value="yes">Yes</option><option value="no">No</option></select>
        </div>
      </div>
      <div class="mini-help" style="margin-top:6px">Rows with Description containing “Beginning Balance” are skipped.</div>
      <div style="margin:10px 0"><button id="csvImportBtn" class="btn btn-primary" style="width:auto">Import</button></div>
      <div style="overflow:auto; border:1px solid var(--border); border-radius:10px">
        <table><thead><tr id="csvHead"></tr></thead><tbody id="csvBody"></tbody></table>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(console.error); });
}

/* ====== Storage & Utilities ====== */
const LS_KEY='simple_budget_v11';
const fmt=new Intl.NumberFormat(undefined,{style:'currency',currency:getLikelyCurrency(),minimumFractionDigits:2,maximumFractionDigits:2});
function getLikelyCurrency(){try{new Intl.NumberFormat(undefined,{style:'currency',currency:'USD'}).formatToParts(1);return(Intl.NumberFormat().resolvedOptions().currency||'USD')}catch{return'USD'}}
function formatCurrency(n){return fmt.format(Number(n||0))}
function parseAmount(v){if(typeof v==='number')return v;if(!v&&v!==0)return NaN;v=String(v).replace(/[^0-9,.\-]/g,'').replace(',', '.');const num=Number(v);return Number.isFinite(num)?num:NaN}
function uid(){return Math.random().toString(36).slice(2)+Date.now().toString(36)}
function nowIso(){return new Date().toISOString()}
function todayStr(){return new Date().toISOString().slice(0,10)}
function toISO(d){return new Date(d).toISOString().slice(0,10)}
function startOfWeekSunday(d){const dt=new Date(d);const dow=dt.getDay();dt.setDate(dt.getDate()-dow);dt.setHours(0,0,0,0);return dt}
function endOfWeekSunday(d){const s=startOfWeekSunday(d);const e=new Date(s);e.setDate(s.getDate()+6);e.setHours(23,59,59,999);return e}
function addDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return x}
function clipDOM(year, month, day){const last=new Date(year, month+1, 0).getDate(); return new Date(year, month, Math.min(day,last));}
function isFuture(iso){const d=new Date(iso);const t=new Date();t.setHours(0,0,0,0);return d>t}
function inRange(iso,start,end){try{const d=new Date(iso);return d>=start && d<=end}catch{return false}}
function escapeHtml(s){return String(s).replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;'}[c]))}
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1400)}
function byId(id){return document.getElementById(id)}

/* ====== State ====== */
let state = loadState();
if (!state.settings) state.settings = { payFreq:'biweekly', seedPayday: toISO(addDays(new Date(), 14)) };
if (!('payPeriodOffset' in state)) state.payPeriodOffset = 0;
if (!state.templates) state.templates = [];
if (!state.lastImportBatch) state.lastImportBatch = null;
if (!state.sync) state.sync = { provider:null, gistId:null, token:null, keySalt:null, passHint:null, lastRev:0 };
saveState();

function loadState(){try{const raw=localStorage.getItem(LS_KEY); if(!raw) return seed(); const obj=JSON.parse(raw); return obj;}catch{return seed()}}
function saveState(){localStorage.setItem(LS_KEY, JSON.stringify(state))}
function seed(){
  const s = { version:'1.3.1', settings:{payFreq:'biweekly', seedPayday: toISO(addDays(new Date(), 14))}, payPeriodOffset:0, incomes:[], expenses:[], templates:[], lastImportBatch:null, sync:{provider:null,gistId:null,token:null,keySalt:null,passHint:null,lastRev:0} };
  s.incomes.push({id:uid(), date:toISO(addDays(new Date(), -10)), source:'Paycheck', amount:3200, scheduled:false, updatedAt:nowIso()});
  s.incomes.push({id:uid(), date:toISO(addDays(new Date(), -3)), source:'Freelance', amount:450, scheduled:false, updatedAt:nowIso()});
  s.expenses.push({id:uid(), date:toISO(addDays(new Date(), -9)), category:'Housing', amount:1200, notes:'Rent', scheduled:false, updatedAt:nowIso()});
  s.expenses.push({id:uid(), date:toISO(addDays(new Date(), -2)), category:'Food', amount:245.37, notes:'Groceries', scheduled:false, updatedAt:nowIso()});
  return s;
}

/* ====== Pay period helpers (semimonthly fixed windows honored) ====== */
function nextPaydayFromSettings(offset=0){
  const freq = state.settings.payFreq||'biweekly';
  const seed = new Date(state.settings.seedPayday||todayStr());
  const today = new Date(); today.setHours(0,0,0,0); let next = new Date(seed);
  function advance(n){ next.setDate(next.getDate()+n); }
  if (freq==='weekly'){ while (next <= today) advance(7); advance(7*offset); }
  else if (freq==='biweekly'){ while (next <= today) advance(14); advance(14*offset); }
  else if (freq==='semimonthly'){
    const y=today.getFullYear(), m=today.getMonth();
    let c=[new Date(y,m,1), new Date(y,m,15), new Date(y,m+1,1), new Date(y,m+1,15)];
    c=c.map(x=>{x.setHours(0,0,0,0);return x;}).filter(x=>x>today);
    next = c[0] || new Date(y,m+1,1);
    for (let i=0;i<Math.abs(offset);i++){
      const cur=next;
      if (offset>0){ next=(cur.getDate()===1)? new Date(cur.getFullYear(), cur.getMonth(), 15)
                                             : new Date(cur.getFullYear(), cur.getMonth()+1, 1); }
      else { next=(cur.getDate()===15)? new Date(cur.getFullYear(), cur.getMonth(), 1)
                                      : new Date(cur.getFullYear(), cur.getMonth()-1, 15); }
    }
  } else if (freq==='monthly'){
    const day = new Date(state.settings.seedPayday||todayStr()).getDate();
    next = new Date(today.getFullYear(), today.getMonth(), day);
    if (next <= today) next = new Date(today.getFullYear(), today.getMonth()+1, day);
    next.setMonth(next.getMonth()+offset);
  }
  next.setHours(0,0,0,0);
  return next;
}
function currentPayPeriodRange(){
  const freq = state.settings.payFreq||'biweekly';
  const next = nextPaydayFromSettings(state.payPeriodOffset||0);
  let start, end;
  if (freq==='semimonthly'){
    if (next.getDate()===1){
      const pm=new Date(next.getFullYear(), next.getMonth()-1, 1);
      start=new Date(pm.getFullYear(), pm.getMonth(), 16);
      end=new Date(pm.getFullYear(), pm.getMonth()+1, 0);
    } else if (next.getDate()===15){
      start=new Date(next.getFullYear(), next.getMonth(), 1);
      end=new Date(next.getFullYear(), next.getMonth(), 15);
    } else { start=new Date(next.getFullYear(), next.getMonth(), 1); end=new Date(next.getFullYear(), next.getMonth(), 15); }
  } else {
    end = new Date(next); end.setHours(23,59,59,999);
    start = new Date(next);
    if (freq==='weekly') start.setDate(start.getDate()-7);
    else if (freq==='biweekly') start.setDate(start.getDate()-14);
    else if (freq==='monthly') start.setMonth(start.getMonth()-1);
  }
  start.setHours(0,0,0,0);
  return {start, end};
}
function formatRangeShort(start,end){
  const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  return `${months[start.getMonth()]} ${start.getDate()}–${months[end.getMonth()]} ${end.getDate()}`;
}

/* ====== Filters (Transactions tab) ====== */
function getActiveRange(){
  const now = new Date();
  const sel = dom.filterRange.value;
  if (sel==='thisWeek'){ return {start: startOfWeekSunday(now), end: endOfWeekSunday(now)}; }
  if (sel==='lastWeek'){ const s = addDays(startOfWeekSunday(now), -7); return {start: s, end: addDays(endOfWeekSunday(now), -7)}; }
  if (sel==='payPeriod'){ return currentPayPeriodRange(); }
  if (sel==='custom'){
    const s = dom.customStart.value ? new Date(dom.customStart.value) : new Date('1970-01-01');
    const e = dom.customEnd.value ? new Date(dom.customEnd.value) : new Date('2999-12-31');
    e.setHours(23,59,59,999);
    return {start:s, end:e};
  }
  return {start: new Date('1970-01-01'), end: new Date('2999-12-31')};
}

/* ====== Calculations ====== */
function totalsForRange(range){
  const today = new Date(); today.setHours(0,0,0,0);
  const inc = state.incomes.filter(x=>inRange(x.date, range.start, range.end) && !(x.scheduled && isFuture(x.date)))
                           .reduce((s,x)=>s+Number(x.amount||0),0);
  const exp = state.expenses.filter(x=>inRange(x.date, range.start, range.end) && !(x.scheduled && isFuture(x.date)))
                            .reduce((s,x)=>s+Number(x.amount||0),0);
  return {inc, exp, net: inc-exp};
}
function computeUpcoming7(){
  const start = new Date(); start.setHours(0,0,0,0);
  const end = addDays(start, 7);
  const upsInc = state.incomes.filter(x=>x.scheduled && inRange(x.date, start, end));
  const upsExp = state.expenses.filter(x=>x.scheduled && inRange(x.date, start, end));
  const sumInc = upsInc.reduce((s,x)=>s+Number(x.amount||0),0);
  const sumExp = upsExp.reduce((s,x)=>s+Number(x.amount||0),0);
  const items = [...upsExp.map(x=>({...x, type:'expense'})), ...upsInc.map(x=>({...x, type:'income'}))]
    .sort((a,b)=>String(a.date).localeCompare(String(b.date)));
  return {sumInc, sumExp, items};
}
function computeProjectedToPayday(){
  const next = nextPaydayFromSettings();
  const today = new Date(); today.setHours(0,0,0,0);
  const upsInc = state.incomes.filter(x=>x.scheduled && inRange(x.date, today, next));
  const upsExp = state.expenses.filter(x=>x.scheduled && inRange(x.date, today, next));
  const sumInc = upsInc.reduce((s,x)=>s+Number(x.amount||0),0);
  const sumExp = upsExp.reduce((s,x)=>s+Number(x.amount||0),0);
  const actualRange = {start: new Date('1970-01-01'), end: today};
  const {net} = totalsForRange(actualRange);
  return {next, projected: net + sumInc - sumExp};
}
function computeSafeToSpend(){
  const next = nextPaydayFromSettings();
  const today = new Date(); today.setHours(0,0,0,0);
  const scheduledBills = state.expenses.filter(x=>x.scheduled && inRange(x.date, today, next))
        .reduce((s,x)=>s+Number(x.amount||0),0);
  const actualRange = {start: new Date('1970-01-01'), end: today};
  const {net: actualNet} = totalsForRange(actualRange);
  return {next, safe: actualNet - scheduledBills};
}
function weeklySummaryCalc(){
  const now = new Date(); now.setHours(0,0,0,0);
  const s = startOfWeekSunday(now), e=endOfWeekSunday(now);
  const daysElapsed = Math.max(1, Math.min(7, Math.floor((now - s)/86400000)+1));
  const spent = state.expenses.filter(x=>!x.scheduled && inRange(x.date, s, e)).reduce((a,b)=>a+Number(b.amount||0),0);
  const avg = spent / daysElapsed; const proj = avg * 7;
  let sumPrior=0; for (let i=1;i<=4;i++){ const ps=addDays(s,-7*i), pe=addDays(e,-7*i);
    sumPrior += state.expenses.filter(x=>!x.scheduled && inRange(x.date, ps, pe)).reduce((a,b)=>a+Number(b.amount||0),0);
  }
  const avg4 = sumPrior/4; return {spent, avg, proj, avg4};
}

/* ====== Recurring templates ====== */
function generateTemplateInstances(){
  const windowDays = 60;
  const start = new Date(); start.setHours(0,0,0,0);
  const end = addDays(start, windowDays);
  state.expenses = state.expenses.filter(x=>{
    if (!x.scheduled || !x.templateId) return true;
    const tpl = state.templates.find(t=>t.id===x.templateId);
    if (!tpl || tpl.active===false) return false;
    const d=new Date(x.date);
    return d>=start && d<=end;
  });
  for (const t of state.templates){
    if (t.active===false) continue;
    const genStart = new Date(Math.max(start, new Date(t.startDate||start)));
    const addInst = (d)=>{
      const iso=toISO(d);
      const exists = state.expenses.some(x=>x.scheduled && x.templateId===t.id && x.date===iso);
      if (!exists) state.expenses.push({id:uid(), date:iso, category:t.label||'Bill', amount:Number(t.amount||0), notes:t.notes||'', scheduled:true, templateId:t.id, updatedAt:nowIso()});
    };
    if (t.freq==='weekly'){
      let d=new Date(genStart);
      while (d.getDay()!= (t.weekday??0)) d.setDate(d.getDate()+1);
      while (d<=end){ addInst(d); d=addDays(d,7); }
    } else if (t.freq==='biweekly'){
      const seed=new Date(t.seedDate||t.startDate||genStart);
      let d=new Date(seed);
      while (d<genStart) d=addDays(d,14);
      while (d<=end){ addInst(d); d=addDays(d,14); }
    } else if (t.freq==='semimonthly'){
      let cursor=new Date(genStart.getFullYear(), genStart.getMonth(), 1);
      while (cursor<=end){
        const d1=new Date(cursor.getFullYear(), cursor.getMonth(), 1);
        const d15=new Date(cursor.getFullYear(), cursor.getMonth(), 15);
        if (d1>=genStart && d1<=end) addInst(d1);
        if (d15>=genStart && d15<=end) addInst(d15);
        cursor.setMonth(cursor.getMonth()+1,1);
      }
    } else if (t.freq==='monthly'){
      let cursor=new Date(genStart.getFullYear(), genStart.getMonth(), 1);
      const day = Math.min(31, Math.max(1, Number(t.day||1)));
      while (cursor<=end){
        const when=clipDOM(cursor.getFullYear(), cursor.getMonth(), day);
        if (when>=genStart && when<=end) addInst(when);
        cursor.setMonth(cursor.getMonth()+1,1);
      }
    }
  }
}

/* ====== DOM refs ====== */
const dom = {
  tabs: document.querySelectorAll('.tab'),
  sections: {
    home: byId('tab-home'),
    transactions: byId('tab-transactions'),
    calendar: byId('tab-calendar'),
    tools: byId('tab-tools'),
    templates: byId('tab-templates')
  },
  // appbar period nav
  appbarNav: byId('appbarNav'), appPrev: byId('appPrev'), appNext: byId('appNext'), appPeriodLabel: byId('appPeriodLabel'),
  // home
  sumIncome: byId('sumIncome'), sumExpenses: byId('sumExpenses'), sumNet: byId('sumNet'),
  projectedToPayday: byId('projectedToPayday'), nextPaydayLabel: byId('nextPaydayLabel'),
  safePill: byId('safePill'), safeToSpend: byId('safeToSpend'),
  payPeriodHeader: byId('payPeriodHeader'), periodLabel: byId('periodLabel'),
  // upcoming
  upBills: byId('upBills'), upIncome: byId('upIncome'), upNet: byId('upNet'), upcomingList: byId('upcomingList'),
  // weekly summary
  wkSpent: byId('wkSpent'), wkAvg: byId('wkAvg'), wkProj: byId('wkProj'), wkTrend: byId('wkTrend'),
  // filters
  filtersCard: byId('filtersCard'), toggleFilters: byId('toggleFilters'),
  filterRange: byId('filterRange'), customStart: byId('customStart'), customEnd: byId('customEnd'), toSpan: byId('toSpan'),
  payFreq: byId('payFreq'), seedPayday: byId('seedPayday'),
  // forms and tables
  incomeForm: byId('incomeForm'), incomeDate: byId('incomeDate'), incomeSource: byId('incomeSource'), incomeAmount: byId('incomeAmount'), incomeAmountErr: byId('incomeAmountErr'), incomeScheduled: byId('incomeScheduled'), incomeSubmitBtn: byId('incomeSubmitBtn'), incomeCancelEdit: byId('incomeCancelEdit'),
  expenseForm: byId('expenseForm'), expenseDate: byId('expenseDate'), expenseCategory: byId('expenseCategory'), expenseCategoryCustom: byId('expenseCategoryCustom'), expenseAmount: byId('expenseAmount'), expenseAmountErr: byId('expenseAmountErr'), expenseNotes: byId('expenseNotes'), expenseScheduled: byId('expenseScheduled'), expenseSubmitBtn: byId('expenseSubmitBtn'), expenseCancelEdit: byId('expenseCancelEdit'),
  incomeTbody: byId('incomeTbody'), expenseTbody: byId('expenseTbody'),
  // tools
  exportBtn: byId('exportBtn'), importFile: byId('importFile'),
  csvFile: byId('csvFile'), csvModal: byId('csvModal'), csvClose: byId('csvClose'),
  mapDate: byId('mapDate'), mapDesc: byId('mapDesc'), amountMode: byId('amountMode'), mapAmount: byId('mapAmount'), invertSign: byId('invertSign'), mapDebit: byId('mapDebit'), mapCredit: byId('mapCredit'), treatBlankAsZero: byId('treatBlankAsZero'),
  csvHead: byId('csvHead'), csvBody: byId('csvBody'), csvImportBtn: byId('csvImportBtn'),
  undoImportBtn: byId('undoImportBtn'),
  resetBtn: byId('resetBtn'),
  whatIfNumber: byId('whatIfNumber'), projectedBalance: byId('projectedBalance'), calcAmount: byId('calcAmount'), calcResult: byId('calcResult'),
  // calendar
  calPrev: byId('calPrev'), calNext: byId('calNext'), calLabel: byId('calLabel'), calGrid: byId('calGrid'), calMonthTotal: byId('calMonthTotal'), dayDetailTitle: byId('dayDetailTitle'), dayDetailBody: byId('dayDetailBody'),
  // templates
  tplForm: byId('tplForm'), tplLabel: byId('tplLabel'), tplAmount: byId('tplAmount'), tplFreq: byId('tplFreq'), tplWeekday: byId('tplWeekday'), tplSeedDate: byId('tplSeedDate'), tplMonthDay: byId('tplMonthDay'), tplStart: byId('tplStart'), tplNotes: byId('tplNotes'), tplSave: byId('tplSave'), tplCancel: byId('tplCancel'), tplList: byId('tplList'), tplErr: byId('tplErr'),
  anchWeekly: byId('anchWeekly'), anchBiweekly: byId('anchBiweekly'), anchMonthly: byId('anchMonthly'),
  // sync
  syncPass: byId('syncPass'), syncToken: byId('syncToken'), syncId: byId('syncId'),
  btnCreateGist: byId('btnCreateGist'), btnConnect: byId('btnConnect'), btnSyncNow: byId('btnSyncNow'), btnSignOut: byId('btnSignOut')
};

/* ====== Render ====== */
function renderHome(){
  generateTemplateInstances();
  const range = {start:new Date('1970-01-01'), end:new Date('2999-12-31')};
  const {inc, exp, net} = totalsForRange(range);
  dom.sumIncome.textContent = formatCurrency(inc);
  dom.sumExpenses.textContent = formatCurrency(exp);
  dom.sumNet.textContent = formatCurrency(net);

  const proj = computeProjectedToPayday();
  dom.projectedToPayday.textContent = formatCurrency(proj.projected);
  dom.nextPaydayLabel.textContent = toISO(proj.next);

  const sts = computeSafeToSpend();
  dom.safeToSpend.textContent = formatCurrency(sts.safe);
  dom.safePill.classList.toggle('negative', sts.safe < 0);

  const {start,end}=currentPayPeriodRange();
  dom.appPeriodLabel.textContent = formatRangeShort(start,end);
}
function renderTransactions(){
  const range = getActiveRange();
  const incRows = state.incomes.filter(x=>inRange(x.date, range.start, range.end) && !(x.scheduled && isFuture(x.date)))
    .sort((a,b)=>String(b.date).localeCompare(String(a.date))).map(row=>`
    <tr>
      <td>${escapeHtml(row.date||'')}</td>
      <td>${escapeHtml(row.source||'')}</td>
      <td>${row.scheduled ? 'Yes' : 'No'}</td>
      <td class="right mono">${formatCurrency(row.amount||0)}</td>
      <td class="right"><div class="actions" style="justify-content:flex-end">
        <button class="btn btn-ghost" data-action="edit-income" data-id="${row.id}">Edit</button>
        <button class="btn btn-danger" data-action="del-income" data-id="${row.id}">Delete</button>
      </div></td>
    </tr>`).join('');
  dom.incomeTbody.innerHTML = incRows || '<tr><td colspan="5" class="muted">No items for this view.</td></tr>';

  const expRows = state.expenses.filter(x=>inRange(x.date, range.start, range.end) && !(x.scheduled && isFuture(x.date)))
    .sort((a,b)=>String(b.date).localeCompare(String(a.date))).map(row=>`
    <tr>
      <td>${escapeHtml(row.date||'')}</td>
      <td>${escapeHtml(row.category||'')}</td>
      <td>${row.scheduled ? 'Yes' : 'No'}</td>
      <td class="right mono">${formatCurrency(row.amount||0)}</td>
      <td class="muted">${escapeHtml(row.notes||'')}</td>
      <td class="right"><div class="actions" style="justify-content:flex-end">
        <button class="btn btn-ghost" data-action="edit-expense" data-id="${row.id}">Edit</button>
        <button class="btn btn-danger" data-action="del-expense" data-id="${row.id}">Delete</button>
      </div></td>
    </tr>`).join('');
  dom.expenseTbody.innerHTML = expRows || '<tr><td colspan="6" class="muted">No items for this view.</td></tr>';
}
let calCursor = new Date();
function renderCalendar(){
  const y=calCursor.getFullYear(), m=calCursor.getMonth();
  dom.calLabel.textContent = new Intl.DateTimeFormat(undefined,{month:'long', year:'numeric'}).format(calCursor);

  const firstOfMonth = new Date(y,m,1); firstOfMonth.setHours(0,0,0,0);
  const start = startOfWeekSunday(firstOfMonth);
  const end = endOfWeekSunday(new Date(y, m+1, 0));
  dom.calGrid.innerHTML = '';
  const monthStart = new Date(y,m,1); monthStart.setHours(0,0,0,0);
  const monthEnd = new Date(y, m+1, 0); monthEnd.setHours(23,59,59,999);
  const monthBills = state.expenses.filter(x=>x.scheduled && inRange(x.date, monthStart, monthEnd))
                    .reduce((s,x)=>s+Number(x.amount||0),0);
  dom.calMonthTotal.textContent = formatCurrency(monthBills);

  const todayIso = todayStr();
  for (let d=new Date(start); d<=end; d=addDays(d,1)){
    const iso=toISO(d);
    const cell=document.createElement('div');
    cell.className='cal-cell'+(d.getMonth()!==m?' out':'')+(iso===todayIso?' today':'');
    cell.setAttribute('data-date', iso);
    cell.innerHTML = `
      <div class="cal-date">${d.getDate()}</div>
      <div class="cal-amt">${formatCurrency(
        state.expenses.filter(x=>x.scheduled && x.date===iso).reduce((s,x)=>s+Number(x.amount||0),0)
      )}</div>
    `;
    cell.addEventListener('click', ()=>showDayDetails(iso));
    dom.calGrid.appendChild(cell);
  }
  const isInMonth = new Date(todayIso).getMonth()===m && new Date(todayIso).getFullYear()===y;
  showDayDetails(isInMonth ? todayIso : toISO(new Date(y,m,1)));
}
function showDayDetails(iso){
  const items = state.expenses.filter(x=>x.scheduled && x.date===iso).sort((a,b)=>Number(a.amount)-Number(b.amount));
  byId('dayDetailTitle').textContent = `Bills on ${iso}`;
  byId('dayDetailBody').innerHTML = items.length ? items.map(x=>`
    <div style="display:flex; justify-content:space-between; gap:8px; padding:6px 0; border-bottom:1px solid #1a2030">
      <span>${escapeHtml(x.category||'Bill')} <span class="muted">${escapeHtml(x.notes||'')}</span></span>
      <div style="display:flex; gap:8px; align-items:center">
        <span style="color:#ff9c9c">${formatCurrency(x.amount||0)}</span>
        <button class="btn btn-ghost" data-dd="paid" data-id="${x.id}">Mark Paid</button>
        <button class="btn btn-ghost" data-dd="del"  data-id="${x.id}">Delete</button>
      </div>
    </div>`).join('') : '<div class="muted">No scheduled bills on this day.</div>';
}

/* ====== Events ====== */
function initTabs(){
  dom.tabs.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      dom.tabs.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const tab=btn.getAttribute('data-tab');
      Object.keys(dom.sections).forEach(k=>{ dom.sections[k].classList.toggle('hide', k!==tab); });
      dom.appbarNav.style.display = (tab==='home') ? '' : 'none';
      if (tab==='home') renderHome();
      if (tab==='transactions') renderTransactions();
      if (tab==='calendar') renderCalendar();
    });
  });
}
function initHome(){
  // appbar nav buttons
  dom.appPrev.addEventListener('click', ()=>{ state.payPeriodOffset=(state.payPeriodOffset||0)-1; saveState(); renderHome(); });
  dom.appNext.addEventListener('click', ()=>{ state.payPeriodOffset=(state.payPeriodOffset||0)+1; saveState(); renderHome(); });
  // upcoming list actions
  dom.upcomingList.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-act]'); if(!btn) return;
    const act = btn.getAttribute('data-act'), id=btn.getAttribute('data-id'), typ=btn.getAttribute('data-type');
    if (act==='del'){
      if (!confirm('Delete this scheduled item?')) return;
      if (typ==='income') state.incomes = state.incomes.filter(x=>x.id!==id);
      else state.expenses = state.expenses.filter(x=>x.id!==id);
      saveState(); renderHome(); renderTransactions(); renderCalendar(); toast('Scheduled item deleted');
    } else if (act==='paid'){
      if (typ==='income'){
        const it = state.incomes.find(x=>x.id===id); if(!it) return;
        const posted = toISO(new Date());
        state.incomes = state.incomes.filter(x=>x.id!==id);
        state.incomes.push({id:uid(), date:posted, source:it.source||'Income', amount:Number(it.amount||0), scheduled:false, updatedAt:nowIso()});
        saveState(); renderHome(); renderTransactions(); renderCalendar(); toast('Marked paid');
      } else {
        const it = state.expenses.find(x=>x.id===id); if(!it) return;
        const next = prompt('Confirm amount for payment (you can adjust):', (Number(it.amount||0).toFixed(2)));
        if (next===null) return;
        const parsed = parseAmount(next);
        if (!Number.isFinite(parsed) || parsed<0){ alert('Invalid amount'); return; }
        const posted = toISO(new Date());
        state.expenses = state.expenses.filter(x=>x.id!==id);
        state.expenses.push({id:uid(), date:posted, category:it.category||'Expense', amount:parsed, notes:it.notes||'', scheduled:false, updatedAt:nowIso()});
        saveState(); renderHome(); renderTransactions(); renderCalendar(); toast('Marked paid');
      }
    }
  });
}
function initTransactions(){
  function onFilterChange(){
    const sel = dom.filterRange.value;
    const showCustom = sel==='custom';
    dom.customStart.style.display = showCustom ? '' : 'none';
    dom.customEnd.style.display = showCustom ? '' : 'none';
    dom.toSpan.style.display = showCustom ? '' : 'none';
    renderTransactions();
  }
  dom.filterRange.addEventListener('change', onFilterChange);
  dom.customStart.addEventListener('change', renderTransactions);
  dom.customEnd.addEventListener('change', renderTransactions);
  dom.payFreq.addEventListener('change', ()=>{ state.settings.payFreq = dom.payFreq.value; saveState(); renderHome(); });
  dom.seedPayday.addEventListener('change', ()=>{ state.settings.seedPayday = dom.seedPayday.value; saveState(); renderHome(); });

  // collapse toggle
  dom.toggleFilters.addEventListener('click', ()=>{
    const collapsed = !dom.filtersCard.classList.contains('collapsed');
    dom.filtersCard.classList.toggle('collapsed', collapsed);
    dom.toggleFilters.textContent = collapsed ? 'Expand' : 'Collapse';
    dom.toggleFilters.setAttribute('aria-expanded', String(!collapsed));
  });

  // Income form
  dom.incomeForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    const date=dom.incomeDate.value||todayStr();
    const source=dom.incomeSource.value.trim();
    const amt=parseAmount(dom.incomeAmount.value);
    const scheduled= !!dom.incomeScheduled.checked;
    if(!Number.isFinite(amt)||amt<0){ dom.incomeAmountErr.style.display='block'; return; } else dom.incomeAmountErr.style.display='none';
    state.incomes.push({id:uid(), date, source, amount:amt, scheduled, updatedAt:nowIso()});
    saveState(); clearIncomeForm(); renderTransactions(); renderHome(); toast('Income added');
  });
  dom.incomeCancelEdit.addEventListener('click', ()=>{ clearIncomeForm(); });
  dom.incomeTbody.addEventListener('click', (e)=>{
    const btn=e.target.closest('button[data-action]'); if(!btn) return;
    const id=btn.getAttribute('data-id'); const action=btn.getAttribute('data-action');
    const it = state.incomes.find(x=>x.id===id);
    if(action==='edit-income' && it){
      dom.incomeDate.value=it.date||todayStr();
      dom.incomeSource.value=it.source||'';
      dom.incomeAmount.value=Number(it.amount||0).toFixed(2);
      dom.incomeScheduled.checked = !!it.scheduled;
      state.incomes = state.incomes.filter(x=>x.id!==id);
      saveState(); renderTransactions();
      dom.incomeSubmitBtn.textContent='Save Income';
    }else if(action==='del-income'){
      if(confirm('Delete this income item?')){ state.incomes=state.incomes.filter(x=>x.id!==id); saveState(); renderTransactions(); renderHome(); toast('Income deleted'); }
    }
  });

  // Expense form
  dom.expenseForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    const date=dom.expenseDate.value||todayStr();
    const selected=dom.expenseCategory.value;
    const custom=dom.expenseCategoryCustom.value.trim();
    const category=custom||selected;
    const amt=parseAmount(dom.expenseAmount.value);
    const notes=dom.expenseNotes.value.trim();
    const scheduled= !!dom.expenseScheduled.checked;
    if(!Number.isFinite(amt)||amt<0){ dom.expenseAmountErr.style.display='block'; return; } else dom.expenseAmountErr.style.display='none';
    state.expenses.push({id:uid(), date, category, amount:amt, notes, scheduled, templateId:null, updatedAt:nowIso()});
    saveState(); clearExpenseForm(); renderTransactions(); renderHome(); toast('Expense added');
  });
  dom.expenseCancelEdit.addEventListener('click', ()=>{ clearExpenseForm(); });
  dom.expenseTbody.addEventListener('click', (e)=>{
    const btn=e.target.closest('button[data-action]'); if(!btn) return;
    const id=btn.getAttribute('data-id'); const action=btn.getAttribute('data-action');
    const it = state.expenses.find(x=>x.id===id);
    if(action==='edit-expense' && it){
      dom.expenseDate.value=it.date||todayStr();
      const opts=Array.from(dom.expenseCategory.options).map(o=>o.value);
      if(opts.includes(it.category)){ dom.expenseCategory.value=it.category; dom.expenseCategoryCustom.value=''; }
      else { dom.expenseCategory.value='Other'; dom.expenseCategoryCustom.value=it.category||''; }
      dom.expenseAmount.value=Number(it.amount||0).toFixed(2);
      dom.expenseNotes.value=it.notes||'';
      dom.expenseScheduled.checked = !!it.scheduled;
      state.expenses = state.expenses.filter(x=>x.id!==id);
      saveState(); renderTransactions();
      dom.expenseSubmitBtn.textContent='Save Expense';
    }else if(action==='del-expense'){
      if(confirm('Delete this expense item?')){ state.expenses=state.expenses.filter(x=>x.id!==id); saveState(); renderTransactions(); renderHome(); toast('Expense deleted'); }
    }
  });
}

/* Templates tab (unchanged render/handlers from 1.3.0)… */
let editingTplId=null;
function showTplAnchors(){ const f=dom.tplFreq.value; byId('anchWeekly').classList.toggle('hide', f!=='weekly'); byId('anchBiweekly').classList.toggle('hide', f!=='biweekly'); byId('anchMonthly').classList.toggle('hide', f!=='monthly'); }
function renderTemplates(){
  if (!state.templates.length){ dom.tplList.innerHTML='<div class="muted">No templates yet.</div>'; return; }
  dom.tplList.innerHTML = state.templates.map(t=>`
    <div style="display:flex; justify-content:space-between; gap:8px; padding:8px 0; border-bottom:1px solid #1a2030">
      <div><strong>${escapeHtml(t.label)}</strong> — ${formatCurrency(t.amount)} • ${escapeHtml(t.freq)} ${t.freq==='weekly'?('( '+['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][t.weekday??0]+' )'):''}
        ${t.freq==='biweekly'?('( seed '+escapeHtml(t.seedDate||t.startDate||'')+' )'):''}
        ${t.freq==='monthly'?('( day '+(t.day||1)+' )'):''}
        <div class="muted">Start: ${escapeHtml(t.startDate||'—')} ${t.notes?('• '+escapeHtml(t.notes)) : ''}</div>
      </div>
      <div class="actions" style="align-items:center">
        <label class="muted" style="display:flex; gap:6px; align-items:center">Active <input type="checkbox" data-tpl="toggle" data-id="${t.id}" ${t.active===false?'':'checked'}></label>
        <button class="btn btn-ghost" data-tpl="edit" data-id="${t.id}">Edit</button>
        <button class="btn btn-danger" data-tpl="del" data-id="${t.id}">Delete</button>
      </div>
    </div>`).join('');
}
function clearTplForm(){ editingTplId=null; dom.tplLabel.value=''; dom.tplAmount.value=''; dom.tplFreq.value='monthly'; dom.tplWeekday.value='0'; dom.tplSeedDate.value=''; dom.tplMonthDay.value='1'; dom.tplStart.value=''; dom.tplNotes.value=''; showTplAnchors(); }
function initTemplates(){
  showTplAnchors();
  dom.tplFreq.addEventListener('change', showTplAnchors);
  dom.tplCancel.addEventListener('click', clearTplForm);
  dom.tplForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    const label=dom.tplLabel.value.trim();
    const amount=parseAmount(dom.tplAmount.value);
    const freq=dom.tplFreq.value;
    const weekday=Number(dom.tplWeekday.value);
    const seedDate=dom.tplSeedDate.value||null;
    const day=Number(dom.tplMonthDay.value||1);
    const startDate=dom.tplStart.value||todayStr();
    const notes=dom.tplNotes.value.trim();
    if (!label || !Number.isFinite(amount) || amount<0){ dom.tplErr.style.display='block'; setTimeout(()=>dom.tplErr.style.display='none',1500); return; }
    if (editingTplId){
      const i=state.templates.findIndex(t=>t.id===editingTplId);
      if (i>=0){ const old=state.templates[i];
        state.templates[i]={...old, label, amount, freq, weekday, seedDate, day, startDate, notes, active:(old.active!==false), updatedAt:nowIso()};
      }
      toast('Template updated');
    } else {
      state.templates.push({id:uid(), label, amount, freq, weekday, seedDate, day, startDate, notes, active:true, updatedAt:nowIso()});
      toast('Template added');
    }
    saveState(); clearTplForm(); renderTemplates(); renderHome(); renderCalendar();
  });
  dom.tplList.addEventListener('click', (e)=>{
    const btn=e.target.closest('button, input[type="checkbox"]'); if(!btn) return;
    const id=btn.getAttribute('data-id'); const act=btn.getAttribute('data-tpl');
    const i=state.templates.findIndex(t=>t.id===id); if(i<0) return;
    if (act==='edit'){
      const t=state.templates[i]; editingTplId=id;
      dom.tplLabel.value=t.label||''; dom.tplAmount.value=Number(t.amount||0).toFixed(2);
      dom.tplFreq.value=t.freq||'monthly'; dom.tplWeekday.value=String(t.weekday??0);
      dom.tplSeedDate.value=t.seedDate||''; dom.tplMonthDay.value=String(t.day||1);
      dom.tplStart.value=t.startDate||todayStr(); dom.tplNotes.value=t.notes||'';
      showTplAnchors();
    } else if (act==='del'){
      if (!confirm('Delete this template?')) return;
      state.templates.splice(i,1);
      state.expenses = state.expenses.filter(x=>x.templateId!==id || !x.scheduled);
      saveState(); renderTemplates(); renderCalendar(); renderHome(); toast('Template deleted');
    } else if (act==='toggle'){
      state.templates[i].active = btn.checked;
      saveState(); renderTemplates(); renderCalendar(); renderHome(); toast(btn.checked?'Template enabled':'Template disabled');
    }
  });
}

/* ====== Tools: Export/Import/CSV/Reset & Calcs ====== */
function initTools(){
  dom.exportBtn.addEventListener('click', ()=>{
    const blob=new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download=`budget-export-v131-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); toast('Exported JSON');
  });
  dom.importFile.addEventListener('change', async (e)=>{
    const file=e.target.files[0]; if(!file) return;
    try{ const text=await file.text(); const obj=JSON.parse(text);
      if(!obj || !Array.isArray(obj.incomes) || !Array.isArray(obj.expenses)) throw new Error('Invalid format');
      state={
        version: obj.version||'1.3.1',
        settings: obj.settings||state.settings,
        payPeriodOffset: obj.payPeriodOffset||0,
        incomes: obj.incomes.map(x=>({...x, scheduled: !!x.scheduled, updatedAt:x.updatedAt||nowIso()})),
        expenses: obj.expenses.map(x=>({...x, scheduled: !!x.scheduled, updatedAt:x.updatedAt||nowIso()})),
        templates: Array.isArray(obj.templates)? obj.templates : (state.templates||[]),
        lastImportBatch: null,
        sync: obj.sync || state.sync
      };
      saveState(); renderHome(); renderTransactions(); renderCalendar(); renderTemplates(); toast('Imported data');
    }catch(err){ alert('Import failed: '+(err.message||err)); } finally { e.target.value=''; }
  });

  // calculators
  dom.whatIfNumber.addEventListener('input', ()=>{
    const actualRange = {start: new Date('1970-01-01'), end: new Date()}; actualRange.end.setHours(0,0,0,0);
    const {net:actualNet} = totalsForRange(actualRange); const whatIf = Number(dom.whatIfNumber.value||0);
    dom.projectedBalance.textContent = formatCurrency(actualNet - whatIf);
  });
  dom.calcAmount.addEventListener('input', ()=>{
    const actualRange = {start: new Date('1970-01-01'), end: new Date()}; actualRange.end.setHours(0,0,0,0);
    const {net:actualNet} = totalsForRange(actualRange); const planned = parseAmount(dom.calcAmount.value);
    dom.calcResult.textContent = formatCurrency(actualNet - (Number.isFinite(planned)?planned:0));
  });

  // Reset
  dom.resetBtn.addEventListener('click', ()=>{
    if (!confirm('Erase ALL incomes/expenses (keep settings & templates)?')) return;
    const settings = state.settings, templates=state.templates, sync=state.sync;
    state = { version:'1.3.1', settings, payPeriodOffset:0, incomes:[], expenses:[], templates, lastImportBatch:null, sync };
    saveState();
    renderHome(); renderTransactions(); renderCalendar(); renderTemplates();
    toast('All transactions cleared');
  });

  // CSV
  dom.csvFile.addEventListener('change', handleCsvFile);
  dom.csvClose.addEventListener('click', closeCsvModal);
  dom.csvImportBtn.addEventListener('click', importCsvMapped);
  dom.amountMode.addEventListener('change', updateAmountModeUI);
  dom.undoImportBtn.addEventListener('click', undoLastImport);
}

/* ====== CSV support (v1.3.1 DC fix) ====== */
let _csvData = { headers:[], rows:[] };
function handleCsvFile(e){
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload = () => {
    const text=reader.result;
    const parsed=parseCSV(text);
    if (!parsed.headers.length){ alert('Could not read CSV headers.'); return; }
    _csvData=parsed;
    openCsvModal(parsed);
  };
  reader.readAsText(file);
  e.target.value='';
}
function parseCSV(text){
  const rows=[]; let cur='', inQ=false; let row=[];
  for (let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if (inQ){
      if (c==='\"' && n==='\"'){ cur+='\"'; i++; }
      else if (c==='\"'){ inQ=false; }
      else cur+=c;
    }else{
      if (c==='\"'){ inQ=true; }
      else if (c===',' ){ row.push(cur); cur=''; }
      else if (c==='\n' || c==='\r'){ if (cur!=='' || row.length){ row.push(cur); rows.push(row); row=[]; cur=''; } }
      else cur+=c;
    }
  }
  if (cur!=='' || row.length){ row.push(cur); rows.push(row); }
  const headers = (rows.shift()||[]).map(h=>h.trim());
  return { headers, rows };
}
function openCsvModal(parsed){
  const H=parsed.headers;
  fillSelect(dom.mapDate, H, guessHeader(H, ['post date','date','effective date']));
  fillSelect(dom.mapDesc, H, guessHeader(H, ['transaction description','description','memo','details']));
  fillSelect(dom.mapAmount, H, guessHeader(H, ['amount','transaction amount']));
  fillSelect(dom.mapDebit, H, guessHeader(H, ['debit']));
  fillSelect(dom.mapCredit, H, guessHeader(H, ['credit']));
  dom.amountMode.value = autoAmountMode(H);
  updateAmountModeUI();
  dom.csvHead.innerHTML = H.map(h=>`<th>${escapeHtml(h||'')}</th>`).join('');
  const max= Math.min(20, parsed.rows.length);
  dom.csvBody.innerHTML = parsed.rows.slice(0,max).map(r=>`<tr>${H.map((_,i)=>`<td>${escapeHtml(r[i]||'')}</td>`).join('')}</tr>`).join('');
  dom.csvModal.style.display='flex';
}
function closeCsvModal(){ dom.csvModal.style.display='none'; _csvData={headers:[],rows:[]}; }
function fillSelect(sel, headers, selected){
  sel.innerHTML = headers.map(h=>`<option value="${escapeHtml(h)}">${escapeHtml(h)}</option>`).join('');
  if (selected && headers.includes(selected)) sel.value=selected;
}
function guessHeader(headers, candidates){
  const lower=headers.map(h=>h.toLowerCase());
  for (const c of candidates){
    const idx=lower.indexOf(c);
    if (idx>=0) return headers[idx];
    const foundIdx=lower.findIndex(h=>h.includes(c));
    if (foundIdx>=0) return headers[foundIdx];
  }
  return headers[0]||'';
}
function autoAmountMode(H){
  const lower=H.map(h=>h.toLowerCase());
  if (lower.some(h=>h.includes('debit')) && lower.some(h=>h.includes('credit'))) return 'dc';
  if (lower.some(h=>h.includes('amount'))) return 'signed';
  return 'auto';
}
function updateAmountModeUI(){
  const mode=dom.amountMode.value;
  byId('amountRowSigned').style.display = (mode==='signed' || mode==='auto') ? '' : 'none';
  byId('amountRowDC').style.display = (mode==='dc') ? '' : 'none';
}
function importCsvMapped(){
  const H=_csvData.headers, rows=_csvData.rows;
  if (!H.length){ alert('No CSV loaded'); return; }
  const hDate = dom.mapDate.value, hDesc=dom.mapDesc.value;
  const mode = (dom.amountMode.value==='auto') ? autoAmountMode(H) : dom.amountMode.value;
  const idsImported=[];
  let count=0;
  for (const r of rows){
    const map = Object.create(null);
    H.forEach((h,i)=> map[h]=r[i]||'');
    const desc = String(map[hDesc]||'').trim();
    if (/beginning balance/i.test(desc)) continue;

    let dstr = String(map[hDate]||'').trim();
    if (!dstr) continue;
    const dtry = new Date(dstr);
    if (isNaN(dtry.getTime())) continue;
    const iso = toISO(dtry);

    let amt = 0;
    if (mode==='dc'){
      // NEW: treat Debit as absolute outflow; support negative debits
      let debit = parseAmount(map[dom.mapDebit.value]);
      let credit = parseAmount(map[dom.mapCredit.value]);
      const d = Number.isFinite(debit) ? Math.abs(debit) : (dom.treatBlankAsZero.value==='yes'?0:NaN);
      const c = Number.isFinite(credit) ? credit : (dom.treatBlankAsZero.value==='yes'?0:NaN);
      if (!Number.isFinite(d) && !Number.isFinite(c)) continue;
      const dd = Number.isFinite(d)?d:0, cc=Number.isFinite(c)?c:0;
      amt = cc - dd; // positive=income, negative=expense
    } else {
      let a = parseAmount(map[dom.mapAmount.value]);
      if (!Number.isFinite(a)) continue;
      if (dom.invertSign.value==='yes') a = -a;
      amt = a;
    }

    if (amt === 0) continue;
    if (amt > 0){
      const id=uid();
      state.incomes.push({id, date:iso, source:desc||'Import', amount:amt, scheduled:false, updatedAt:nowIso()});
      idsImported.push(id);
    } else {
      const id=uid();
      state.expenses.push({id, date:iso, category:'Imported', amount:Math.abs(amt), notes:desc||'', scheduled:false, updatedAt:nowIso()});
      idsImported.push(id);
    }
    count++;
  }
  state.lastImportBatch = { ids: idsImported, ts: Date.now() };
  saveState(); renderHome(); renderTransactions(); renderCalendar(); closeCsvModal();
  dom.undoImportBtn.disabled = idsImported.length===0;
  toast(`Imported ${count} rows`);
}
function undoLastImport(){
  const batch = state.lastImportBatch;
  if (!batch || !Array.isArray(batch.ids) || !batch.ids.length) return;
  const set=new Set(batch.ids);
  const b1=state.incomes.length, b2=state.expenses.length;
  state.incomes = state.incomes.filter(x=>!set.has(x.id));
  state.expenses = state.expenses.filter(x=>!set.has(x.id));
  const removed=(b1-state.incomes.length)+(b2-state.expenses.length);
  state.lastImportBatch=null;
  saveState(); renderHome(); renderTransactions(); renderCalendar(); toast(`Undid ${removed} imported rows`);
}

/* ====== Sync (unchanged logic from 1.3.0) ====== */
async function deriveKey(pass, salt){
  const enc=new TextEncoder();
  const keyMaterial=await crypto.subtle.importKey('raw', enc.encode(pass), {name:'PBKDF2'}, false, ['deriveKey']);
  return crypto.subtle.deriveKey({name:'PBKDF2', salt, iterations:120000, hash:'SHA-256'}, keyMaterial, {name:'AES-GCM', length:256}, true, ['encrypt','decrypt']);
}
async function encryptJSON(obj, pass, saltHex){
  const enc=new TextEncoder();
  const salt = saltHex ? Uint8Array.from(saltHex.match(/.{1,2}/g).map(b=>parseInt(b,16))) : crypto.getRandomValues(new Uint8Array(16));
  const key=await deriveKey(pass, salt);
  const iv=crypto.getRandomValues(new Uint8Array(12));
  const data=enc.encode(JSON.stringify(obj));
  const ct= new Uint8Array(await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, data));
  function hex(buf){return Array.from(buf).map(b=>b.toString(16).padStart(2,'0')).join('')}
  return { salt: hex(salt), iv: hex(iv), ct: btoa(String.fromCharCode(...ct)) };
}
async function decryptJSON(payload, pass){
  const dec=new TextDecoder();
  function fromHex(h){return new Uint8Array(h.match(/.{1,2}/g).map(b=>parseInt(b,16)))}
  const salt=fromHex(payload.salt), iv=fromHex(payload.iv);
  const key=await deriveKey(pass, salt);
  const ctBytes=Uint8Array.from(atob(payload.ct), c=>c.charCodeAt(0));
  const pt= await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ctBytes);
  return JSON.parse(dec.decode(pt));
}
async function gistRequest(method, path, token, body){
  const res = await fetch(`https://api.github.com${path}`, {
    method, headers: { 'Authorization': `token ${token}`, 'Accept':'application/vnd.github+json' },
    body: body? JSON.stringify(body): undefined
  });
  if (!res.ok) throw new Error(`${method} ${path} → ${res.status}`);
  return res.json();
}
async function createGist(token){
  const body = { description:'Budget App Sync (encrypted)', public:false, files: { 'budget.enc': { content: JSON.stringify({note:'init'}) } } };
  const js = await gistRequest('POST','/gists', token, body);
  return js.id;
}
async function pullSync(gistId, token){
  const js = await gistRequest('GET', `/gists/${gistId}`, token);
  const file = js.files && (js.files['budget.enc'] || Object.values(js.files)[0]);
  if (!file || !file.content) throw new Error('No sync file found');
  return JSON.parse(file.content);
}
async function pushSync(gistId, token, content){
  const body={ files: { 'budget.enc': { content: JSON.stringify(content) } } };
  await gistRequest('PATCH', `/gists/${gistId}`, token, body);
}
function initSync(){
  dom.syncId.value = state.sync.gistId||'';
  dom.syncToken.value = state.sync.token||'';
  dom.syncPass.value = '';
  dom.btnSyncNow.disabled = !(state.sync.gistId && state.sync.token);

  byId('btnCreateGist').addEventListener('click', async ()=>{
    try{
      const token = dom.syncToken.value.trim();
      if (!token){ alert('Enter your GitHub token with gist scope.'); return;}
      const id = await createGist(token);
      dom.syncId.value = id; toast('Created sync');
    }catch(e){ alert('Create failed: '+e.message); }
  });
  byId('btnConnect').addEventListener('click', ()=>{
    const id=dom.syncId.value.trim(), token=dom.syncToken.value.trim(), pass=dom.syncPass.value.trim();
    if (!id || !token || !pass){ alert('Enter Sync ID, Token, and Passphrase.'); return; }
    if (!state.sync.keySalt) state.sync.keySalt = Array.from(crypto.getRandomValues(new Uint8Array(16))).map(b=>b.toString(16).padStart(2,'0')).join('');
    state.sync.gistId = id; state.sync.token = token; state.sync.passHint = `len:${pass.length}`; saveState();
    dom.btnSyncNow.disabled=false; toast('Connected to sync');
  });
  byId('btnSignOut').addEventListener('click', ()=>{
    state.sync = { provider:null, gistId:null, token:null, keySalt:null, passHint:null, lastRev:0 };
    saveState(); dom.syncId.value=''; dom.syncToken.value=''; dom.syncPass.value=''; dom.btnSyncNow.disabled=true; toast('Signed out of sync');
  });
  byId('btnSyncNow').addEventListener('click', async ()=>{
    const id=state.sync.gistId, token=state.sync.token, pass=dom.syncPass.value.trim();
    if (!id || !token || !pass){ alert('Enter Sync ID/Token and Passphrase.'); return; }
    try{
      let remoteRaw; try{ remoteRaw = await pullSync(id, token); }catch(e){ remoteRaw=null; }
      let remote = null; if (remoteRaw && remoteRaw.ct){ remote = await decryptJSON(remoteRaw, pass); } else if (remoteRaw && remoteRaw.note==='init'){ remote = null; }
      let merged = JSON.parse(JSON.stringify(state));
      if (remote){
        function upsert(local, incoming, key='id'){
          const map=new Map(local.map(i=>[i[key], i]));
          for (const r of (incoming||[])){
            const l=map.get(r[key]); const tL=new Date(l?.updatedAt||0).getTime(); const tR=new Date(r.updatedAt||0).getTime();
            if (!l || tR>tL) map.set(r[key], r);
          }
          return Array.from(map.values());
        }
        merged.incomes = upsert(merged.incomes||[], remote.incomes||[]);
        merged.expenses = upsert(merged.expenses||[], remote.expenses||[]);
        merged.templates = upsert(merged.templates||[], remote.templates||[]);
        const tL=new Date((state.syncUpdatedAt||state.versionDate||0)).getTime();
        const tR=new Date((remote.syncUpdatedAt||remote.versionDate||0)).getTime();
        if (tR>tL) merged.settings = remote.settings||merged.settings;
      }
      merged.version='1.3.1'; merged.syncUpdatedAt=nowIso();
      const payload = await encryptJSON(merged, pass, state.sync.keySalt||null);
      await pushSync(id, token, payload);
      state = merged; saveState();
      renderHome(); renderTransactions(); renderCalendar(); renderTemplates();
      toast('Synced');
    }catch(e){ alert('Sync failed: '+e.message); }
  });
}

/* ====== Helpers & Init ====== */
function clearIncomeForm(){ dom.incomeDate.value=todayStr(); dom.incomeSource.value=''; dom.incomeAmount.value=''; dom.incomeScheduled.checked=false; dom.incomeAmountErr.style.display='none'; dom.incomeSubmitBtn.textContent='Add Income'; }
function clearExpenseForm(){ dom.expenseDate.value=todayStr(); dom.expenseCategory.value='Housing'; dom.expenseCategoryCustom.value=''; dom.expenseAmount.value=''; dom.expenseNotes.value=''; dom.expenseScheduled.checked=false; dom.expenseAmountErr.style.display='none'; dom.expenseSubmitBtn.textContent='Add Expense'; }

function init(){
  dom.incomeDate.value = todayStr(); dom.expenseDate.value = todayStr();
  dom.appbarNav.style.display=''; // visible on home initially
  dom.payFreq.value = state.settings.payFreq||'biweekly';
  dom.seedPayday.value = toISO(state.settings.seedPayday||todayStr());

  initTabs(); initHome(); initTransactions(); initCalendar(); initTemplates(); initTools(); initSync();
  renderHome(); renderTransactions();
}
init();
</script>
</body>
</html>
